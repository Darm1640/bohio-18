<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- ============================================
             VISTA FORM MEJORADA DE CONTRATO
             ============================================ -->
        <record id="view_property_contract_form_improved" model="ir.ui.view">
            <field name="name">property.contract.form.improved</field>
            <field name="model">property.contract</field>
            <field name="priority">1</field>
            <field name="arch" type="xml">
                <form string="Contrato de Arrendamiento">
                    <header>
                        <!-- BOTONES DE ACCIÓN -->
                        <button name="prepare_lines"
                                type="object"
                                string="📋 Generar Cuotas"
                                class="btn-primary oe_highlight"
                                invisible="state not in ('draft')"/>

                        <button name="action_confirm"
                                type="object"
                                string="✅ Confirmar Contrato"
                                class="btn-success oe_highlight"
                                invisible="state not in ('draft')"/>

                        <button name="%(real_estate_bits.action_modify_contract_wizard)d"
                                type="action"
                                string="✏️ Modificar Contrato"
                                class="btn-info"
                                invisible="state not in ('confirmed', 'draft')"/>

                        <button name="compute_depreciation_board"
                                string="🔄 Recalcular Cuotas Futuras"
                                type="object"
                                class="btn-warning"
                                invisible="state != 'confirmed'"
                                confirm="¿Recalcular las cuotas futuras no pagadas?"/>

                        <field name="state" widget="statusbar"
                               options="{'clickable': '1'}"
                               statusbar_visible="draft,confirmed"/>
                    </header>

                    <sheet>
                        <!-- ============================================
                             SMART BUTTONS
                             ============================================ -->
                        <div class="oe_button_box" name="button_box">
                            <button name="view_entries"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-book">
                                <field name="entry_count" widget="statinfo" string="Facturas"/>
                            </button>

                            <button name="view_vouchers"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-money">
                                <field name="voucher_count" widget="statinfo" string="Pagos"/>
                            </button>

                            <button name="action_add_property_line"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-plus-square"
                                    invisible="not is_multi_property">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Agregar</span>
                                    <span class="o_stat_text">Propiedad</span>
                                </div>
                            </button>
                        </div>

                        <!-- ============================================
                             TÍTULO
                             ============================================ -->
                        <div class="oe_title">
                            <h1>
                                <field name="name"
                                       readonly="state != 'draft'"
                                       placeholder="Nuevo Contrato"/>
                            </h1>
                        </div>

                        <!-- ============================================
                             CARD: INQUILINO Y PROPIEDAD
                             ============================================ -->
                        <div class="o_group">
                            <div class="row">
                                <!-- COLUMNA 1: INQUILINO -->
                                <div class="col-lg-6">
                                    <div class="alert alert-primary">
                                        <h3 class="mb-3">
                                            <i class="fa fa-user-circle"/> INQUILINO
                                        </h3>

                                        <group>
                                            <field name="partner_id"
                                                   required="1"
                                                   readonly="state != 'draft'"
                                                   options="{'no_create': True}"
                                                   placeholder="Seleccionar inquilino..."
                                                   class="o_field_highlight"/>

                                            <field name="user_id"
                                                   string="👤 Asesor"
                                                   readonly="state != 'draft'"/>

                                            <field name="region_id"
                                                   string="📍 Región"
                                                   readonly="state != 'draft'"
                                                   options="{'no_create': True}"/>
                                        </group>
                                    </div>
                                </div>

                                <!-- COLUMNA 2: PROPIEDAD(ES) -->
                                <div class="col-lg-6">
                                    <div class="alert alert-success">
                                        <h3 class="mb-2">
                                            <i class="fa fa-building"/> PROPIEDAD(ES)
                                        </h3>

                                        <field name="is_multi_property"
                                               readonly="state != 'draft'"
                                               widget="boolean_toggle"
                                               string="🏘️ Multi-Propiedad"/>

                                        <!-- PROPIEDAD ÚNICA -->
                                        <div invisible="is_multi_property">
                                            <group>
                                                <field name="property_id"
                                                       string="🏠 Propiedad"
                                                       options="{'no_create': True, 'no_open': False}"
                                                       readonly="state != 'draft'"
                                                       required="not is_multi_property"
                                                       placeholder="Seleccionar propiedad..."
                                                       class="o_field_highlight"/>

                                                <field name="property_code"
                                                       string="🔢 Código"
                                                       readonly="1"/>

                                                <field name="property_area"
                                                       string="📐 Área"
                                                       readonly="1"/>

                                                <field name="address"
                                                       string="📍 Dirección"
                                                       readonly="1"/>

                                                <field name="partner_is_owner_id"
                                                       string="👤 Propietario"
                                                       readonly="1"/>
                                            </group>
                                        </div>

                                        <!-- MULTI-PROPIEDAD -->
                                        <div invisible="not is_multi_property">
                                            <div class="alert alert-info mt-2">
                                                <strong>
                                                    <field name="active_properties_count"/>
                                                    propiedades activas
                                                </strong>
                                                <span invisible="terminated_properties_count == 0">
                                                    (<field name="terminated_properties_count"/> terminadas)
                                                </span>
                                            </div>

                                            <button name="action_add_property_line"
                                                    type="object"
                                                    string="➕ Agregar Propiedad"
                                                    class="btn btn-sm btn-primary"
                                                    invisible="state != 'draft'"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             RESUMEN FINANCIERO
                             ============================================ -->
                        <div class="o_group mt-3">
                            <div class="row text-center">
                                <div class="col-lg-3">
                                    <div class="alert alert-info">
                                        <h5 class="mb-1">💰 Canon Mensual</h5>
                                        <h3 class="mb-0">
                                            <field name="rental_fee"
                                                   widget="monetary"
                                                   readonly="1"
                                                   nolabel="1"/>
                                        </h3>
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="alert alert-primary">
                                        <h5 class="mb-1">📊 Total Contrato</h5>
                                        <h3 class="mb-0">
                                            <field name="amount_total"
                                                   widget="monetary"
                                                   readonly="1"
                                                   nolabel="1"/>
                                        </h3>
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="alert alert-success">
                                        <h5 class="mb-1">✅ Pagado</h5>
                                        <h3 class="mb-0">
                                            <field name="paid"
                                                   widget="monetary"
                                                   readonly="1"
                                                   nolabel="1"/>
                                        </h3>
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="alert alert-warning">
                                        <h5 class="mb-1">⚖️ Saldo</h5>
                                        <h3 class="mb-0">
                                            <field name="balance"
                                                   widget="monetary"
                                                   readonly="1"
                                                   nolabel="1"/>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CAMPOS OCULTOS -->
                        <field name="company_id" invisible="1"/>
                        <field name="currency_id" invisible="1"/>
                        <field name="is_multi_propietario" invisible="1"/>
                        <field name="active_properties_count" invisible="1"/>
                        <field name="terminated_properties_count" invisible="1"/>

                        <!-- ============================================
                             NOTEBOOK
                             ============================================ -->
                        <notebook>
                            <!-- ========================================
                                 PESTAÑA 1: CONFIGURACIÓN
                                 ======================================== -->
                            <page string="⚙️ Configuración" name="config">
                                <group>
                                    <!-- FECHAS DEL CONTRATO -->
                                    <group string="📅 Fechas del Contrato">
                                        <field name="date_from"
                                               required="1"
                                               readonly="state != 'draft'"
                                               string="🟢 Fecha de Inicio"/>

                                        <field name="date_to"
                                               readonly="state != 'draft'"
                                               string="🔴 Fecha de Fin"/>

                                        <field name="date_end"
                                               readonly="1"
                                               string="⏹️ Terminación Real"/>

                                        <field name="next_payment_date"
                                               readonly="1"
                                               string="⏭️ Próximo Pago"/>

                                        <field name="last_payment_date"
                                               readonly="1"
                                               string="⏮️ Último Pago"/>
                                    </group>

                                    <!-- TIPO DE FACTURACIÓN -->
                                    <group string="🧾 Tipo de Facturación">
                                        <field name="billing_type"
                                               widget="radio"
                                               required="1"
                                               readonly="state != 'draft'"/>

                                        <field name="billing_type_description"
                                               readonly="1"
                                               class="text-info"
                                               nolabel="1"/>

                                        <field name="first_invoice_date"
                                               readonly="state != 'draft'"
                                               string="📆 Primera Factura"/>

                                        <field name="first_billing_date"
                                               readonly="1"
                                               string="📌 Fecha Calculada"/>
                                    </group>
                                </group>

                                <group>
                                    <!-- PERIODICIDAD -->
                                    <group string="📆 Periodicidad">
                                        <field name="periodicity"
                                               required="1"
                                               readonly="state != 'draft'"
                                               string="🔄 Cada"/>

                                        <label for="recurring_interval"/>
                                        <div class="o_row">
                                            <field name="recurring_interval"
                                                   required="1"
                                                   readonly="state != 'draft'"
                                                   nolabel="1"/>
                                            <span>meses</span>
                                        </div>

                                        <field name="billing_date"
                                               readonly="state != 'draft'"
                                               string="📅 Día de Facturación (1-31)"/>

                                        <field name="payment_terms_days"
                                               readonly="state != 'draft'"
                                               string="⏰ Días de Plazo"/>
                                    </group>

                                    <!-- VALORES FINANCIEROS -->
                                    <group string="💰 Valores">
                                        <field name="deposit"
                                               readonly="state != 'draft'"
                                               string="💎 Depósito"
                                               widget="monetary"/>

                                        <field name="insurance_fee"
                                               readonly="state != 'draft'"
                                               string="🛡️ Seguro"/>

                                        <field name="maintenance"
                                               readonly="state != 'draft'"
                                               string="🔧 Mantenimiento"
                                               widget="monetary"/>

                                        <field name="maintenance_type"
                                               readonly="state != 'draft'"
                                               invisible="not maintenance"
                                               string="Tipo"/>

                                        <field name="commission_percentage"
                                               readonly="state != 'draft'"
                                               string="💵 % Comisión"/>

                                        <field name="total_commission"
                                               readonly="1"
                                               string="💰 Comisión Total"
                                               widget="monetary"/>
                                    </group>
                                </group>

                                <!-- PRORRATEO -->
                                <group string="➗ Configuración de Prorrateo">
                                    <group>
                                        <field name="prorate_first_period"
                                               readonly="state != 'draft'"
                                               string="✅ Activar Prorrateo"/>

                                        <field name="prorata_computation_type"
                                               readonly="state != 'draft'"
                                               invisible="not prorate_first_period"
                                               string="🧮 Método de Cálculo"/>
                                    </group>

                                    <group invisible="not prorate_first_period">
                                        <field name="prorate_info_first"
                                               readonly="1"
                                               class="text-success font-weight-bold"
                                               string="📊 Primer Período"/>

                                        <field name="prorate_info_last"
                                               readonly="1"
                                               class="text-info font-weight-bold"
                                               string="📊 Último Período"/>
                                    </group>
                                </group>

                                <!-- INFORMACIÓN ADICIONAL -->
                                <group>
                                    <group string="📋 Información Adicional">
                                        <field name="project_id"
                                               readonly="state != 'draft'"
                                               string="🏗️ Proyecto"
                                               options="{'no_create': True}"/>

                                        <field name="contract_scenery_id"
                                               required="1"
                                               readonly="state != 'draft'"
                                               string="🎬 Escenario"
                                               options="{'no_create': True}"/>

                                        <field name="is_escenary_propiedad"
                                               readonly="state != 'draft'"
                                               string="🔄 Usar Escenario por Propiedad"/>

                                        <field name="rental_agreement"
                                               required="1"
                                               readonly="state != 'draft'"
                                               string="📄 Acuerdo"/>

                                        <field name="contract_use"
                                               readonly="state != 'draft'"
                                               string="🏠 Uso"/>
                                    </group>

                                    <group string="💼 Configuración Contable">
                                        <field name="account_income"
                                               string="💵 Cuenta Ingresos"/>

                                        <field name="account_security_deposit"
                                               string="💎 Cuenta Depósito"/>

                                        <field name="tax_status"
                                               readonly="state != 'draft'"
                                               string="🧾 Estado Impuesto"/>

                                        <field name="apply_tax"
                                               readonly="state != 'draft'"
                                               string="✅ Aplicar Impuesto"/>
                                    </group>
                                </group>

                                <!-- DESCRIPCIÓN -->
                                <group>
                                    <field name="descripcion"
                                           readonly="state != 'draft'"
                                           placeholder="Notas y observaciones del contrato..."
                                           nolabel="1"/>
                                </group>
                            </page>

                            <!-- ========================================
                                 PESTAÑA 2: CUOTAS DE PAGO
                                 ======================================== -->
                            <page string="💳 Cuotas de Pago" name="payment_lines">
                                <div class="alert alert-info" invisible="state != 'draft'">
                                    <strong>ℹ️ Instrucciones:</strong>
                                    <ul class="mb-0">
                                        <li>Configure las fechas y valores del contrato</li>
                                        <li>Click en "📋 Generar Cuotas" para crear las líneas de pago</li>
                                        <li>Revise que los valores sean correctos</li>
                                        <li>Click en "✅ Confirmar Contrato" para activar</li>
                                    </ul>
                                </div>

                                <field name="loan_line_ids" nolabel="1">
                                    <list create="0" delete="state == 'draft'" editable="bottom">
                                        <field name="serial" string="#" readonly="1"/>
                                        <field name="period_start" string="📅 Inicio Período" readonly="1"/>
                                        <field name="period_end" string="📅 Fin Período" readonly="1"/>
                                        <field name="date" string="🧾 Fecha Factura" readonly="1"/>
                                        <field name="due_date" string="⏰ Vencimiento" readonly="1"/>
                                        <field name="name" string="Descripción" readonly="1"/>
                                        <field name="amount" widget="monetary" string="💰 Monto" readonly="1" sum="Total"/>
                                        <field name="days_overdue" string="📅 Días Mora" optional="show" readonly="1"/>
                                        <field name="is_overdue" string="⚠️ Moroso" optional="show" readonly="1"/>
                                        <field name="payment_state" widget="badge" string="Estado"
                                               decoration-success="payment_state == 'paid'"
                                               decoration-warning="payment_state == 'partial'"
                                               decoration-danger="payment_state == 'not_paid'"
                                               readonly="1"/>
                                        <field name="invoice_id" optional="show" string="📄 Factura"/>

                                        <button name="create_invoice_line"
                                                type="object"
                                                string="Facturar"
                                                icon="fa-file-text-o"
                                                invisible="invoice_id"
                                                class="btn-sm btn-primary"/>

                                        <button name="view_invoice"
                                                type="object"
                                                string="Ver"
                                                icon="fa-eye"
                                                invisible="not invoice_id"
                                                class="btn-sm btn-info"/>
                                    </list>
                                </field>
                            </page>

                            <!-- ========================================
                                 PESTAÑA 3: PROPIEDADES (Multi)
                                 ======================================== -->
                            <page string="🏘️ Propiedades" name="property_lines"
                                  invisible="not is_multi_property">
                                <div class="alert alert-warning">
                                    <strong>⚠️ Contrato Multi-Propiedad</strong>
                                    <p class="mb-0">Este contrato incluye varias propiedades. El canon total se distribuye proporcionalmente.</p>
                                </div>

                                <field name="contract_line_ids" nolabel="1">
                                    <list editable="bottom" delete="state == 'draft'">
                                        <field name="sequence" widget="handle"/>
                                        <field name="property_id"
                                               domain="[('is_property', '=', True)]"
                                               options="{'no_create': True}"
                                               string="🏠 Propiedad"/>
                                        <field name="property_code" readonly="1" string="🔢 Código"/>
                                        <field name="project_id" readonly="1" optional="show" string="🏗️ Proyecto"/>
                                        <field name="date_from" required="1" string="📅 Desde"/>
                                        <field name="date_to" required="1" string="📅 Hasta"/>
                                        <field name="rental_fee" widget="monetary" required="1" string="💰 Canon"/>
                                        <field name="rental_fee_percentage" readonly="1" string="📊 % Total"/>
                                        <field name="state" widget="badge" string="Estado"
                                               decoration-info="state == 'draft'"
                                               decoration-success="state == 'active'"
                                               decoration-muted="state == 'terminated'"
                                               decoration-danger="state == 'cancelled'"/>

                                        <button name="action_terminate_line"
                                                type="object"
                                                icon="fa-stop-circle"
                                                string="Terminar"
                                                invisible="state != 'active'"
                                                class="btn-sm btn-danger"/>
                                    </list>
                                </field>
                            </page>

                            <!-- ========================================
                                 PESTAÑA 4: PROPIETARIOS
                                 ======================================== -->
                            <page string="👥 Propietarios" name="owners">
                                <group invisible="is_multi_property">
                                    <field name="partner_is_owner_id"
                                           readonly="1"
                                           string="👤 Propietario Principal"/>

                                    <field name="is_multi_propietario"
                                           readonly="1"
                                           string="👥 ¿Múltiples Propietarios?"/>
                                </group>

                                <field name="owners_lines"
                                       invisible="not is_multi_propietario or is_multi_property"
                                       nolabel="1">
                                    <list editable="bottom">
                                        <field name="partner_id" string="👤 Propietario"/>
                                        <field name="percentage" string="📊 % Propiedad"/>
                                        <field name="contract_scenery_id" string="🎬 Escenario"/>
                                    </list>
                                </field>

                                <div invisible="not is_multi_property" class="alert alert-info">
                                    <p class="mb-0">
                                        <strong>ℹ️ Nota:</strong> En contratos multi-propiedad,
                                        cada propiedad tiene su(s) propietario(s) definido(s)
                                        en la configuración de la propiedad.
                                    </p>
                                </div>
                            </page>

                            <!-- ========================================
                                 PESTAÑA 5: INCREMENTOS
                                 ======================================== -->
                            <page string="📈 Incrementos e Intereses" name="increments">
                                <group>
                                    <!-- INCREMENTOS -->
                                    <group string="📈 Incrementos Automáticos">
                                        <field name="increment_percentage"
                                               readonly="state != 'draft'"
                                               string="📊 % Incremento"/>

                                        <field name="increment_period"
                                               readonly="state != 'draft'"
                                               string="📆 Período"/>

                                        <field name="increment_recurring_interval"
                                               readonly="state != 'draft'"
                                               string="🔢 Cada"/>

                                        <div class="alert alert-info"
                                             invisible="not increment_percentage">
                                            <strong>💡 Ejemplo:</strong>
                                            <p class="mb-0">
                                                El canon aumentará un
                                                <field name="increment_percentage" readonly="1" nolabel="1"/>%
                                                cada
                                                <field name="increment_recurring_interval" readonly="1" nolabel="1"/>
                                                <field name="increment_period" readonly="1" nolabel="1" widget="selection"/>
                                            </p>
                                        </div>
                                    </group>

                                    <!-- INTERESES POR MORA -->
                                    <group string="⚠️ Intereses por Mora">
                                        <field name="apply_interest"
                                               readonly="state != 'draft'"
                                               string="✅ Aplicar Intereses"/>

                                        <field name="interest_rate"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"
                                               string="📊 Tasa Mensual (%)"/>

                                        <field name="interest_method"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"
                                               string="🧮 Método"/>

                                        <field name="interest_days_grace"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"
                                               string="⏰ Días de Gracia"/>

                                        <div class="alert alert-warning"
                                             invisible="not apply_interest">
                                            <strong>ℹ️ Cálculo de Intereses:</strong>
                                            <p class="mb-0">
                                                Los intereses se calcularán después de
                                                <field name="interest_days_grace" readonly="1" nolabel="1"/>
                                                días de vencimiento, aplicando
                                                <field name="interest_rate" readonly="1" nolabel="1"/>%
                                                mensual con método
                                                <field name="interest_method" readonly="1" nolabel="1" widget="selection"/>
                                            </p>
                                        </div>
                                    </group>
                                </group>
                            </page>

                            <!-- ========================================
                                 PESTAÑA 6: NOTAS DE DÉBITO
                                 ======================================== -->
                            <page string="📄 Notas de Débito" name="debit_notes">
                                <div class="alert alert-info">
                                    <strong>ℹ️ Notas de Débito Programadas</strong>
                                    <p class="mb-0">
                                        Configure notas de débito automáticas que se aplicarán
                                        después de un número específico de días de mora.
                                    </p>
                                </div>

                                <field name="debit_line_ids" nolabel="1">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name" string="📋 Descripción"/>
                                        <field name="value_amount" string="📊 % a Aplicar"/>
                                        <field name="nb_days" string="⏰ Días después"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>

                    <!-- CHATTER -->
                    <chatter/>
                </form>
            </field>
        </record>

    </data>
</odoo>
