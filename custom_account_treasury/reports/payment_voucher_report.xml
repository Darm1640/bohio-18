<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template Principal de Comprobante de Pago -->
    <template id="report_payment_voucher">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <div class="header" style="font-family: Arial, sans-serif;">
                    <div class="row">
                        <div class="col-8">
                            <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 60px;" alt="Logo"/>
                        </div>
                        <div class="col-4 text-right">
                            <p class="mb-0" style="font-size: 10px;">
                                Página <span class="page"/> de <span class="topage"/>
                            </p>
                        </div>
                    </div>
                    <hr style="margin-top: 10px; margin-bottom: 0px; border-color: #000;"/>
                </div>
                <div class="article" style="font-family: Arial, sans-serif; margin-top: 10px;">
                    <!-- Encabezado del documento -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <table class="table table-borderless" style="width: 100%;">
                                <tr>
                                    <td style="width: 70%;" class="p-0">
                                        <h5 class="mb-1"><strong><span t-field="o.company_id.name"/></strong></h5>
                                        <small>
                                            NIT: <span t-field="o.company_id.partner_id.vat"/><br/>
                                            <span t-field="o.company_id.partner_id.street"/><br/>
                                            Tel: <span t-field="o.company_id.partner_id.phone"/><br/>
                                            <span t-field="o.company_id.partner_id.email"/>
                                        </small>
                                    </td>
                                    <td style="width: 30%; vertical-align: top;" class="text-center p-2 border border-dark">
                                        <h4 class="mb-2">
                                            <t t-if="o.payment_type == 'outbound'">
                                                COMPROBANTE<br/>DE EGRESO
                                            </t>
                                            <t t-elif="o.payment_type == 'inbound'">
                                                RECIBO<br/>DE CAJA
                                            </t>
                                            <t t-else="">
                                                COMPROBANTE<br/>DE PAGO
                                            </t>
                                        </h4>
                                        <h5 style="color: #d9534f;">
                                            No. <span t-field="o.treasury_receipt_number" t-if="o.treasury_receipt_number"/>
                                            <span t-field="o.name" t-else=""/>
                                        </h5>
                                        <t t-if="o.operation_number">
                                            <p style="font-size: 12px; margin: 0;">
                                                Operación: <span t-field="o.operation_number"/>
                                            </p>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Información Principal -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <table class="table table-bordered table-sm">
                                <tr>
                                    <th class="table-light" style="width: 20%; background-color: #f0f0f0;">FECHA:</th>
                                    <td style="width: 30%;"><span t-field="o.date" t-options="{'format': 'dd/MM/yyyy'}"/></td>
                                    <th class="table-light" style="width: 20%; background-color: #f0f0f0;">ESTADO:</th>
                                    <td style="width: 30%;">
                                        <t t-if="o.state == 'draft'">
                                            <span class="badge badge-secondary">Borrador</span>
                                        </t>
                                        <t t-elif="o.state == 'posted'">
                                            <span class="badge badge-success">Confirmado</span>
                                        </t>
                                        <t t-elif="o.state == 'cancel'">
                                            <span class="badge badge-danger">Cancelado</span>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="table-light" style="background-color: #f0f0f0;">BENEFICIARIO:</th>
                                    <td colspan="3">
                                        <strong><span t-field="o.partner_id.name"/></strong>
                                        <t t-if="o.partner_id.vat">
                                            - <span t-field="o.partner_id.l10n_latam_identification_type_id.name" t-if="o.partner_id.l10n_latam_identification_type_id"/>
                                            <span t-field="o.partner_id.vat"/>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="table-light" style="background-color: #f0f0f0;">CONCEPTO:</th>
                                    <td colspan="3">
                                        <span t-field="o.memo" t-if="o.memo"/>
                                        <t t-else="">
                                            <t t-if="o.payment_type == 'outbound'">Pago a proveedor</t>
                                            <t t-else="">Cobro a cliente</t>
                                        </t>
                                    </td>
                                </tr>
                                <tr t-if="o.payment_reference">
                                    <th class="table-light" style="background-color: #f0f0f0;">REFERENCIA:</th>
                                    <td colspan="3"><span t-field="o.payment_reference"/></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Información de Pago -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <table class="table table-bordered table-sm">
                                <tr>
                                    <th class="table-light" style="width: 25%; background-color: #f0f0f0;">FORMA DE PAGO:</th>
                                    <td style="width: 25%;">
                                        <span t-field="o.payment_method_line_id.name"/>
                                    </td>
                                    <th class="table-light" style="width: 25%; background-color: #f0f0f0;">DIARIO:</th>
                                    <td style="width: 25%;"><span t-field="o.journal_id.name"/></td>
                                </tr>
                                <tr>
                                    <th class="table-light" style="background-color: #f0f0f0;">CUENTA BANCARIA:</th>
                                    <td>
                                        <span t-field="o.outstanding_account_id.code"/> -
                                        <span t-field="o.outstanding_account_id.name"/>
                                    </td>
                                    <th class="table-light" style="background-color: #f0f0f0;">MONEDA:</th>
                                    <td><span t-field="o.currency_id.name"/></td>
                                </tr>
                                <tr t-if="o.advance">
                                    <th class="table-light" style="background-color: #f0f0f0;">TIPO ANTICIPO:</th>
                                    <td><span t-field="o.advance_type_id.name" t-if="o.advance_type_id"/></td>
                                    <th class="table-light" style="background-color: #f0f0f0;">No. ANTICIPO:</th>
                                    <td><span t-field="o.code_advance" t-if="o.code_advance"/></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Detalle de Documentos Aplicados -->
                    <t t-if="o.payment_line_ids">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><strong>DOCUMENTOS APLICADOS</strong></h6>
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr style="background-color: #f0f0f0;">
                                            <th>Documento</th>
                                            <th>Fecha</th>
                                            <th>Cuenta</th>
                                            <th class="text-end">Valor Original</th>
                                            <th class="text-end">Valor Aplicado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-set="total_applied" t-value="0"/>
                                        <t t-foreach="o.payment_line_ids.filtered(lambda l: not l.is_main and l.display_type not in ['asset_cash', 'advance', 'counterpart'])" t-as="line">
                                            <tr>
                                                <td>
                                                    <t t-if="line.invoice_id">
                                                        <span t-field="line.invoice_id.name"/>
                                                    </t>
                                                    <t t-elif="line.move_line_id and line.move_line_id.move_id">
                                                        <span t-field="line.move_line_id.move_id.name"/>
                                                    </t>
                                                    <t t-else="">
                                                        <span t-field="line.name"/>
                                                    </t>
                                                </td>
                                                <td>
                                                    <t t-if="line.invoice_id">
                                                        <span t-field="line.invoice_id.invoice_date" t-options="{'format': 'dd/MM/yyyy'}"/>
                                                    </t>
                                                    <t t-elif="line.move_line_id and line.move_line_id.move_id">
                                                        <span t-field="line.move_line_id.move_id.date" t-options="{'format': 'dd/MM/yyyy'}"/>
                                                    </t>
                                                </td>
                                                <td>
                                                    <span t-field="line.account_id.code"/> -
                                                    <span t-field="line.account_id.name"/>
                                                </td>
                                                <td class="text-end">
                                                    <t t-if="line.invoice_id">
                                                        <span t-field="line.invoice_id.amount_total"
                                                              t-options='{"widget": "monetary", "display_currency": line.invoice_id.currency_id}'/>
                                                    </t>
                                                </td>
                                                <td class="text-end">
                                                    <span t-field="line.payment_amount"
                                                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                                    <t t-set="total_applied" t-value="total_applied + line.payment_amount"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light" style="background-color: #f0f0f0;">
                                            <td colspan="4" class="text-end"><strong>TOTAL APLICADO:</strong></td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_applied"
                                                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                                </strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Información Contable Detallada -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6><strong>INFORMACIÓN CONTABLE</strong></h6>
                            <table class="table table-bordered table-sm">
                                <tr t-if="o.move_id">
                                    <th class="table-light" style="width: 30%; background-color: #f0f0f0;">ASIENTO CONTABLE:</th>
                                    <td colspan="3">
                                        <span t-field="o.move_id.name"/>
                                        <t t-if="o.move_id.state == 'posted'">
                                            <span class="badge badge-success ml-2">Contabilizado</span>
                                        </t>
                                        <t t-else="">
                                            <span class="badge badge-warning ml-2">Borrador</span>
                                        </t>
                                    </td>
                                </tr>
                                <tr t-if="o.move_id">
                                    <th class="table-light" style="background-color: #f0f0f0;">FECHA ASIENTO:</th>
                                    <td style="width: 20%;"><span t-field="o.move_id.date" t-options="{'format': 'dd/MM/yyyy'}"/></td>
                                    <th class="table-light" style="width: 30%; background-color: #f0f0f0;">DIARIO:</th>
                                    <td style="width: 20%;"><span t-field="o.move_id.journal_id.name"/></td>
                                </tr>
                                <tr>
                                    <th class="table-light" style="background-color: #f0f0f0;">CUENTA DESTINO:</th>
                                    <td colspan="3">
                                        <span t-field="o.destination_account_id.code"/> -
                                        <span t-field="o.destination_account_id.name"/>
                                    </td>
                                </tr>
                                <tr t-if="o.analytic_account_id">
                                    <th class="table-light" style="background-color: #f0f0f0;">CUENTA ANALÍTICA:</th>
                                    <td colspan="3">
                                        <span t-field="o.analytic_account_id.code" t-if="o.analytic_account_id.code"/> -
                                        <span t-field="o.analytic_account_id.name"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Detalle del Asiento Contable -->
                    <t t-if="o.move_id and o.move_id.line_ids">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><strong>DETALLE DEL ASIENTO CONTABLE</strong></h6>
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr style="background-color: #f0f0f0;">
                                            <th style="width: 15%;">Cuenta</th>
                                            <th style="width: 30%;">Descripción</th>
                                            <th style="width: 20%;">Tercero</th>
                                            <th class="text-end" style="width: 15%;">Débito</th>
                                            <th class="text-end" style="width: 15%;">Crédito</th>
                                            <th class="text-center" style="width: 5%;">Análisis</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-set="total_debit" t-value="0"/>
                                        <t t-set="total_credit" t-value="0"/>
                                        <t t-foreach="o.move_id.line_ids.sorted(key=lambda l: (l.debit, l.account_id.code), reverse=True)" t-as="line">
                                            <tr>
                                                <td>
                                                    <span t-field="line.account_id.code"/>
                                                </td>
                                                <td>
                                                    <span t-field="line.account_id.name"/>
                                                    <t t-if="line.name and line.name != '/'">
                                                        <br/><small class="text-muted"><span t-field="line.name"/></small>
                                                    </t>
                                                </td>
                                                <td>
                                                    <span t-field="line.partner_id.name" t-if="line.partner_id"/>
                                                </td>
                                                <td class="text-end">
                                                    <span t-if="line.debit > 0" t-field="line.debit"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    <t t-set="total_debit" t-value="total_debit + line.debit"/>
                                                </td>
                                                <td class="text-end">
                                                    <span t-if="line.credit > 0" t-field="line.credit"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    <t t-set="total_credit" t-value="total_credit + line.credit"/>
                                                </td>
                                                <td class="text-center">
                                                    <t t-if="line.analytic_distribution">
                                                        <i class="fa fa-bar-chart" title="Con distribución analítica"/>
                                                    </t>
                                                </td>
                                            </tr>
                                            <!-- Mostrar distribución analítica si existe -->
                                            <t t-if="line.analytic_distribution">
                                                <tr>
                                                    <td colspan="6" style="padding-left: 30px; background-color: #f9f9f9;">
                                                        <small>
                                                            <strong>Distribución Analítica:</strong>
                                                            <t t-foreach="line.analytic_distribution.items()" t-as="dist">
                                                                <t t-set="analytic_account" t-value="request.env['account.analytic.account'].browse(int(dist[0]))"/>
                                                                <span t-esc="analytic_account.name"/>: <span t-esc="dist[1]"/>%
                                                                <t t-if="not dist_last">, </t>
                                                            </t>
                                                        </small>
                                                    </td>
                                                </tr>
                                            </t>
                                        </t>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light" style="background-color: #f0f0f0;">
                                            <td colspan="3" class="text-end"><strong>TOTALES:</strong></td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_debit"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                </strong>
                                            </td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_credit"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                </strong>
                                            </td>
                                            <td class="text-center">
                                                <t t-if="abs(total_debit - total_credit) &lt; 0.01">
                                                    <i class="fa fa-check-circle text-success" title="Asiento cuadrado"/>
                                                </t>
                                                <t t-else="">
                                                    <i class="fa fa-exclamation-triangle text-danger" title="Asiento descuadrado"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <t t-if="abs(total_debit - total_credit) >= 0.01">
                                            <tr>
                                                <td colspan="6" class="text-center text-danger">
                                                    <strong>⚠️ DIFERENCIA: <span t-esc="abs(total_debit - total_credit)"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/></strong>
                                                </td>
                                            </tr>
                                        </t>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Análisis Detallado de Impuestos y Retenciones -->
                        <t t-set="tax_lines" t-value="o.move_id.line_ids.filtered(lambda l: l.tax_line_id or l.tax_ids)"/>
                        <t t-if="tax_lines or o.invoice_line_ids">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6><strong>ANÁLISIS DE IMPUESTOS Y RETENCIONES</strong></h6>
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr style="background-color: #f0f0f0;">
                                                <th style="width: 8%;">Documento</th>
                                                <th style="width: 25%;">Concepto</th>
                                                <th style="width: 12%;">Tipo</th>
                                                <th class="text-end" style="width: 15%;">Base Gravable</th>
                                                <th class="text-center" style="width: 8%;">%</th>
                                                <th class="text-end" style="width: 15%;">Valor</th>
                                                <th style="width: 17%;">Cuenta</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Impuestos desde las líneas del asiento -->
                                            <t t-foreach="tax_lines" t-as="tax_line">
                                                <tr>
                                                    <td>
                                                        <small><span t-field="tax_line.move_id.name"/></small>
                                                    </td>
                                                    <td>
                                                        <t t-if="tax_line.tax_line_id">
                                                            <span t-field="tax_line.tax_line_id.name"/>
                                                        </t>
                                                        <t t-elif="tax_line.tax_ids">
                                                            <t t-foreach="tax_line.tax_ids" t-as="tax">
                                                                <span t-field="tax.name"/>
                                                                <t t-if="not tax_last">, </t>
                                                            </t>
                                                        </t>
                                                        <t t-else="">
                                                            <span t-field="tax_line.name"/>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <!-- Clasificación del tipo de impuesto -->
                                                        <t t-if="tax_line.tax_line_id">
                                                            <t t-if="'IVA' in tax_line.tax_line_id.name.upper() or 'VAT' in tax_line.tax_line_id.name.upper()">
                                                                <span class="badge badge-info">IVA</span>
                                                            </t>
                                                            <t t-elif="'RETEFUENTE' in tax_line.tax_line_id.name.upper() or 'RENTA' in tax_line.tax_line_id.name.upper()">
                                                                <span class="badge badge-warning">ReteFuente</span>
                                                            </t>
                                                            <t t-elif="'RETEICA' in tax_line.tax_line_id.name.upper() or 'ICA' in tax_line.tax_line_id.name.upper()">
                                                                <span class="badge badge-secondary">ReteICA</span>
                                                            </t>
                                                            <t t-elif="'RETEIVA' in tax_line.tax_line_id.name.upper()">
                                                                <span class="badge badge-primary">ReteIVA</span>
                                                            </t>
                                                            <t t-elif="'INC' in tax_line.tax_line_id.name.upper() or 'CONSUMO' in tax_line.tax_line_id.name.upper()">
                                                                <span class="badge badge-danger">INC</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-light">Otro</span>
                                                            </t>
                                                        </t>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-field="tax_line.tax_base_amount"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    </td>
                                                    <td class="text-center">
                                                        <t t-if="tax_line.tax_line_id">
                                                            <small><span t-field="tax_line.tax_line_id.amount"/>%</small>
                                                        </t>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-esc="tax_line.debit or tax_line.credit"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    </td>
                                                    <td>
                                                        <small>
                                                            <span t-field="tax_line.account_id.code"/> -
                                                            <span t-field="tax_line.account_id.name"/>
                                                        </small>
                                                    </td>
                                                </tr>
                                            </t>

                                            <!-- Impuestos desde las facturas aplicadas -->
                                            <t t-if="o.invoice_line_ids">
                                                <t t-foreach="o.invoice_line_ids" t-as="inv_line">
                                                    <t t-if="inv_line.invoice_id">
                                                        <t t-foreach="inv_line.invoice_id.amount_by_group" t-as="tax_group">
                                                            <tr style="background-color: #fafafa;">
                                                                <td>
                                                                    <small><span t-field="inv_line.invoice_id.name"/></small>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="tax_group[0]"/> (Factura)
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-success">Facturado</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span t-esc="tax_group[2]"
                                                                          t-options='{"widget": "monetary", "display_currency": inv_line.invoice_id.currency_id}'/>
                                                                </td>
                                                                <td class="text-center">
                                                                    <small><span t-esc="tax_group[3]"/>%</small>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span t-esc="tax_group[1]"
                                                                          t-options='{"widget": "monetary", "display_currency": inv_line.invoice_id.currency_id}'/>
                                                                </td>
                                                                <td>
                                                                    <small>Impuesto Facturado</small>
                                                                </td>
                                                            </tr>
                                                        </t>
                                                    </t>
                                                </t>
                                            </t>
                                        </tbody>

                                        <!-- Totales por tipo de impuesto -->
                                        <tfoot>
                                            <t t-set="total_iva" t-value="0"/>
                                            <t t-set="total_retefuente" t-value="0"/>
                                            <t t-set="total_reteica" t-value="0"/>
                                            <t t-set="total_otros" t-value="0"/>

                                            <!-- Calcular totales -->
                                            <t t-foreach="tax_lines" t-as="tl">
                                                <t t-if="tl.tax_line_id">
                                                    <t t-set="amount" t-value="tl.debit or tl.credit"/>
                                                    <t t-if="'IVA' in tl.tax_line_id.name.upper() or 'VAT' in tl.tax_line_id.name.upper()">
                                                        <t t-set="total_iva" t-value="total_iva + amount"/>
                                                    </t>
                                                    <t t-elif="'RETEFUENTE' in tl.tax_line_id.name.upper() or 'RENTA' in tl.tax_line_id.name.upper()">
                                                        <t t-set="total_retefuente" t-value="total_retefuente + amount"/>
                                                    </t>
                                                    <t t-elif="'RETEICA' in tl.tax_line_id.name.upper() or 'ICA' in tl.tax_line_id.name.upper()">
                                                        <t t-set="total_reteica" t-value="total_reteica + amount"/>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-set="total_otros" t-value="total_otros + amount"/>
                                                    </t>
                                                </t>
                                            </t>

                                            <!-- Mostrar resumen de totales -->
                                            <tr class="table-light" style="background-color: #f0f0f0;">
                                                <td colspan="5" class="text-end"><strong>RESUMEN DE IMPUESTOS:</strong></td>
                                                <td colspan="2">
                                                    <div class="row">
                                                        <t t-if="total_iva">
                                                            <div class="col-6">
                                                                <small>IVA:</small>
                                                            </div>
                                                            <div class="col-6 text-end">
                                                                <small>
                                                                    <span t-esc="total_iva"
                                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                                </small>
                                                            </div>
                                                        </t>
                                                        <t t-if="total_retefuente">
                                                            <div class="col-6">
                                                                <small>ReteFuente:</small>
                                                            </div>
                                                            <div class="col-6 text-end">
                                                                <small>
                                                                    <span t-esc="total_retefuente"
                                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                                </small>
                                                            </div>
                                                        </t>
                                                        <t t-if="total_reteica">
                                                            <div class="col-6">
                                                                <small>ReteICA:</small>
                                                            </div>
                                                            <div class="col-6 text-end">
                                                                <small>
                                                                    <span t-esc="total_reteica"
                                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                                </small>
                                                            </div>
                                                        </t>
                                                        <t t-if="total_otros">
                                                            <div class="col-6">
                                                                <small>Otros:</small>
                                                            </div>
                                                            <div class="col-6 text-end">
                                                                <small>
                                                                    <span t-esc="total_otros"
                                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                                </small>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </t>
                    </t>

                    <!-- Análisis de Partidas Entrantes y Salientes -->
                    <t t-if="o.move_id">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><strong>ANÁLISIS DE PARTIDAS Y SALDOS</strong></h6>
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr style="background-color: #f0f0f0;">
                                            <th rowspan="2" style="vertical-align: middle;">Cuenta</th>
                                            <th colspan="2" class="text-center">Movimientos</th>
                                            <th rowspan="2" class="text-center" style="vertical-align: middle;">Saldo</th>
                                            <th rowspan="2" class="text-center" style="vertical-align: middle;">Naturaleza</th>
                                        </tr>
                                        <tr style="background-color: #f0f0f0;">
                                            <th class="text-end">Entrada</th>
                                            <th class="text-end">Salida</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-set="total_entries" t-value="0"/>
                                        <t t-set="total_exits" t-value="0"/>
                                        <t t-set="accounts_summary" t-value="{}"/>

                                        <!-- Agrupar por cuenta -->
                                        <t t-foreach="o.move_id.line_ids" t-as="line">
                                            <t t-set="account_key" t-value="line.account_id.id"/>
                                            <t t-if="account_key not in accounts_summary">
                                                <t t-set="accounts_summary" t-value="dict(accounts_summary, **{account_key: {
                                                    'account': line.account_id,
                                                    'entry': 0.0,
                                                    'exit': 0.0,
                                                    'balance': 0.0
                                                }})"/>
                                            </t>
                                            <t t-set="entry_val" t-value="accounts_summary[account_key]['entry'] + line.debit"/>
                                            <t t-set="exit_val" t-value="accounts_summary[account_key]['exit'] + line.credit"/>
                                            <t t-set="accounts_summary" t-value="dict(accounts_summary, **{account_key: dict(accounts_summary[account_key], entry=entry_val, exit=exit_val, balance=entry_val - exit_val)})"/>
                                        </t>

                                        <!-- Mostrar resumen por cuenta -->
                                        <t t-foreach="accounts_summary.values()" t-as="acc">
                                            <tr>
                                                <td>
                                                    <span t-esc="acc['account'].code"/> -
                                                    <span t-esc="acc['account'].name"/>
                                                </td>
                                                <td class="text-end">
                                                    <t t-if="acc['entry'] > 0">
                                                        <span t-esc="acc['entry']"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    </t>
                                                    <t t-set="total_entries" t-value="total_entries + acc['entry']"/>
                                                </td>
                                                <td class="text-end">
                                                    <t t-if="acc['exit'] > 0">
                                                        <span t-esc="acc['exit']"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                    </t>
                                                    <t t-set="total_exits" t-value="total_exits + acc['exit']"/>
                                                </td>
                                                <td class="text-end">
                                                    <t t-if="acc['balance'] != 0">
                                                        <span t-esc="acc['balance']"
                                                              t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'
                                                              t-att-class="'text-success' if acc['balance'] > 0 else 'text-danger'"/>
                                                    </t>
                                                </td>
                                                <td class="text-center">
                                                    <t t-if="acc['account'].account_type in ['asset_cash', 'asset_receivable', 'asset_current', 'asset_non_current', 'asset_prepayments', 'asset_fixed']">
                                                        <span class="badge badge-info">Deudora</span>
                                                    </t>
                                                    <t t-elif="acc['account'].account_type in ['equity', 'equity_unaffected', 'liability_payable', 'liability_current', 'liability_non_current', 'liability_credit_card']">
                                                        <span class="badge badge-warning">Acreedora</span>
                                                    </t>
                                                    <t t-elif="acc['account'].account_type in ['income', 'income_other']">
                                                        <span class="badge badge-success">Ingreso</span>
                                                    </t>
                                                    <t t-elif="acc['account'].account_type in ['expense', 'expense_depreciation', 'expense_direct_cost']">
                                                        <span class="badge badge-danger">Gasto</span>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="badge badge-secondary">Mixta</span>
                                                    </t>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light" style="background-color: #f0f0f0;">
                                            <td class="text-end"><strong>TOTALES:</strong></td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_entries"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                </strong>
                                            </td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_exits"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                                </strong>
                                            </td>
                                            <td class="text-end">
                                                <strong>
                                                    <span t-esc="total_entries - total_exits"
                                                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'
                                                          t-att-class="'text-success' if (total_entries - total_exits) > 0 else 'text-danger' if (total_entries - total_exits) &lt; 0 else ''"/>
                                                </strong>
                                            </td>
                                            <td class="text-center">
                                                <t t-if="abs(total_entries - total_exits) &lt; 0.01">
                                                    <i class="fa fa-check-circle text-success"/>
                                                </t>
                                                <t t-else="">
                                                    <i class="fa fa-exclamation-triangle text-warning"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Análisis de Reconciliación si existe -->
                    <t t-if="o.move_id">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><strong>ESTADO DE RECONCILIACIÓN</strong></h6>
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr style="background-color: #f0f0f0;">
                                            <th>Cuenta</th>
                                            <th>Documento</th>
                                            <th class="text-center">Estado</th>
                                            <th class="text-end">Saldo Pendiente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="o.move_id.line_ids.filtered(lambda l: l.account_id.reconcile)" t-as="rec_line">
                                            <tr>
                                                <td>
                                                    <span t-field="rec_line.account_id.code"/> -
                                                    <span t-field="rec_line.account_id.name"/>
                                                </td>
                                                <td>
                                                    <span t-field="rec_line.move_id.name"/>
                                                </td>
                                                <td class="text-center">
                                                    <t t-if="rec_line.reconciled">
                                                        <span class="badge badge-success">Reconciliado</span>
                                                    </t>
                                                    <t t-elif="rec_line.amount_residual != 0">
                                                        <span class="badge badge-warning">Parcial</span>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="badge badge-danger">Pendiente</span>
                                                    </t>
                                                </td>
                                                <td class="text-end">
                                                    <span t-field="rec_line.amount_residual"
                                                          t-options='{"widget": "monetary", "display_currency": rec_line.currency_id or o.company_id.currency_id}'/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Monto Total con análisis de diferencia cambiaria si aplica -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <table class="table table-bordered">
                                <tr>
                                    <td class="text-center" style="background-color: #f8f9fa;">
                                        <h4 class="mb-2">VALOR TOTAL DEL PAGO</h4>
                                        <h2 style="color: #28a745;">
                                            <span t-field="o.currency_id.symbol"/>
                                            <span t-field="o.amount" t-options='{"widget": "monetary", "display_currency": False}'/>
                                        </h2>
                                        <p class="mb-0" style="font-style: italic;">
                                            <span t-esc="o.currency_id.amount_to_text(o.amount)"/>
                                        </p>

                                        <!-- Si hay diferencia cambiaria -->
                                        <t t-if="o.currency_id != o.company_id.currency_id">
                                            <hr style="margin: 10px 0;"/>
                                            <p class="mb-0">
                                                <strong>Equivalente en moneda local:</strong>
                                                <span t-esc="o.amount * (1 / o.manual_currency_rate if o.manual_currency_rate_active and o.manual_currency_rate else o.currency_id.rate)"
                                                      t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                                            </p>
                                            <t t-if="o.manual_currency_rate_active">
                                                <p class="mb-0">
                                                    <small class="text-muted">TRM Manual: <span t-field="o.current_exchange_rate"/></small>
                                                </p>
                                            </t>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <t t-if="o.narration">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6><strong>OBSERVACIONES</strong></h6>
                                <div style="border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa;">
                                    <span t-field="o.narration"/>
                                </div>
                            </div>
                        </div>
                    </t>

                    <!-- Anexos -->
                    <t t-if="o.attachment_ids or o.advance_request_id">
                        <div class="row mb-3">
                            <div class="col-12">
                                <p style="font-size: 10px;">
                                    <strong>Anexos:</strong><br/>
                                    <t t-if="o.advance_request_id">
                                        - Solicitud de Anticipo No. <span t-field="o.advance_request_id.name"/><br/>
                                        <t t-if="o.advance_request_id.sale_order_id">
                                            - Orden de Venta No. <span t-field="o.advance_request_id.sale_order_id.name"/><br/>
                                        </t>
                                        <t t-if="o.advance_request_id.purchase_order_id">
                                            - Orden de Compra No. <span t-field="o.advance_request_id.purchase_order_id.name"/><br/>
                                        </t>
                                    </t>
                                    <t t-if="o.attachment_ids">
                                        <t t-foreach="o.attachment_ids" t-as="att">
                                            - <span t-field="att.name"/><br/>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        - Documentación soporte del tercero<br/>
                                    </t>
                                </p>
                            </div>
                        </div>
                    </t>

                    <!-- Firmas -->
                    <div class="row mt-5">
                        <div class="col-4 text-center">
                            <div style="border-top: 2px solid #333; width: 90%; margin: 0 auto;">
                                <p class="mt-2 mb-0"><strong>Elaborado por</strong></p>
                                <small class="text-muted">
                                    <span t-field="o.create_uid.name"/><br/>
                                    <span t-field="o.create_date" t-options="{'format': 'dd/MM/yyyy HH:mm'}"/>
                                </small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div style="border-top: 2px solid #333; width: 90%; margin: 0 auto;">
                                <p class="mt-2 mb-0"><strong>Revisado por</strong></p>
                                <small class="text-muted">Contabilidad</small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div style="border-top: 2px solid #333; width: 90%; margin: 0 auto;">
                                <p class="mt-2 mb-0"><strong>Recibido por</strong></p>
                                <small class="text-muted">
                                    <t t-if="o.partner_id">
                                        <span t-field="o.partner_id.name"/>
                                    </t>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Pie de página -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <small class="text-muted">
                                Documento generado el <span t-esc="datetime.datetime.now().strftime('%d/%m/%Y %H:%M:%S')"/>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="footer" style="font-family: Arial, sans-serif; margin-top: 20px;">
                    <hr style="margin-top: 10px; margin-bottom: 5px; border-color: #000;"/>
                    <div class="row">
                        <div class="col-8">
                            <p style="font-size: 10px; margin: 0;">
                                <span t-field="o.company_id.name"/> -
                                <span t-field="o.company_id.partner_id.vat"/> -
                                <span t-field="o.company_id.partner_id.street"/> -
                                Tel: <span t-field="o.company_id.partner_id.phone"/>
                            </p>
                        </div>
                        <div class="col-4 text-right">
                            <p style="font-size: 10px; margin: 0;">
                                Página <span class="page"/> de <span class="topage"/>
                            </p>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>

    <!-- Definición del reporte -->
    <record id="action_report_payment_voucher" model="ir.actions.report">
        <field name="name">Comprobante de Pago</field>
        <field name="model">account.payment</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">custom_account_treasury.report_payment_voucher</field>
        <field name="report_file">payment_voucher</field>
        <field name="print_report_name">'Comprobante %s - %s' % (object.treasury_receipt_number or object.name, object.partner_id.name)</field>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>

    <!-- Botón en la vista de pago -->
    <record id="account_payment_view_form_inherit_voucher" model="ir.ui.view">
        <field name="name">account.payment.form.inherit.voucher</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="%(action_report_payment_voucher)d"
                        type="action"
                        string="Imprimir Comprobante"
                        class="btn-primary"
                        invisible="state == 'draft'"
                        icon="fa-print"/>
            </xpath>
        </field>
    </record>
</odoo>