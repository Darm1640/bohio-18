<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Account Move Form View -->
    <record id="view_move_form_inherit_treasury" model="ir.ui.view">
        <field name="name">account.move.form.inherit.treasury</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Add fields in partner section -->
            <field name="partner_id" position="after">
                <field name="enable_multi_partner" string="Multi-Tercero"
                       invisible="move_type not in ('out_invoice', 'out_refund', 'in_invoice', 'in_refund', 'out_receipt', 'in_receipt')"
                       help="Permite asignar diferentes terceros a las líneas de la factura (Solo disponible en facturas, notas de crédito y recibos)"/>
                <field name="force_partner_account" string="Forzar Cuenta"/>
                <field name="forced_account_id"
                       invisible="not force_partner_account"
                       required="force_partner_account"
                       domain="[('deprecated', '=', False), ('company_ids', '=', company_id)]"/>
                <field name="is_advance_entry" invisible="1"/>
            </field>

            <!-- Add advance payment info section -->
            <xpath expr="//page[@name='other_info']" position="after">
                <page string="Anticipos" name="advance_payments"
                      invisible="move_type not in ('out_invoice', 'in_invoice', 'out_refund', 'in_refund')">
                    <group>
                        <group>
                            <field name="has_advances" readonly="1" string="Tiene Anticipos Disponibles"/>
                        </group>
                    </group>
                    <p class="text-muted">
                        <i class="fa fa-info-circle"/> Los anticipos disponibles aparecen automáticamente en la sección inferior de "Créditos y Anticipos pendientes" o "Débitos y Anticipos pendientes".
                        Haga clic en cualquier anticipo de la lista para aplicarlo a esta factura.
                    </p>
                </page>
            </xpath>

            <!-- Mark advance entries in chatter -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-info" role="alert"
                     invisible="not is_advance_entry">
                    <i class="fa fa-info-circle"/> Este es un asiento de anticipo
                </div>
            </xpath>
        </field>
    </record>

    <!-- Inherit Account Move List View -->
    <record id="view_account_move_list_inherit_treasury" model="ir.ui.view">
        <field name="name">account.move.list.inherit.treasury</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <field name="checked" position="after">
                <field name="has_advances" widget="boolean_toggle" optional="hide" string="Tiene Anticipos"/>
                <field name="is_advance_entry" invisible="1"/>
            </field>
        </field>
    </record>


    <!-- Invoice Line Tree View - Show Partner -->
    <record id="view_invoice_line_tree_inherit_multi_partner" model="ir.ui.view">
        <field name="name">account.move.line.tree.inherit.multi.partner</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Agregar partner_id en las líneas de factura -->
            <xpath expr="//field[@name='invoice_line_ids']/list/field[@name='product_id']" position="after">
                <field name="partner_id"
                       string="Tercero"
                       optional="show"
                       invisible="not parent.enable_multi_partner"
                       context="{'manage_partner_in_invoice_lines': parent.enable_multi_partner}"
                       options="{'no_create': True}"/>
            </xpath>

            <!-- También agregar en las líneas del tab de asientos contables -->
            <xpath expr="//field[@name='line_ids']/list/field[@name='account_id']" position="after">
                <field name="partner_id"
                       string="Tercero"
                       optional="show"
                       invisible="not parent.enable_multi_partner"
                       context="{'manage_partner_in_invoice_lines': parent.enable_multi_partner}"
                       required="parent.enable_multi_partner"/>
            </xpath>
        </field>
    </record>


    <!-- Vista de asientos contables generales - mostrar checkbox multi-tercero -->
    <record id="view_move_form_inherit_multi_partner_entry" model="ir.ui.view">
        <field name="name">account.move.form.inherit.multi.partner.entry</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Agregar checkbox multi-tercero para asientos contables -->
            <xpath expr="//field[@name='date']" position="after">
                <field name="enable_multi_partner"
                       string="Multi-Tercero"
                       invisible="move_type != 'entry'"
                       help="Permite asignar diferentes terceros a las líneas del asiento contable"/>
            </xpath>
        </field>
    </record>
</odoo>