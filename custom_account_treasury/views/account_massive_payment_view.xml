<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_payment_detail_from" model="ir.ui.view">
            <field name="name">account.payment.detail.form</field>
            <field name="model">account.payment.detail</field>
            <field name="arch" type="xml">
                <form string="Detalle de Pago">
                    <header>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <group>
                            <group name="main_info" string="Información Principal">
                                <field name="name"/>
                                <field name="payment_id"/>
                                <field name="move_line_id"/>
                                <field name="invoice_id"/>
                                <field name="move_id"/>
                                <field name="partner_id"/>
                                <field name="partner_type"/>
                                <field name="account_id"/>
                                <field name="date"/>
                                <field name="journal_id"/>
                                <field name="ref"/>
                                <field name="number"/>
                                <field name="display_type"/>
                            </group>
                            <group name="amounts" string="Montos y Monedas">
                                <field name="company_currency_id"/>
                                <field name="currency_id"/>
                                <field name="payment_currency_id"/>
                                <field name="payment_amount"/>
                                <field name="amount_currency"/>
                                <field name="debit"/>
                                <field name="credit"/>
                                <field name="balance"/>
                                <field name="currency_rate"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Montos Residuales" name="residual_amounts">
                                <group>
                                    <group>
                                        <field name="amount_info" string=""  widget="payment_details"/>
                                        <field name="amount_residual"/>
                                        <field name="amount_residual_currency"/>
                                        <field name="payment_difference"/>
                                        <field name="exchange_diff_amount"/>
                                        <field name="exchange_diff_foreign"/>
                                        <field name="is_final_payment"/>
                                        <field name="payment_difference_handling"/>
                                        <field name="writeoff_account_id"/>
                                    </group>
                                    <group>
                                        <field name="date_maturity"/>
                                        <field name="needs_rate_update"/>
                                        <field name="amount_info"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Impuestos" name="taxes">
                                <group>
                                    <group>
                                        <field name="tax_ids" widget="many2many_tags"/>
                                        <field name="tax_tag_ids" widget="many2many_tags"/>
                                        <field name="tax_repartition_line_id"/>
                                        <field name="tax_base_amount"/>
                                    </group>
                                    <group>
                                        <field name="auto_tax_line"/>
                                        <field name="tax_line_id"/>
                                        <field name="tax_line_id2"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Otros Datos" name="other_info">
                                <group>
                                    <group>
                                        <field name="is_main"/>
                                        <field name="is_account_line"/>
                                        <field name="is_transfer"/>
                                        <field name="is_diff"/>
                                        <field name="is_counterpart"/>
                                        <field name="is_manual_currency"/>
                                    </group>
                                    <group>
                                        <field name="sequence"/>
                                        <field name="to_pay"/>
                                        <field name="exclude_from_payment_detail"/>
                                        <field name="other_payment_id"/>
                                        <field name="product_id"/>
                                        <field name="company_id" invisible="True"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_payment_detail_tree" model="ir.ui.view">
            <field name="name">account.payment.detail.list</field>
            <field name="model">account.payment.detail</field>
            <field name="arch" type="xml">
                <list>
                    <field name="type" />
                    <field name="company_id" invisible="1" />
                    <field name="account_id" domain="[('company_ids', 'in', company_id)]" />
                    <field name="partner_id" />
                    <field name="name" />
                    <field name="ref" invisible="1" />
                    <field name="number" />
                    <field name="currency_id" />
                    <field name="amount_currency" />
                    <field name="debit" />
                    <field name="credit" />
                    <field name="date" invisible="1" />
                    <field name="payment_id" invisible="1" />
                    <field name="journal_id" invisible="1" />
                    <field name="company_currency_id" invisible="1" />
                    <field name="invoice_id" invisible="1" />
                    <field name="move_id" invisible="1" />
                    <field name="is_account_line" invisible="1" />
                    <field name="is_transfer" invisible="1" />
                    <field name="is_manual_currency" invisible="1" />
                    <field name="is_diff" invisible="1" />
                    <field name="is_counterpart" invisible="1" />
                    <field name="exclude_from_payment_detail" invisible="1" />
                    <field name="balance" readonly="1" force_save="1" />
                    <field name="payment_currency_id" invisible="1" />
                    <field name="to_pay" />
                </list>
            </field>
        </record>




        <!-- pagos, cobros y tesoreria  -->
        <record id="view_account_move_reversal_payment" model="ir.ui.view">
            <field name="name">account.payment.form</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="account.view_account_payment_form" />
            <field name="arch" type="xml">
                <div name="button_box" position="inside">
                    <button name="open_reconcile_view" class="oe_stat_button" icon="fa-anchor" type="object" string="Conciliada">
                    </button>
                </div>
                <xpath expr="//button[@name='action_draft']" position="after">
                    <button name="action_propose_payment_distribution" class="btn btn-success" invisible="state != 'draft'" string="Proponer distribución de pagos" type="object" icon="fa-gears"/>
                    <button name="action_delete_counterpart_lines" class="btn btn-danger" invisible="state != 'draft'" string="Eliminar Lineas" type="object" icon="fa-minus"/>
                </xpath>
                <group name="main_group" position="inside">
                    <group name="advance_section" invisible="paired_internal_transfer_payment_id">
                    <label for="advance"/>
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center">
                            <field name="advance" readonly="state != 'draft'" class="me-2"/>
                            <span class="text-muted">¿Es un anticipo?</span>
                        </div>
                        
                        <div invisible="not advance" class="mt-2">
                            <label for="advance_type_id" class="me-2"/>
                            <div class="d-flex align-items-center">
                                <field name="advance_type_id" options="{'no_create': 1, 'no_edit': 1}" readonly="state != 'draft'" required="advance" class="w-100"/>
                                <i class="fa fa-cog ms-2" title="Tipo de anticipo"/>
                            </div>
                            
                            <label for="code_advance" class="mt-2"/>
                            <div class="d-flex align-items-center">
                                <field name="code_advance" readonly="state != 'draft'" class="w-100" placeholder="Código de anticipo"/>
                                <i class="fa fa-barcode ms-2" title="Código de anticipo"/>
                            </div>

                            <div class="alert alert-info mt-2 mb-0 p-2" role="alert" invisible="not advance_type_id">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-info-circle me-2"/>
                                    <small>
                                        <span invisible="payment_type != 'outbound'">
                                            Anticipo a proveedor
                                        </span>
                                        <span invisible="payment_type != 'inbound'">
                                            Anticipo de cliente
                                        </span>
                                        <strong class="ms-1">
                                            <field name="advance_type_id" readonly="1" nolabel="1"/>
                                        </strong>
                                    </small>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-2 mb-0 p-2" role="alert" invisible="advance_type_id">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-exclamation-triangle me-2"/>
                                    <small>Seleccione un tipo de anticipo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </group>
                <group name="payment_difference_section" invisible="paired_internal_transfer_payment_id">
                    <label for="payment_difference_line"/>
                    <div class="d-flex flex-column w-100">
                        <field name="payment_difference_line" invisible="1" force_save="1"/>
                        
                        <div class="d-flex align-items-center">
                            <field name="amount_signed" readonly="1" force_save="1" class="fw-bold"/>
                            <span class="mx-2">→</span>
                            <field name="amount" readonly="1" force_save="1" class="fw-bold"/>
                        </div>

                        <div class="alert alert-success mt-2 mb-0 p-2" role="alert" invisible="payment_difference_line &lt;= 0">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-plus-circle me-2"/>
                                <div>
                                    <strong>Diferencia a favor: </strong>
                                    <field name="payment_difference_line" readonly="1" force_save="1" class="oe_inline text-success"/>
                                    <field name="currency_id" readonly="1" force_save="1" class="oe_inline"/>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-2 mb-0 p-2" role="alert" invisible="payment_difference_line &gt;= 0">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-minus-circle me-2"/>
                                <div>
                                    <strong>Diferencia a pagar: </strong>
                                    <field name="payment_difference_line" readonly="1" force_save="1" class="oe_inline text-warning"/>
                                    <field name="currency_id" readonly="1" force_save="1" class="oe_inline"/>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-2 mb-0 p-2" role="alert" invisible="payment_difference_line != 0">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-check-circle me-2"/>
                                <span>Los montos coinciden exactamente</span>
                            </div>
                        </div>
                    </div>
                </group>
                <group name="currency_config" invisible="currency_id == company_currency_id">
                    <label for="currency_id"/>
                    <div>
                        <field name="currency_id" options="{'no_create': True}" class="oe_inline"/>
                        <span class="fst-italic ms-2">Moneda diferente a la compañía</span>
                    </div>
                
                    <label for="manual_currency_rate_active"/>
                    <div>
                        <field name="manual_currency_rate_active" class="oe_inline"/>
                        <span class="ms-2">¿Usar tipo de cambio manual?</span>
                    </div>
                
                    <label for="current_exchange_rate"/>
                    <div>
                        <field name="current_exchange_rate" class="oe_inline" required="manual_currency_rate_active" force_save="1" readonly="not manual_currency_rate_active"/>
                        <span class="ms-2 text-muted">
                            1 <field name="currency_id" readonly="1" class="oe_inline"/> = 
                            <field name="current_exchange_rate" readonly="1" class="oe_inline"/> 
                            <field name="company_currency_id" readonly="1" class="oe_inline"/>
                        </span>
                        <div class="text-muted mt-1" invisible="manual_currency_rate_active">
                            <small><i class="fa fa-info-circle"/> Usando tipo de cambio del sistema</small>
                        </div>
                        <div class="text-warning mt-1" invisible="not manual_currency_rate_active">
                            <small><i class="fa fa-exclamation-triangle"/> Usando tipo de cambio manual</small>
                        </div>
                    </div>
                </group>
                 </group>
                <field name="payment_type" position="after">
                    <field name="change_destination_account" invisible="1"/>
                    <field name="outstanding_account_id" readonly="state != 'draft'"/>
                    <field name="destination_account_id" readonly="state != 'draft'"/>
                </field>

                <xpath expr="//sheet" position="inside">
                    <group name="payment_selection" invisible="state != 'draft'">
                        <field name="domain_move_lines" invisible="1"/>
                        <label for="account_move_payment_ids"/>
                        <div class="d-flex flex-column w-100">
                            <div class="d-flex align-items-center">
                                <field name="account_move_payment_ids" domain="[('amount_residual','!=', 0),('account_type', 'in',['asset_receivable','liability_payable']),('parent_state', '=', 'posted'),('id','not in',domain_move_lines)]" context="{'tree_view_ref':'custom_account_treasury.view_move_line_tree_payment','search_default_partner_id' : partner_id, 'search_default_group_by_account': 1, 'name_groupby':1,'expand': 1}" widget="many2many_tags" options="{'no_create': True, 'no_edit': True}" class="w-100"/>
                                <i class="fa fa-search ms-2" title="Buscar documentos"/>
                            </div>
                            <small class="text-muted mt-1">
                                <i class="fa fa-info-circle"/> Seleccione los documentos pendientes
                            </small>
                        </div>

                        <label for="supplier_invoice_ids" invisible="payment_type != 'outbound'"/>
                        <div class="d-flex flex-column w-100" invisible="payment_type != 'outbound'">
                            <div class="d-flex align-items-center">
                                <field name="supplier_invoice_ids" widget="many2many_tags" options="{'no_create': True}" domain="[('amount_residual','!=', 0),('move_type','=','in_invoice'),('state', 'in', ('posted', )),('id','not in',domain_move_lines)]" context="{'search_default_partner_id' : partner_id}" class="w-100" placeholder="Seleccione facturas por pagar"/>
                                <i class="fa fa-file-text-o ms-2" title="Facturas de proveedor"/>
                            </div>
                            <small class="text-muted mt-1" invisible="not supplier_invoice_ids">
                                <i class="fa fa-check-circle"/> Facturas de proveedor seleccionadas
                            </small>
                        </div>

                        <label for="customer_invoice_ids" invisible="payment_type != 'inbound'"/>
                        <div class="d-flex flex-column w-100" invisible="payment_type != 'inbound'">
                            <div class="d-flex align-items-center">
                                <field name="customer_invoice_ids" widget="many2many_tags" options="{'no_create': True}" domain="[('amount_residual','!=', 0),('move_type','=','out_invoice'),('state', 'in', ('posted',)),('id','not in',domain_move_lines)]" context="{'search_default_partner_id' : partner_id}" class="w-100" placeholder="Seleccione facturas por cobrar"/>
                                <i class="fa fa-file-o ms-2" title="Facturas de cliente"/>
                            </div>
                            <small class="text-muted mt-1" invisible="not customer_invoice_ids">
                                <i class="fa fa-check-circle"/> Facturas de cliente seleccionadas
                            </small>
                        </div>

                        <div class="alert alert-info mt-3 mb-0" role="alert" invisible="not account_move_payment_ids and not supplier_invoice_ids and not customer_invoice_ids">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-info-circle me-2"/>
                                <span invisible="payment_type != 'outbound'">
                                    Documentos seleccionados para pago
                                </span>
                                <span invisible="payment_type != 'inbound'">
                                    Documentos seleccionados para cobro
                                </span>
                            </div>
                        </div>
                    </group>
                    <notebook>
                        <page name="moves" string="Movimientos">
                            <field name="payment_line_ids" context="{'default_partner_id': partner_id}" widget="one2many_list" readonly="state != 'draft'">
                                <list editable="bottom" decoration-success="display_type == 'asset_cash'" decoration-info="display_type == 'invoice'" decoration-danger="display_type == 'bill'" decoration-warning="display_type == 'reverse'" decoration-primary="display_type == 'entry'">
                                    <field name="display_type" column_invisible="True"/>
                                    <field name="type" column_invisible="True"/>
                                    <field name="partner_type" column_invisible="True"/>
                                    <field name="partner_id"/>
                                    <field name="move_line_id" readonly="False" force_save="True" options="{'no_create':True, 'no_open':True, 'always_reload': True}" context="{'show_number': True}" domain="['|',('amount_residual','!=', 0),('amount_residual_currency','!=', 0), ('partner_id','=', partner_id), ('account_id.reconcile','=',True)]"/>
                                    <field name="account_id"/>
                                    <field name="name"/>
                                    <field name="amount_info" string="" widget="payment_details"/>
                                    <button name="action_view_move_line" type="object" class="oe_inline oe_link" icon="fa-arrow-right"/>
                                    <field name="ref" column_invisible="True"/>
                                    <field name="invoice_id" column_invisible="True" domain="['|', ('move_type','=','out_invoice'),('move_type','=','in_invoice')]"/>
                                    <field name="number" column_invisible="True"/>
                                    <field name="payment_id" column_invisible="True"/>
                                    <field name="amount_residual" optional="hide"/>
                                    <field name="company_currency_id" column_invisible="True"/>
                                    <field name="amount_residual_currency" column_invisible="True"/>
                                    <field name="currency_id" optional="hide"/>
                                    <field name="amount_currency" optional="hide"/>
                                    <field name="date_maturity" column_invisible="True"/>
                                    <field name="payment_currency_id" column_invisible="True"/>
                                    <field name="company_id" column_invisible="True"/>
                                    <field name="journal_id" column_invisible="True"/>
                                    <field name="tax_ids" widget="many2many_tags" optional="hide" options="{'no_create' : 1}"/>
                                    <field name="analytic_distribution" widget="analytic_distribution" groups="analytic.group_analytic_accounting" optional="hide" options="{'account_field': 'account_id'}"/>
                                    <field name="debit" sum="Total Debe" readonly="0"/>
                                    <field name="credit" sum="Total Haber" readonly="0"/>
                                    <field name="is_main" column_invisible="True"/>
                                    <field name="balance" readonly="1" force_save="1" sum="Total balance" column_invisible="True"/>
                                    <field name="payment_amount"/>
                                    <field name="date" column_invisible="True"/>
                                    <field name="is_account_line" column_invisible="True"/>
                                    <field name="is_transfer" column_invisible="True"/>
                                    <field name="is_manual_currency" column_invisible="True"/>
                                    <field name="is_diff" column_invisible="True"/>
                                    <field name="is_counterpart" column_invisible="True"/>
                                    <field name="exclude_from_payment_detail" column_invisible="True"/>
                                    <field name="move_id" column_invisible="True"/>
                                    <field name="to_pay"/>
                                    <field name="payment_difference" column_invisible="True"/>
                                    <field name="payment_difference_handling" column_invisible="True"/>
                                    <field name="writeoff_account_id" column_invisible="True"/>
                                    <field name="auto_tax_line" column_invisible="True"/>
                                    <field name="tax_tag_ids" widget="many2many_tags" column_invisible="True"/>
                                    <field name="tax_repartition_line_id" column_invisible="True"/>
                                    <field name="tax_line_id" column_invisible="True"/>
                                    <field name="tax_line_id2" column_invisible="True"/>
                                    <field name="tax_base_amount" column_invisible="True"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </xpath>
            </field>
        </record>

        <record id="view_account_payment_tree" model="ir.ui.view">
            <field name="name">account.payment.list</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="account.view_account_payment_tree" />
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="code_advance" />
                </field>
            </field>
        </record>

        <record id="view_account_supplier_payment_tree" model="ir.ui.view">
            <field name="name">account.supplier.payment.list</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="account.view_account_supplier_payment_tree" />
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="code_advance" />
                </field>
            </field>
        </record>
        
        <record id="view_account_invoice_advance_payment_form" model="ir.ui.view">
            <field name="name">view.account.invoice.advance.payment.form</field>
            <field name="model">account.move</field>
            <field name="inherit_id" ref="account.view_move_form"/>
            <field name="arch" type="xml">
                <button name="action_register_payment" position="after">
                    <field name="has_advance_payment" invisible="1"/>
                    <button name="apply_advance_payment" type="object" class="oe_highlight"
                        invisible="state != 'posted' or has_advance_payment == False or amount_residual == 0.0"
                        string="Aplicar Anticipo" groups="account.group_account_invoice"/>
                </button>
                <notebook position="inside">
                    <page name="advance_payment" string="Anticipos" invisible="advance_payment_count == 0">
                        <field name="advance_payment_count" invisible="1"/>
                        <field name="advance_payment_ids"/>
                    </page>
                </notebook>
            </field>
        </record>

    </data>
</odoo>
