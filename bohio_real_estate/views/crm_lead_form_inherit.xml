<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Herencia del formulario de CRM Lead -->
    <record id="view_crm_lead_form_inherit_bohio" model="ir.ui.view">
        <field name="name">crm.lead.form.inherit.bohio</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_lead_view_form"/>
        <field name="arch" type="xml">
            <!-- Agregar pestaña de Propiedades después de la información interna -->
            <xpath expr="//notebook" position="inside">
                <page string="Propiedades Inmobiliarias" name="real_estate_properties">
                    <group>
                        <group string="Información de Solicitud">
                            <field name="request_source"/>
                            <field name="client_type"/>
                            <field name="service_interested"/>
                        </group>
                        <group string="Preferencias del Cliente">
                            <field name="budget_min" widget="monetary"/>
                            <field name="budget_max" widget="monetary"/>
                            <field name="desired_location"/>
                            <field name="num_bedrooms_desired"/>
                            <field name="num_bathrooms_desired"/>
                        </group>
                    </group>

                    <separator string="Propiedades de Interés"/>
                    <field name="property_ids" widget="many2many">
                        <list string="Propiedades">
                            <field name="default_code" string="Código"/>
                            <field name="name" string="Propiedad"/>
                            <field name="property_type_id" string="Tipo" optional="show"/>
                            <field name="type_service" string="Transacción" optional="show"/>
                            <field name="list_price" string="Precio" widget="monetary"/>
                            <field name="city_id" string="Ciudad" optional="hide"/>
                            <field name="neighborhood" string="Barrio" optional="show"/>
                            <field name="num_bedrooms" string="Habitaciones" optional="show"/>
                            <field name="num_bathrooms" string="Baños" optional="show"/>
                            <field name="property_area" string="Área m²" optional="show"/>
                        </list>
                    </field>

                    <group string="PQRS" invisible="request_source != 'pqrs'">
                        <group>
                            <field name="pqrs_type" required="request_source == 'pqrs'"/>
                            <field name="pqrs_status"/>
                        </group>
                        <group>
                            <field name="response_deadline" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- Agregar botón para ver propiedades en la barra superior -->
            <xpath expr="//header" position="inside">
                <button name="action_view_properties"
                        type="object"
                        string="Ver Propiedades"
                        class="oe_stat_button"
                        icon="fa-building"
                        invisible="not property_ids"/>
            </xpath>

            <!-- Agregar smart button para propiedades -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_properties"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-building-o"
                        invisible="not property_ids">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="property_count"/>
                        </span>
                        <span class="o_stat_text">Propiedades</span>
                    </div>
                </button>
            </xpath>
        </field>
    </record>

    <!-- Vista kanban personalizada para propiedades en CRM -->
    <record id="view_product_template_kanban_crm" model="ir.ui.view">
        <field name="name">product.template.kanban.crm</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="id"/>
                <field name="name"/>
                <field name="default_code"/>
                <field name="image_1920"/>
                <field name="list_price"/>
                <field name="property_type_id"/>
                <field name="type_service"/>
                <field name="city_id"/>
                <field name="neighborhood"/>
                <field name="num_bedrooms"/>
                <field name="num_bathrooms"/>
                <field name="property_area"/>
                <templates>
                    <t t-name="card">
                        <main>
                            <div class="o_kanban_image">
                                <field name="image_1920" widget="image" class="oe_avatar oe_kanban_avatar_smallbox"/>
                            </div>
                            <div class="oe_kanban_details">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                                <div class="text-muted">
                                    <field name="default_code"/>
                                </div>
                                <div>
                                    <span class="badge rounded-pill text-bg-success">
                                        $<t t-esc="Math.round(record.list_price.value).toLocaleString()"/>
                                    </span>
                                </div>
                                <div class="text-muted">
                                    <i class="fa fa-map-marker"/> <field name="neighborhood"/>
                                </div>
                                <div>
                                    <span class="text-muted">
                                        <i class="fa fa-bed"/> <field name="num_bedrooms"/>
                                        <i class="fa fa-bath ms-2"/> <field name="num_bathrooms"/>
                                        <i class="fa fa-expand ms-2"/> <field name="property_area"/> m²
                                    </span>
                                </div>
                            </div>
                        </main>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista de búsqueda para propiedades en CRM -->
    <record id="view_product_template_search_crm" model="ir.ui.view">
        <field name="name">product.template.search.crm</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <search string="Buscar Propiedades">
                <field name="name" string="Propiedad"/>
                <field name="default_code" string="Código"/>
                <field name="neighborhood" string="Barrio"/>
                <field name="city_id" string="Ciudad"/>

                <filter string="En Venta" name="for_sale" domain="[('type_service', '=', 'sale')]"/>
                <filter string="En Arriendo" name="for_rent" domain="[('type_service', '=', 'rent')]"/>
                <separator/>
                <filter string="Disponibles" name="available" domain="[('property_status', '=', 'available')]"/>

                <group expand="0" string="Agrupar Por">
                    <filter string="Tipo" name="group_by_type" context="{'group_by': 'property_type_id'}"/>
                    <filter string="Ciudad" name="group_by_city" context="{'group_by': 'city_id'}"/>
                    <filter string="Barrio" name="group_by_neighborhood" context="{'group_by': 'neighborhood'}"/>
                </group>
            </search>
        </field>
    </record>
</odoo>