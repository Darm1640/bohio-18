<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template para vista de mapa de propiedades -->
    <template id="property_map_view" name="Properties Map View">
        <t t-call="website.layout">
            <div id="wrap" class="bohio-properties-map">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Sidebar con filtros y lista de propiedades -->
                        <div class="col-lg-4 col-md-5 p-0">
                            <div class="properties-sidebar h-100">
                                <!-- Filtros -->
                                <div class="filters-section p-3 bg-light border-bottom">
                                    <h5>Filtros de Búsqueda</h5>
                                    <form id="property-filters" class="mt-3">
                                        <div class="mb-3">
                                            <label>Tipo de Servicio</label>
                                            <select name="type_service" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                                <option value="sale">Venta</option>
                                                <option value="rent">Arriendo</option>
                                                <option value="sale_rent">Venta y Arriendo</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label>Tipo de Inmueble</label>
                                            <select name="property_type" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                                <option value="apartment">Apartamento</option>
                                                <option value="house">Casa</option>
                                                <option value="office">Oficina</option>
                                                <option value="commercial">Comercial</option>
                                                <option value="lot">Lote</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label>Rango de Precio</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <input type="number" name="price_min" class="form-control form-control-sm" placeholder="Mínimo"/>
                                                </div>
                                                <div class="col-6">
                                                    <input type="number" name="price_max" class="form-control form-control-sm" placeholder="Máximo"/>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label>Habitaciones</label>
                                            <select name="bedrooms" class="form-select form-select-sm">
                                                <option value="">Cualquiera</option>
                                                <option value="1">1+</option>
                                                <option value="2">2+</option>
                                                <option value="3">3+</option>
                                                <option value="4">4+</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label>Baños</label>
                                            <select name="bathrooms" class="form-select form-select-sm">
                                                <option value="">Cualquiera</option>
                                                <option value="1">1+</option>
                                                <option value="2">2+</option>
                                                <option value="3">3+</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label>Área (m²)</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <input type="number" name="area_min" class="form-control form-control-sm" placeholder="Mín m²"/>
                                                </div>
                                                <div class="col-6">
                                                    <input type="number" name="area_max" class="form-control form-control-sm" placeholder="Máx m²"/>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fa fa-search"/> Buscar
                                        </button>
                                    </form>
                                </div>

                                <!-- Lista de propiedades -->
                                <div class="properties-list overflow-auto" style="height: calc(100vh - 400px);">
                                    <div id="property-list-container">
                                        <!-- Se cargarán las propiedades dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mapa de Google -->
                        <div class="col-lg-8 col-md-7 p-0">
                            <div id="property-map" style="height: 100vh; width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Modal para comparar propiedades -->
                <div class="compare-bar position-fixed bottom-0 start-0 w-100 bg-dark text-white p-3"
                     id="compare-bar" style="display: none; z-index: 1000;">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <span>Has seleccionado <span id="compare-count">0</span> propiedades para comparar</span>
                                <div id="compare-properties" class="d-inline-block ms-3"></div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-warning" onclick="compareProperties()">
                                    <i class="fa fa-balance-scale"/> Comparar
                                </button>
                                <button class="btn btn-secondary" onclick="clearComparison()">
                                    <i class="fa fa-times"/> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scripts para Google Maps y funcionalidad -->
            <script>
                var map;
                var markers = [];
                var compareList = [];
                var properties = [];

                function initMap() {
                    // Inicializar mapa centrado en Bogotá
                    map = new google.maps.Map(document.getElementById('property-map'), {
                        center: {lat: 4.7110, lng: -74.0721},
                        zoom: 12,
                        mapTypeControl: true,
                        streetViewControl: true,
                        fullscreenControl: true
                    });

                    // Cargar propiedades
                    loadProperties();
                }

                function loadProperties() {
                    // Hacer llamada AJAX para cargar propiedades
                    $.ajax({
                        url: '/api/properties/map',
                        method: 'GET',
                        data: $('#property-filters').serialize(),
                        success: function(data) {
                            properties = data.properties;
                            displayProperties(properties);
                            addMarkers(properties);
                        }
                    });
                }

                function displayProperties(properties) {
                    var html = '';
                    properties.forEach(function(property) {
                        html += `
                            <div class="property-card p-3 border-bottom" data-property-id="${property.id}">
                                <div class="row">
                                    <div class="col-4">
                                        <img src="${property.image}" class="img-fluid rounded" alt="${property.name}"/>
                                    </div>
                                    <div class="col-8">
                                        <h6>${property.name}</h6>
                                        <p class="mb-1 text-muted small">${property.address}</p>
                                        <p class="mb-1"><strong>${property.price}</strong></p>
                                        <p class="mb-1 small">
                                            <i class="fa fa-bed"></i> ${property.bedrooms} |
                                            <i class="fa fa-bath"></i> ${property.bathrooms} |
                                            <i class="fa fa-home"></i> ${property.area} m²
                                        </p>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewProperty(${property.id})">
                                                Ver Detalles
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="addToCompare(${property.id})">
                                                Comparar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    $('#property-list-container').html(html);
                }

                function addMarkers(properties) {
                    // Limpiar marcadores existentes
                    markers.forEach(function(marker) { marker.setMap(null); });
                    markers = [];

                    // Añadir nuevos marcadores
                    properties.forEach(function(property) {
                        if (property.latitude &amp;&amp; property.longitude) {
                            var marker = new google.maps.Marker({
                                position: {lat: property.latitude, lng: property.longitude},
                                map: map,
                                title: property.name,
                                icon: {
                                    url: property.type_service === 'sale' ?
                                         '/bohio_real_estate/static/src/img/marker-sale.png' :
                                         '/bohio_real_estate/static/src/img/marker-rent.png',
                                    scaledSize: new google.maps.Size(40, 40)
                                }
                            });

                            // InfoWindow
                            var infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="width: 250px;">
                                        <img src="${property.image}" class="img-fluid mb-2" alt="${property.name}"/>
                                        <h6>${property.name}</h6>
                                        <p class="mb-1">${property.address}</p>
                                        <p class="mb-1"><strong>${property.price}</strong></p>
                                        <a href="/property/${property.id}" class="btn btn-sm btn-primary">Ver Detalles</a>
                                    </div>
                                `
                            });

                            marker.addListener('click', function() {
                                infoWindow.open(map, marker);
                            });

                            markers.push(marker);
                        }
                    });

                    // Ajustar zoom para mostrar todos los marcadores
                    if (markers.length &gt; 0) {
                        var bounds = new google.maps.LatLngBounds();
                        markers.forEach(function(marker) { bounds.extend(marker.getPosition()); });
                        map.fitBounds(bounds);
                    }
                }

                function addToCompare(propertyId) {
                    if (compareList.length &gt;= 4) {
                        alert('Puedes comparar máximo 4 propiedades');
                        return;
                    }

                    if (!compareList.includes(propertyId)) {
                        compareList.push(propertyId);
                        updateCompareBar();
                    }
                }

                function updateCompareBar() {
                    if (compareList.length &gt; 0) {
                        $('#compare-bar').show();
                        $('#compare-count').text(compareList.length);
                    } else {
                        $('#compare-bar').hide();
                    }
                }

                function compareProperties() {
                    if (compareList.length &lt; 2) {
                        alert('Selecciona al menos 2 propiedades para comparar');
                        return;
                    }
                    window.location.href = '/properties/compare?ids=' + compareList.join(',');
                }

                function clearComparison() {
                    compareList = [];
                    updateCompareBar();
                }

                // Filtros en tiempo real
                $('#property-filters').on('submit', function(e) {
                    e.preventDefault();
                    loadProperties();
                });
            </script>

            <!-- Cargar Google Maps API -->
            <script async="async" defer="defer"
                    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&amp;callback=initMap&amp;libraries=places">
            </script>
        </t>
    </template>
</odoo>