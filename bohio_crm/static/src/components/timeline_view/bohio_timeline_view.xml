<?xml version="1.0" encoding="utf-8"?>
<templates>
    <t t-name="bohio_crm.TimelineView">
        <div class="o_bohio_timeline_view h-100 d-flex">

            <!-- LEFT SIDEBAR: OPPORTUNITIES LIST -->
            <div class="o_opportunities_sidebar bg-light border-end" style="width: 300px; flex-shrink: 0; overflow-y: auto;">
                <div class="sticky-top bg-light p-2 border-bottom">
                    <button class="btn btn-primary btn-sm w-100 mb-2" t-on-click="createNewOpportunity">
                        <i class="fa fa-plus"/> Nueva Oportunidad
                    </button>
                    <input type="text" class="form-control form-control-sm mb-2"
                           placeholder="Buscar oportunidades..."
                           t-model="state.searchQuery"
                           t-on-input="filterOpportunities"/>
                    <select class="form-select form-select-sm" t-model="state.filterService" t-on-change="filterOpportunities">
                        <option value="">Todos los servicios</option>
                        <option value="sale">Venta</option>
                        <option value="rent">Arriendo</option>
                        <option value="projects">Proyectos</option>
                        <option value="consign">Consignar</option>
                    </select>
                </div>
                <div class="opportunities-list p-2">
                    <t t-foreach="state.filteredOpportunities" t-as="opp" t-key="opp.id">
                        <div class="opportunity-item card mb-2 cursor-pointer"
                             t-att-class="{'border-primary': opp.id === state.selectedOpportunityId}"
                             t-on-click="() => this.selectOpportunity(opp.id)">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="o_avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                         style="width: 32px; height: 32px; font-size: 12px;">
                                        <t t-esc="opp.initials"/>
                                    </div>
                                    <div class="flex-fill" style="min-width: 0;">
                                        <div class="small fw-bold text-truncate" t-esc="opp.name"/>
                                        <div class="text-muted" style="font-size: 10px;">
                                            <t t-esc="opp.partner_name"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <span class="badge bg-secondary" style="font-size: 9px;" t-esc="opp.stage_name"/>
                                    <span class="badge bg-info" style="font-size: 9px;">
                                        <t t-esc="opp.probability"/>%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
            </div>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-fill overflow-auto">
                <!-- FIXED ACTION BAR (sticky top) -->
                <div class="o_bohio_action_bar sticky-top bg-white border-bottom shadow-sm p-2">
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Botones de edición/guardado -->
                            <button class="btn btn-success btn-sm" t-on-click="createNewOpportunity">
                                <i class="fa fa-plus"/> Nuevo
                            </button>
                            <button class="btn btn-primary btn-sm" t-if="!state.isEditMode" t-on-click="enableEditMode">
                                <i class="fa fa-edit"/> Editar
                            </button>
                            <button class="btn btn-success btn-sm" t-if="state.isEditMode" t-on-click="saveAllChanges">
                                <i class="fa fa-save"/> Guardar
                            </button>
                            <button class="btn btn-secondary btn-sm" t-if="state.isEditMode" t-on-click="cancelEditMode">
                                <i class="fa fa-times"/> Cancelar
                            </button>

                            <!-- Separador visual -->
                            <div class="vr" t-if="!state.isEditMode"/>

                            <!-- Botones de acción (solo si no está en modo edición) -->
                            <t t-if="!state.isEditMode">
                                <button class="btn btn-primary btn-sm" t-on-click="createActivity">
                                    <i class="fa fa-plus"/> Actividad
                                </button>
                                <button class="btn btn-secondary btn-sm" t-on-click="scheduleCall">
                                    <i class="fa fa-phone"/> Llamada
                                </button>
                                <button class="btn btn-secondary btn-sm" t-on-click="scheduleMeeting">
                                    <i class="fa fa-calendar"/> Cita
                                </button>
                                <button class="btn btn-secondary btn-sm" t-on-click="sendEmail">
                                    <i class="fa fa-envelope"/> Email
                                </button>
                                <button class="btn btn-success btn-sm" t-on-click="sendWhatsApp">
                                    <i class="fab fa-whatsapp"/> WhatsApp
                                </button>
                                <button class="btn btn-info btn-sm" t-on-click="generateQuote">
                                    <i class="fa fa-file-invoice"/> Cotizar
                                </button>
                                <button class="btn btn-success btn-sm" t-on-click="generateContract"
                                        t-if="state.opportunityData.stage_is_won">
                                    <i class="fa fa-file-contract"/> Contrato
                                </button>
                                <button class="btn btn-secondary btn-sm" t-on-click="compareProperties">
                                    <i class="fa fa-chart-bar"/> Comparar
                                </button>
                                <button class="btn btn-secondary btn-sm" t-on-click="printView">
                                    <i class="fa fa-print"/> Imprimir
                                </button>
                            </t>
                        </div>

                        <!-- Indicador de modo edición -->
                        <div t-if="state.isEditMode">
                            <span class="badge bg-warning text-dark">
                                <i class="fa fa-edit"/> MODO EDICIÓN
                            </span>
                        </div>
                    </div>
                </div>

            <!-- MAIN CONTENT -->
            <div class="container-fluid p-3">

                <!-- INFORMACIÓN INICIAL - RESUMEN -->
                <div class="card mb-3 border-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-2">
                                    <i class="fa fa-briefcase"/> <t t-esc="state.opportunityData.name || 'Nueva Oportunidad'"/>
                                </h4>
                                <div class="d-flex gap-3 flex-wrap">
                                    <div>
                                        <i class="fa fa-user"/> <strong>Cliente:</strong>
                                        <t t-esc="state.opportunityData.partner_name || 'Sin asignar'"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-tag"/> <strong>Tipo:</strong>
                                        <t t-esc="state.opportunityData.customer_type || 'No definido'"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-phone"/> <t t-esc="state.opportunityData.phone || 'Sin teléfono'"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-envelope"/> <t t-esc="state.opportunityData.email || 'Sin email'"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <span class="badge bg-light text-dark fs-6">
                                        Probabilidad: <t t-esc="state.opportunityData.probability || 0"/>%
                                    </span>
                                </div>
                                <div class="h5 mb-0">
                                    <i class="fa fa-dollar-sign"/>
                                    <t t-esc="state.opportunityData.expected_revenue_formatted || '$0'"/>
                                </div>
                                <small>Ingreso Esperado</small>
                            </div>
                        </div>

                        <!-- PROGRESO DE INFORMACIÓN -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small>Información Completada</small>
                                <small><t t-esc="completionPercentage"/>%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar"
                                     t-att-style="'width: ' + completionPercentage + '%'"/>
                            </div>
                            <div class="mt-2 d-flex gap-2 flex-wrap">
                                <button class="btn btn-light btn-sm" t-if="!state.opportunityData.partner_id"
                                        t-on-click="() => this.quickAddField('partner')">
                                    <i class="fa fa-plus"/> Cliente
                                </button>
                                <button class="btn btn-light btn-sm" t-if="!state.opportunityData.service_interested"
                                        t-on-click="() => this.quickAddField('service')">
                                    <i class="fa fa-plus"/> Servicio
                                </button>
                                <button class="btn btn-light btn-sm" t-if="!state.opportunityData.budget_min"
                                        t-on-click="() => this.quickAddField('budget')">
                                    <i class="fa fa-plus"/> Presupuesto
                                </button>
                                <button class="btn btn-light btn-sm" t-if="state.comparisonProperties.length === 0"
                                        t-on-click="() => this.quickAddField('properties')">
                                    <i class="fa fa-plus"/> Propiedades
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STAGE PROGRESS BAR -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="o_bohio_stage_progress d-flex justify-content-between position-relative">
                            <t t-foreach="state.opportunityData.stage_history || []" t-as="stage" t-key="stage.id">
                                <div class="o_stage_item text-center flex-fill"
                                     t-att-class="{'o_stage_completed': stage.is_completed, 'o_stage_active': stage.is_current}">
                                    <div class="o_stage_circle rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px;">
                                        <i t-if="stage.is_completed" class="fa fa-check"/>
                                        <i t-elif="stage.is_current" class="fa fa-dot-circle"/>
                                        <i t-else="" t-att-class="'fa fa-' + stage.icon"/>
                                    </div>
                                    <div class="small fw-bold" t-esc="stage.name"/>
                                    <div class="text-muted" style="font-size: 11px;" t-esc="stage.days_label"/>
                                    <div t-if="stage.days_remaining" class="text-danger" style="font-size: 10px;">
                                        Faltan: <t t-esc="stage.days_remaining"/> días
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- METRICS BAR -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3 text-center">
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-primary">
                                    <t t-esc="state.opportunityData.expected_revenue_formatted"/>
                                </div>
                                <div class="text-muted small text-uppercase">Valor Esperado</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-primary">
                                    <t t-esc="state.opportunityData.recurring_revenue_formatted"/>
                                </div>
                                <div class="text-muted small text-uppercase">Recurrente/Mes</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-success">
                                    <t t-esc="totalRevenue"/>
                                </div>
                                <div class="text-muted small text-uppercase">Total Estimado</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-info">
                                    <t t-esc="state.opportunityData.commission_percent"/>%
                                </div>
                                <div class="text-muted small text-uppercase">% Comisión</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-info">
                                    <t t-esc="commissionAmount"/>
                                </div>
                                <div class="text-muted small text-uppercase">Comisión Total</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold">
                                    <t t-esc="state.opportunityData.probability"/>%
                                </div>
                                <div class="text-muted small text-uppercase">Probabilidad</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold">
                                    <t t-esc="state.opportunityData.days_in_pipeline"/>
                                </div>
                                <div class="text-muted small text-uppercase">Días Pipeline</div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="h3 mb-1 fw-bold text-warning">
                                    <t t-esc="state.opportunityData.ai_score"/>%
                                </div>
                                <div class="text-muted small text-uppercase">Score IA</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLIENT SECTION - EDITABLE -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="o_avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                 style="width: 45px; height: 45px; font-size: 18px; font-weight: bold;">
                                <t t-esc="state.opportunityData.partner_initials"/>
                            </div>
                            <div>
                                <div class="fw-bold">
                                    <t t-if="!state.isEditMode &amp;&amp; !state.editing.partner_name">
                                        <span t-on-dblclick="() => this.enableFieldEdit('partner_name')"
                                              style="cursor: pointer;"
                                              title="Doble clic para editar"
                                              t-esc="state.opportunityData.partner_name || 'Sin nombre'"/>
                                    </t>
                                    <input t-else="" type="text" class="form-control form-control-sm d-inline-block"
                                           style="width: 200px;"
                                           t-model="state.opportunityData.partner_name"
                                           placeholder="Nombre del cliente"/>
                                </div>
                                <div class="text-muted small">
                                    <t t-esc="state.opportunityData.customer_type"/>
                                    <span t-if="state.opportunityData.referral_partner">
                                        | Referido por: <t t-esc="state.opportunityData.referral_partner"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-light" t-on-click="toggleClientFields">
                            <i t-att-class="state.clientFieldsExpanded ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"/>
                            <t t-if="state.clientFieldsExpanded">Contraer</t>
                            <t t-else="">Expandir</t>
                        </button>
                    </div>
                    <div class="card-body" t-if="state.clientFieldsExpanded">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">Teléfono</label>
                                <div>
                                    <span t-if="!state.isEditMode"
                                          t-on-dblclick="() => this.enableFieldEdit('phone')"
                                          style="cursor: pointer;"
                                          title="Doble clic para editar"
                                          t-esc="state.opportunityData.phone || '-'"/>
                                    <input t-else="" type="text" class="form-control form-control-sm"
                                           t-model="state.opportunityData.phone"
                                           placeholder="Teléfono"/>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">Email</label>
                                <div>
                                    <span t-if="!state.isEditMode"
                                          t-on-dblclick="() => this.enableFieldEdit('email')"
                                          style="cursor: pointer;"
                                          title="Doble clic para editar"
                                          t-esc="state.opportunityData.email || '-'"/>
                                    <input t-else="" type="email" class="form-control form-control-sm"
                                           t-model="state.opportunityData.email"
                                           placeholder="Email"/>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">Identificación</label>
                                <div><t t-esc="state.opportunityData.partner_vat || '-'"/></div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small text-uppercase">Presupuesto Mínimo</label>
                                <div>
                                    <span t-if="!state.isEditMode"
                                          t-on-dblclick="() => this.enableFieldEdit('budget_min', 'clientFieldsExpanded')"
                                          style="cursor: pointer;"
                                          title="Doble clic para editar"
                                          t-esc="state.opportunityData.min_budget_formatted || '$0'"/>
                                    <input t-else="" type="number" class="form-control form-control-sm"
                                           t-model="state.opportunityData.min_budget"
                                           placeholder="Presupuesto mínimo"/>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small text-uppercase">Presupuesto Máximo</label>
                                <div>
                                    <span t-if="!state.isEditMode"
                                          t-on-dblclick="() => this.enableFieldEdit('budget_max', 'clientFieldsExpanded')"
                                          style="cursor: pointer;"
                                          title="Doble clic para editar"
                                          t-esc="state.opportunityData.max_budget_formatted || '$0'"/>
                                    <input t-else="" type="number" class="form-control form-control-sm"
                                           t-model="state.opportunityData.max_budget"
                                           placeholder="Presupuesto máximo"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFORMACIÓN ADICIONAL - EDITABLE -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fa fa-info-circle"/> Información Adicional del Cliente</span>
                        <button class="btn btn-sm btn-light" t-on-click="toggleAdditionalInfo">
                            <i t-att-class="state.additionalInfoExpanded ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"/>
                        </button>
                    </div>
                    <div class="card-body" t-if="state.additionalInfoExpanded">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="text-muted small text-uppercase">Núm. Ocupantes</label>
                                <div class="d-flex align-items-center gap-1">
                                    <t t-if="!state.editing.number_of_occupants" t-esc="state.opportunityData.number_of_occupants || '0'"/>
                                    <input t-else="" type="number" class="form-control form-control-sm"
                                           t-model="state.opportunityData.number_of_occupants"
                                           t-on-blur="() => this.saveField('number_of_occupants')"/>
                                    <button class="btn btn-sm btn-link p-0" t-on-click="() => this.toggleEdit('number_of_occupants')">
                                        <i t-att-class="state.editing.number_of_occupants ? 'fa fa-check text-success' : 'fa fa-edit'"/>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small text-uppercase">Tiene Mascotas</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.has_pets"
                                           t-on-change="() => this.saveField('has_pets')"/>
                                    <label class="form-check-label">
                                        <t t-if="state.opportunityData.has_pets">Sí</t>
                                        <t t-else="">No</t>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3" t-if="state.opportunityData.has_pets">
                                <label class="text-muted small text-uppercase">Tipo Mascota</label>
                                <select class="form-select form-select-sm"
                                        t-model="state.opportunityData.pet_type"
                                        t-on-change="() => this.saveField('pet_type')">
                                    <option value="">Seleccionar</option>
                                    <option value="dog">Perro</option>
                                    <option value="cat">Gato</option>
                                    <option value="both">Perro y Gato</option>
                                    <option value="other">Otra Mascota</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small text-uppercase">Requiere Parqueadero</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_parking"
                                           t-on-change="() => this.saveField('requires_parking')"/>
                                    <label class="form-check-label">
                                        <t t-if="state.opportunityData.requires_parking">Sí</t>
                                        <t t-else="">No</t>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3" t-if="state.opportunityData.requires_parking">
                                <label class="text-muted small text-uppercase">Espacios Parqueadero</label>
                                <input type="number" class="form-control form-control-sm"
                                       t-model="state.opportunityData.parking_spots"
                                       t-on-blur="() => this.saveField('parking_spots')"/>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small text-uppercase">Ocupación</label>
                                <div class="d-flex align-items-center gap-1">
                                    <t t-if="!state.editing.occupation" t-esc="state.opportunityData.occupation || '-'"/>
                                    <input t-else="" type="text" class="form-control form-control-sm"
                                           t-model="state.opportunityData.occupation"
                                           t-on-blur="() => this.saveField('occupation')"/>
                                    <button class="btn btn-sm btn-link p-0" t-on-click="() => this.toggleEdit('occupation')">
                                        <i t-att-class="state.editing.occupation ? 'fa fa-check text-success' : 'fa fa-edit'"/>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small text-uppercase">Ingresos Mensuales</label>
                                <div class="d-flex align-items-center gap-1">
                                    <t t-if="!state.editing.monthly_income" t-esc="state.opportunityData.monthly_income_formatted || '$0'"/>
                                    <input t-else="" type="number" class="form-control form-control-sm"
                                           t-model="state.opportunityData.monthly_income"
                                           t-on-blur="() => this.saveField('monthly_income')"/>
                                    <button class="btn btn-sm btn-link p-0" t-on-click="() => this.toggleEdit('monthly_income')">
                                        <i t-att-class="state.editing.monthly_income ? 'fa fa-check text-success' : 'fa fa-edit'"/>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AMENIDADES - EDITABLE -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fa fa-building"/> Amenidades Requeridas</span>
                        <button class="btn btn-sm btn-light" t-on-click="toggleAmenities">
                            <i t-att-class="state.amenitiesExpanded ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"/>
                        </button>
                    </div>
                    <div class="card-body" t-if="state.amenitiesExpanded">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_common_areas"
                                           t-on-change="() => this.saveField('requires_common_areas')"/>
                                    <label class="form-check-label">Zonas Comunes</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_gym"
                                           t-on-change="() => this.saveField('requires_gym')"/>
                                    <label class="form-check-label">Gimnasio</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_pool"
                                           t-on-change="() => this.saveField('requires_pool')"/>
                                    <label class="form-check-label">Piscina</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_security"
                                           t-on-change="() => this.saveField('requires_security')"/>
                                    <label class="form-check-label">Seguridad 24/7</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           t-model="state.opportunityData.requires_elevator"
                                           t-on-change="() => this.saveField('requires_elevator')"/>
                                    <label class="form-check-label">Ascensor</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small text-uppercase">Propósito del Inmueble</label>
                                <select class="form-select form-select-sm"
                                        t-model="state.opportunityData.property_purpose"
                                        t-on-change="() => this.saveField('property_purpose')">
                                    <option value="">Seleccionar</option>
                                    <option value="residence">Vivienda Permanente</option>
                                    <option value="office">Oficina/Comercial</option>
                                    <option value="vacation">Vacacional</option>
                                    <option value="investment">Inversión</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFORMACIÓN CONTRACTUAL - EDITABLE -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fa fa-file-contract"/> Información Contractual</span>
                        <button class="btn btn-sm btn-light" t-on-click="toggleContractInfo">
                            <i t-att-class="state.contractInfoExpanded ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"/>
                        </button>
                    </div>
                    <div class="card-body" t-if="state.contractInfoExpanded">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">Fecha Inicio Estimada</label>
                                <input type="date" class="form-control form-control-sm"
                                       t-model="state.opportunityData.contract_start_date"
                                       t-on-change="() => this.saveField('contract_start_date')"/>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">Duración (meses)</label>
                                <input type="number" class="form-control form-control-sm"
                                       t-model="state.opportunityData.contract_duration_months"
                                       t-on-change="() => this.saveField('contract_duration_months')"/>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small text-uppercase">% Comisión</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control"
                                           t-model="state.opportunityData.commission_percentage"
                                           t-on-change="() => this.saveField('commission_percentage')"
                                           step="0.1"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI RECOMMENDATIONS WIDGET -->
                <div class="card mb-3 border-primary" style="background: #f0f9ff;">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <div class="fw-bold">
                            <i class="fa fa-magic text-primary"/> Propiedades Recomendadas (IA)
                        </div>
                        <button class="btn btn-sm btn-primary" t-on-click="refreshRecommendations">
                            <i class="fa fa-sync"/> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <t t-foreach="state.recommendedProperties" t-as="property" t-key="property.id">
                                <div class="col-md-6 col-lg-3">
                                    <div class="card h-100 hover-shadow" style="cursor: pointer;"
                                         t-on-click="() => this.addToComparison(property.id)">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="badge bg-success">
                                                    <t t-esc="property.match_score"/>% Match
                                                </span>
                                            </div>
                                            <h6 class="card-title" t-esc="property.name"/>
                                            <div class="small text-muted">
                                                <div><t t-esc="property.area"/> m² | <t t-esc="property.price_formatted"/></div>
                                                <div><t t-esc="property.bedrooms"/> hab | <t t-esc="property.bathrooms"/> baños</div>
                                                <div><t t-esc="property.neighborhood"/> | <t t-esc="property.view_type"/></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- MAIN LAYOUT: 3 COLUMNS -->
                <div class="row g-3">

                    <!-- LEFT: COMPARISON PROPERTIES -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-header">
                                <i class="fa fa-home"/> Comparación (<t t-esc="state.comparisonProperties.length"/>)
                            </div>
                            <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
                                <t t-foreach="state.comparisonProperties" t-as="property" t-key="property.id">
                                    <div class="card mb-2 border" t-att-class="{'border-primary': property.is_selected}">
                                        <div class="card-body p-2">
                                            <h6 class="small fw-bold mb-1" t-esc="property.name"/>
                                            <div class="small text-muted" style="font-size: 11px; line-height: 1.4;">
                                                <div><t t-esc="property.area"/> m² | <t t-esc="property.price_formatted"/></div>
                                                <div><t t-esc="property.bedrooms"/> hab | <t t-esc="property.bathrooms"/> baños</div>
                                                <div><t t-esc="property.floor"/> | <t t-esc="property.view_type"/></div>
                                            </div>
                                            <div class="d-flex gap-1 mt-2">
                                                <button class="btn btn-sm btn-light flex-fill"
                                                        t-on-click="() => this.viewProperty(property.id)">
                                                    Ver
                                                </button>
                                                <button class="btn btn-sm btn-light flex-fill"
                                                        t-on-click="() => this.removeFromComparison(property.id)">
                                                    Quitar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- CENTER: CHATTER (nativo de Odoo con scroll propio) -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fa fa-comments"/> Timeline de Actividades
                            </div>
                            <div class="card-body p-0">
                                <!-- Aquí se monta el chatter nativo con scroll propio -->
                                <div class="o_chatter_container" style="height: 600px; overflow-y: auto;">
                                    <div t-ref="chatterContainer" class="o_chatter"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: TASKS/ACTIVITIES -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fa fa-tasks"/> Tareas Pendientes</span>
                                <button class="btn btn-sm btn-primary" t-on-click="createActivity">
                                    <i class="fa fa-plus"/>
                                </button>
                            </div>
                            <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
                                <t t-foreach="state.opportunityData.activities || []" t-as="activity" t-key="activity.id">
                                    <div class="card mb-2 border-start border-3" t-att-class="'border-' + activity.activity_state">
                                        <div class="card-body p-2">
                                            <div class="small fw-bold mb-1" t-esc="activity.summary"/>
                                            <div class="text-muted" style="font-size: 11px;">
                                                <div><i class="fa fa-user"/> <t t-esc="activity.user_name"/></div>
                                                <div><i class="fa fa-calendar"/> <t t-esc="activity.date_deadline"/></div>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            </div>
        </div>
    </t>
</templates>
