<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="bohio_crm.CrmSalespersonDashboard">
        <div class="o_crm_salesperson_dashboard">
            <t t-if="state.loading">
                <div class="text-center p-5">
                    <i class="fa fa-spinner fa-spin fa-3x"/>
                    <p class="mt-3">Cargando dashboard...</p>
                </div>
            </t>
            <t t-else="">
                <div class="container-fluid p-4">
                    <h1 class="mb-4">Dashboard CRM - Vendedor</h1>

                    <!-- KPIs Row -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Oportunidades</h5>
                                    <h2><t t-esc="state.dashboardData.total_opportunities || 0"/></h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Ganadas</h5>
                                    <h2><t t-esc="state.dashboardData.won_opportunities || 0"/></h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Pipeline</h5>
                                    <h2>$<t t-esc="state.dashboardData.pipeline_value || 0"/></h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Tasa de Conversión</h5>
                                    <h2><t t-esc="state.dashboardData.conversion_rate || 0"/>%</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Funnel and Contracts -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-filter"/> Embudo de Ventas</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.funnel_data and state.dashboardData.funnel_data.stages">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Etapa</th>
                                                        <th class="text-end">Cantidad</th>
                                                        <th class="text-end">Valor</th>
                                                        <th class="text-end">Conversión</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="state.dashboardData.funnel_data.stages" t-as="stage" t-key="stage.stage_id">
                                                        <tr>
                                                            <td><t t-esc="stage.stage_name"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-primary"><t t-esc="stage.count"/></span>
                                                            </td>
                                                            <td class="text-end">$<t t-esc="(stage.total_value || 0).toFixed(0)"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-success"><t t-esc="(stage.conversion_rate || 0).toFixed(1)"/>%</span>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay datos de embudo</p>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-file-text-o"/> Contratos por Estado</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.contracts_by_state and state.dashboardData.contracts_by_state.length">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Estado</th>
                                                        <th class="text-end">Cantidad</th>
                                                        <th class="text-end">Valor</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="state.dashboardData.contracts_by_state" t-as="contract" t-key="contract.state">
                                                        <tr>
                                                            <td><t t-esc="contract.state_label || contract.state"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-info"><t t-esc="contract.count"/></span>
                                                            </td>
                                                            <td class="text-end">$<t t-esc="(contract.total_value || 0).toFixed(0)"/></td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay contratos</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Forecast -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-line-chart"/> Proyección Financiera (Comisiones)</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.forecast_data and state.dashboardData.forecast_data.summary">
                                        <div class="row mb-4">
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Mensual</small>
                                                <h4 class="text-success mb-0">$<t t-esc="(state.dashboardData.forecast_data.summary.total_monthly_commission || 0).toFixed(0)"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Anual</small>
                                                <h4 class="text-primary mb-0">$<t t-esc="(state.dashboardData.forecast_data.summary.total_annual_commission || 0).toFixed(0)"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Contratos Activos</small>
                                                <h4 class="text-info mb-0"><t t-esc="state.dashboardData.forecast_data.summary.active_contracts || 0"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Promedio</small>
                                                <h4 class="text-warning mb-0"><t t-esc="(state.dashboardData.forecast_data.summary.avg_commission || 0).toFixed(1)"/>%</h4>
                                            </div>
                                        </div>
                                        <t t-if="state.dashboardData.forecast_data.projected_income">
                                            <h6 class="border-top pt-3">Proyección de Ingresos (próximos 6 meses)</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Mes</th>
                                                            <th class="text-end">Ingreso Proyectado</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="state.dashboardData.forecast_data.projected_income.slice(0, 6)" t-as="month" t-key="month.month">
                                                            <tr>
                                                                <td><t t-esc="month.month_label"/></td>
                                                                <td class="text-end text-success fw-bold">$<t t-esc="(month.value || 0).toFixed(0)"/></td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay datos de proyección</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties and Messages -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-building-o"/> Propiedades Asociadas</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.properties_associated">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Total:</span>
                                                    <span class="badge bg-primary fs-6"><t t-esc="state.dashboardData.properties_associated.total || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Disponibles:</span>
                                                    <span class="badge bg-success fs-6"><t t-esc="state.dashboardData.properties_associated.available || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Alquiladas:</span>
                                                    <span class="badge bg-info fs-6"><t t-esc="state.dashboardData.properties_associated.rented || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Vendidas:</span>
                                                    <span class="badge bg-warning fs-6"><t t-esc="state.dashboardData.properties_associated.sold || 0"/></span>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay propiedades</p>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-comments-o"/> Mensajes Recientes</h5>
                                </div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    <t t-if="state.dashboardData.messages and state.dashboardData.messages.length">
                                        <t t-foreach="state.dashboardData.messages.slice(0, 5)" t-as="message" t-key="message.id">
                                            <div class="mb-3 pb-2 border-bottom">
                                                <small class="text-primary fw-bold"><t t-esc="message.lead_name"/></small>
                                                <p class="mb-0 small text-muted">
                                                    <i class="fa fa-user"/> <strong><t t-esc="message.author"/>:</strong>
                                                    <t t-esc="message.subject || 'Sin asunto'"/>
                                                </p>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay mensajes</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>
