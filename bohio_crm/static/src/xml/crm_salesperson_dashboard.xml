<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="bohio_crm.CrmSalespersonDashboard">
        <div class="o_crm_salesperson_dashboard">
            <t t-if="state.loading">
                <div class="text-center p-5">
                    <i class="fa fa-spinner fa-spin fa-3x"/>
                    <p class="mt-3">Cargando dashboard...</p>
                </div>
            </t>
            <t t-else="">
                <div class="container-fluid p-4">
                    <h1 class="mb-4">Dashboard CRM - Vendedor</h1>

                    <!-- Filters Bar with Horizontal Scroll -->
                    <div class="card mb-4">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center gap-2" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 8px;">
                                <style>
                                    .o_crm_salesperson_dashboard .card-body > div::-webkit-scrollbar {
                                        height: 8px;
                                    }
                                    .o_crm_salesperson_dashboard .card-body > div::-webkit-scrollbar-track {
                                        background: #f1f1f1;
                                        border-radius: 4px;
                                    }
                                    .o_crm_salesperson_dashboard .card-body > div::-webkit-scrollbar-thumb {
                                        background: #888;
                                        border-radius: 4px;
                                    }
                                    .o_crm_salesperson_dashboard .card-body > div::-webkit-scrollbar-thumb:hover {
                                        background: #555;
                                    }
                                </style>
                                <div class="flex-shrink-0 filter-item">
                                    <i class="fa fa-filter text-muted"/> <strong>Filtros:</strong>
                                </div>

                                <!-- Period Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('period', ev.target.value)">
                                        <option value="today">Hoy</option>
                                        <option value="week">Esta Semana</option>
                                        <option value="month" selected="selected">Este Mes</option>
                                        <option value="quarter">Este Trimestre</option>
                                        <option value="year">Este Año</option>
                                        <option value="all">Todo el Tiempo</option>
                                    </select>
                                </div>

                                <!-- Status Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('status', ev.target.value)">
                                        <option value="">Todos los Estados</option>
                                        <option value="available">Disponible</option>
                                        <option value="rented">Alquilada</option>
                                        <option value="sold">Vendida</option>
                                        <option value="booked">Reservada</option>
                                    </select>
                                </div>

                                <!-- Property Type Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('property_type', ev.target.value)">
                                        <option value="">Todos los Tipos</option>
                                        <option value="apartment">Apartamento</option>
                                        <option value="house">Casa</option>
                                        <option value="office">Oficina</option>
                                        <option value="land">Terreno</option>
                                        <option value="warehouse">Bodega</option>
                                    </select>
                                </div>

                                <!-- Price Range Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('price_range', ev.target.value)">
                                        <option value="">Todos los Precios</option>
                                        <option value="0-100000">$0 - $100,000</option>
                                        <option value="100000-300000">$100K - $300K</option>
                                        <option value="300000-500000">$300K - $500K</option>
                                        <option value="500000-1000000">$500K - $1M</option>
                                        <option value="1000000+">$1M+</option>
                                    </select>
                                </div>

                                <!-- Contract Status Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('contract_status', ev.target.value)">
                                        <option value="">Todos los Contratos</option>
                                        <option value="quotation">Cotización</option>
                                        <option value="draft">Pre-Contrato</option>
                                        <option value="pending_signature">Pendiente Firma</option>
                                        <option value="confirmed">Confirmado</option>
                                        <option value="cancel">Cancelado</option>
                                    </select>
                                </div>

                                <!-- Region Filter -->
                                <div class="flex-shrink-0 filter-item">
                                    <select class="form-select form-select-sm" style="min-width: 150px;" t-on-change="(ev) => this.onFilterChange('region', ev.target.value)">
                                        <option value="">Todas las Regiones</option>
                                        <t t-if="state.dashboardData.regions and state.dashboardData.regions.length">
                                            <t t-foreach="state.dashboardData.regions" t-as="region" t-key="region_index">
                                                <option t-att-value="region.id"><t t-esc="region.name"/></option>
                                            </t>
                                        </t>
                                    </select>
                                </div>

                                <!-- Reset Filters Button -->
                                <div class="flex-shrink-0 filter-item ms-auto">
                                    <button class="btn btn-sm btn-outline-secondary" t-on-click="() => this.resetFilters()">
                                        <i class="fa fa-refresh"/> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Row -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white" style="cursor: pointer;" t-on-click="() => this.onViewOpportunities()">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">Oportunidades</h5>
                                            <h2 class="mb-0"><t t-esc="state.dashboardData.total_opportunities || 0"/></h2>
                                        </div>
                                        <i class="fa fa-bullseye fa-3x opacity-50"/>
                                    </div>
                                    <small class="mt-2 d-block"><i class="fa fa-arrow-right"/> Ver todas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white" style="cursor: pointer;" t-on-click="() => this.onViewWonOpportunities()">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">Ganadas</h5>
                                            <h2 class="mb-0"><t t-esc="state.dashboardData.won_opportunities || 0"/></h2>
                                        </div>
                                        <i class="fa fa-trophy fa-3x opacity-50"/>
                                    </div>
                                    <small class="mt-2 d-block"><i class="fa fa-arrow-right"/> Ver ganadas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white" style="cursor: pointer;" t-on-click="() => this.onViewPipeline()">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">Pipeline</h5>
                                            <h2 class="mb-0">$<t t-esc="(state.dashboardData.pipeline_value || 0).toFixed(0)"/></h2>
                                        </div>
                                        <i class="fa fa-line-chart fa-3x opacity-50"/>
                                    </div>
                                    <small class="mt-2 d-block"><i class="fa fa-arrow-right"/> Ver pipeline</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white" style="cursor: pointer;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">Tasa de Conversión</h5>
                                            <h2 class="mb-0"><t t-esc="state.dashboardData.conversion_rate || 0"/>%</h2>
                                        </div>
                                        <i class="fa fa-percent fa-3x opacity-50"/>
                                    </div>
                                    <small class="mt-2 d-block"><i class="fa fa-info-circle"/> Métrica clave</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Funnel and Contracts -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-filter"/> Embudo de Ventas</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.funnel_data and state.dashboardData.funnel_data.stages">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Etapa</th>
                                                        <th class="text-end">Cantidad</th>
                                                        <th class="text-end">Valor</th>
                                                        <th class="text-end">Conversión</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="state.dashboardData.funnel_data.stages" t-as="stage" t-key="stage_index">
                                                        <tr>
                                                            <td><t t-esc="stage.stage_name"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-primary"><t t-esc="stage.count"/></span>
                                                            </td>
                                                            <td class="text-end">$<t t-esc="(stage.total_value || 0).toFixed(0)"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-success"><t t-esc="(stage.conversion_rate || 0).toFixed(1)"/>%</span>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay datos de embudo</p>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fa fa-file-text-o"/> Contratos por Estado</h5>
                                    <button class="btn btn-sm btn-primary" t-on-click="() => this.onViewContracts()">
                                        <i class="fa fa-external-link"/> Ver Todos
                                    </button>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.contracts_by_state and state.dashboardData.contracts_by_state.length">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Estado</th>
                                                        <th class="text-end">Cantidad</th>
                                                        <th class="text-end">Valor</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="state.dashboardData.contracts_by_state" t-as="contract" t-key="contract_index">
                                                        <tr>
                                                            <td><t t-esc="contract.state_label || contract.state"/></td>
                                                            <td class="text-end">
                                                                <span class="badge bg-info"><t t-esc="contract.count"/></span>
                                                            </td>
                                                            <td class="text-end">$<t t-esc="(contract.total_value || 0).toFixed(0)"/></td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay contratos</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Forecast -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-line-chart"/> Proyección Financiera (Comisiones)</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.forecast_data and state.dashboardData.forecast_data.summary">
                                        <div class="row mb-4">
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Mensual</small>
                                                <h4 class="text-success mb-0">$<t t-esc="(state.dashboardData.forecast_data.summary.total_monthly_commission || 0).toFixed(0)"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Anual</small>
                                                <h4 class="text-primary mb-0">$<t t-esc="(state.dashboardData.forecast_data.summary.total_annual_commission || 0).toFixed(0)"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Contratos Activos</small>
                                                <h4 class="text-info mb-0"><t t-esc="state.dashboardData.forecast_data.summary.active_contracts || 0"/></h4>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <small class="text-muted d-block">Comisión Promedio</small>
                                                <h4 class="text-warning mb-0"><t t-esc="(state.dashboardData.forecast_data.summary.avg_commission || 0).toFixed(1)"/>%</h4>
                                            </div>
                                        </div>
                                        <t t-if="state.dashboardData.forecast_data.projected_income">
                                            <h6 class="border-top pt-3">Proyección de Ingresos (próximos 6 meses)</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Mes</th>
                                                            <th class="text-end">Ingreso Proyectado</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="state.dashboardData.forecast_data.projected_income.slice(0, 6)" t-as="month" t-key="month_index">
                                                            <tr>
                                                                <td><t t-esc="month.month_label"/></td>
                                                                <td class="text-end text-success fw-bold">$<t t-esc="(month.value || 0).toFixed(0)"/></td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay datos de proyección</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties and Messages -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fa fa-building-o"/> Propiedades Asociadas</h5>
                                    <button class="btn btn-sm btn-primary" t-on-click="() => this.onViewProperties()">
                                        <i class="fa fa-external-link"/> Ver Todas
                                    </button>
                                </div>
                                <div class="card-body">
                                    <t t-if="state.dashboardData.properties_associated">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Total:</span>
                                                    <span class="badge bg-primary fs-6"><t t-esc="state.dashboardData.properties_associated.total || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Disponibles:</span>
                                                    <span class="badge bg-success fs-6"><t t-esc="state.dashboardData.properties_associated.available || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Alquiladas:</span>
                                                    <span class="badge bg-info fs-6"><t t-esc="state.dashboardData.properties_associated.rented || 0"/></span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Vendidas:</span>
                                                    <span class="badge bg-warning fs-6"><t t-esc="state.dashboardData.properties_associated.sold || 0"/></span>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay propiedades</p>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-comments-o"/> Mensajes Recientes</h5>
                                </div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    <t t-if="state.dashboardData.messages and state.dashboardData.messages.length">
                                        <t t-foreach="state.dashboardData.messages.slice(0, 5)" t-as="message" t-key="message_index">
                                            <div class="mb-3 pb-2 border-bottom">
                                                <small class="text-primary fw-bold"><t t-esc="message.lead_name"/></small>
                                                <p class="mb-0 small text-muted">
                                                    <i class="fa fa-user"/> <strong><t t-esc="message.author"/>:</strong>
                                                    <t t-esc="message.subject || 'Sin asunto'"/>
                                                </p>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay mensajes</p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Properties and Map -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-home"/> 10 Propiedades Más Recientes</h5>
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <t t-if="state.dashboardData.recent_properties and state.dashboardData.recent_properties.length">
                                        <div class="list-group list-group-flush">
                                            <t t-foreach="state.dashboardData.recent_properties" t-as="property" t-key="property_index">
                                                <div class="list-group-item px-0 py-2" style="cursor: pointer;" t-on-click="() => this.onViewProperty(property.id)">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <t t-if="property.image_url">
                                                                <img t-att-src="property.image_url"
                                                                     class="rounded"
                                                                     style="width: 60px; height: 60px; object-fit: cover;"
                                                                     alt="Property"/>
                                                            </t>
                                                            <t t-else="">
                                                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                                                     style="width: 60px; height: 60px;">
                                                                    <i class="fa fa-home fa-2x text-muted"/>
                                                                </div>
                                                            </t>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h6 class="mb-1">
                                                                <t t-esc="property.name"/>
                                                                <t t-if="property.default_code">
                                                                    <small class="text-muted">(<t t-esc="property.default_code"/>)</small>
                                                                </t>
                                                            </h6>
                                                            <p class="mb-1 small text-muted">
                                                                <i class="fa fa-map-marker"/> <t t-esc="property.location || 'Sin ubicación'"/>
                                                            </p>
                                                            <div class="d-flex gap-2">
                                                                <span class="badge bg-primary">$<t t-esc="(property.price || 0).toFixed(0)"/></span>
                                                                <t t-if="property.status === 'available'">
                                                                    <span class="badge bg-success">Disponible</span>
                                                                </t>
                                                                <t t-elif="property.status === 'rented'">
                                                                    <span class="badge bg-info">Alquilada</span>
                                                                </t>
                                                                <t t-elif="property.status === 'sold'">
                                                                    <span class="badge bg-warning">Vendida</span>
                                                                </t>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted text-center py-3">No hay propiedades recientes</p>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fa fa-map-marker"/> Mapa de Propiedades</h5>
                                </div>
                                <div class="card-body p-0">
                                    <t t-if="state.dashboardData.map_data and state.dashboardData.map_data.length">
                                        <div id="properties_map" style="height: 500px; width: 100%;"/>
                                        <script type="text/javascript">
                                            // El mapa se inicializará mediante JavaScript
                                        </script>
                                        <!-- Property markers info -->
                                        <div class="p-3 border-top">
                                            <small class="text-muted">
                                                <i class="fa fa-info-circle"/>
                                                Mostrando <strong><t t-esc="state.dashboardData.map_data.length"/></strong> propiedades en el mapa
                                            </small>
                                            <div class="mt-2">
                                                <span class="badge bg-success me-1">● Disponible</span>
                                                <span class="badge bg-info me-1">● Alquilada</span>
                                                <span class="badge bg-warning me-1">● Vendida</span>
                                                <span class="badge bg-secondary">● Reservada</span>
                                            </div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="p-5 text-center">
                                            <i class="fa fa-map-o fa-3x text-muted mb-3"/>
                                            <p class="text-muted">No hay propiedades con ubicación disponible</p>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>
