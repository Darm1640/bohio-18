<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Inherit CRM Opportunities List View and add js_class -->
        <record id="view_crm_metrics_opportunities_list" model="ir.ui.view">
            <field name="name">crm.lead.metrics.opportunities.list</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_tree_view_oppor"/>
            <field name="priority">5</field>
            <field name="arch" type="xml">
                <xpath expr="//list" position="attributes">
                    <attribute name="js_class">crm_metrics_tree</attribute>
                </xpath>
                <!-- Add custom fields for metrics -->
                <xpath expr="//field[@name='expected_revenue']" position="after">
                    <field name="client_type" string="Client Type" optional="hide"/>
                    <field name="service_interested" string="Service Interest" optional="hide"/>
                    <field name="property_ids" string="Properties" widget="many2many_tags" optional="hide"/>
                    <field name="partner_latitude" string="Latitud" optional="hide" decoration-info="partner_latitude != 0"/>
                    <field name="partner_longitude" string="Longitud" optional="hide" decoration-info="partner_longitude != 0"/>
                </xpath>
            </field>
        </record>

        <!-- Dashboard version for opportunities list -->
        <record id="view_crm_metrics_opportunities_dashboard_list" model="ir.ui.view">
            <field name="name">crm.lead.metrics.opportunities.dashboard.list</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_tree_view_oppor"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <xpath expr="//list" position="attributes">
                    <attribute name="js_class">crm_metrics_dashboard_tree</attribute>
                    <attribute name="create">false</attribute>
                    <attribute name="edit">false</attribute>
                    <attribute name="delete">false</attribute>
                </xpath>
                <!-- Add custom fields for metrics -->
                <xpath expr="//field[@name='expected_revenue']" position="after">
                    <field name="client_type" string="Client Type" optional="show"/>
                    <field name="service_interested" string="Service Interest" optional="show"/>
                    <field name="partner_latitude" string="Latitud" optional="hide" decoration-info="partner_latitude != 0"/>
                    <field name="partner_longitude" string="Longitud" optional="hide" decoration-info="partner_longitude != 0"/>
                </xpath>
            </field>
        </record>

        <!-- Inherit CRM Leads List View and add js_class -->
        <record id="view_crm_metrics_leads_list" model="ir.ui.view">
            <field name="name">crm.lead.metrics.leads.list</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_tree_view_leads"/>
            <field name="priority">5</field>
            <field name="arch" type="xml">
                <xpath expr="//list" position="attributes">
                    <attribute name="js_class">crm_metrics_tree</attribute>
                </xpath>
                <!-- Add custom fields for metrics -->
                <xpath expr="//field[@name='priority']" position="after">
                    <field name="client_type" string="Client Type" optional="hide"/>
                    <field name="service_interested" string="Service Interest" optional="hide"/>
                </xpath>
            </field>
        </record>

        <!-- Inherit CRM Kanban View and add js_class -->
        <record id="view_crm_metrics_kanban" model="ir.ui.view">
            <field name="name">crm.lead.metrics.kanban</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.view_crm_lead_kanban"/>
            <field name="priority">5</field>
            <field name="arch" type="xml">
                <xpath expr="//kanban" position="attributes">
                    <attribute name="js_class">crm_metrics_kanban</attribute>
                </xpath>
                <!-- Add fields needed for metrics -->
                <xpath expr="//field[@name='user_id']" position="before">
                    <field name="client_type"/>
                    <field name="service_interested"/>
                </xpath>
                <!-- Add client type and service info to card -->
                <xpath expr="//field[@name='tag_ids']" position="after">
                    <div t-if="record.client_type.value or record.service_interested.value" class="mt-1">
                        <span t-if="record.client_type.value" class="badge badge-info me-1">
                            <field name="client_type"/>
                        </span>
                        <span t-if="record.service_interested.value" class="badge badge-secondary">
                            <field name="service_interested"/>
                        </span>
                    </div>
                </xpath>
            </field>
        </record>

        <!-- Dashboard version for kanban -->
        <record id="view_crm_metrics_dashboard_kanban" model="ir.ui.view">
            <field name="name">crm.lead.metrics.dashboard.kanban</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.view_crm_lead_kanban"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <xpath expr="//kanban" position="attributes">
                    <attribute name="js_class">crm_metrics_dashboard_kanban</attribute>
                    <attribute name="create">false</attribute>
                    <attribute name="edit">false</attribute>
                    <attribute name="delete">false</attribute>
                </xpath>
                <!-- Add fields needed for metrics -->
                <xpath expr="//field[@name='user_id']" position="before">
                    <field name="client_type"/>
                    <field name="service_interested"/>
                </xpath>
                <!-- Enhanced client type and service info -->
                <xpath expr="//field[@name='tag_ids']" position="after">
                    <div t-if="record.client_type.value or record.service_interested.value" class="mt-2">
                        <div t-if="record.client_type.value" class="mb-1">
                            <small class="text-muted">Client:</small>
                            <span class="badge badge-primary ms-1">
                                <field name="client_type"/>
                            </span>
                        </div>
                        <div t-if="record.service_interested.value">
                            <small class="text-muted">Service:</small>
                            <span class="badge badge-success ms-1">
                                <field name="service_interested"/>
                            </span>
                        </div>
                    </div>
                </xpath>
            </field>
        </record>

        <!-- Actions -->
        <record id="action_crm_metrics_view" model="ir.actions.act_window">
            <field name="name">CRM Metrics</field>
            <field name="res_model">crm.lead</field>
            <field name="view_mode">list,kanban,form,graph,pivot</field>
            <field name="domain">[('type', '=', 'opportunity')]</field>
            <field name="context">{
                'search_default_assigned_to_me': 1,
                'search_default_open': 1,
                'default_type': 'opportunity',
                'default_user_id': uid,
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No opportunities yet!
                </p>
                <p>
                    Track your sales performance and metrics here.
                </p>
            </field>
        </record>

        <!-- Vista Kanban Dashboard Pipeline -->
        <record id="view_crm_pipeline_dashboard_kanban" model="ir.ui.view">
            <field name="name">crm.lead.pipeline.dashboard.kanban</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <kanban default_group_by="stage_id" class="o_kanban_small_column o_kanban_dashboard" quick_create="false">
                    <field name="stage_id"/>
                    <field name="user_id"/>
                    <field name="partner_id"/>
                    <field name="expected_revenue"/>
                    <field name="days_open"/>
                    <field name="probability"/>
                    <field name="client_type"/>
                    <field name="service_interested"/>
                    <field name="company_currency"/>

                    <templates>
                        <t t-name="kanban-header">
                            <div class="o_kanban_header d-flex justify-content-between align-items-center p-3">
                                <div class="o_kanban_header_title">
                                    <div class="o_kanban_header_title_name fw-bold fs-5" t-esc="group.value"/>
                                    <div class="text-muted small">
                                        <t t-esc="group.count"/> oportunidades
                                    </div>
                                </div>
                                <div class="o_kanban_header_pills d-flex flex-column align-items-end">
                                    <span class="badge bg-primary mb-1" title="Suma del Ingreso Esperado">
                                        <i class="fa fa-money"/> $<t t-esc="group.aggregates.expected_revenue or 0"/>
                                    </span>
                                    <span class="badge bg-secondary" title="Promedio de días en el pipeline">
                                        <i class="fa fa-clock-o"/> <t t-esc="group.aggregates.avg_days_in_pipeline or '0'"/>d
                                    </span>
                                </div>
                            </div>
                        </t>
                        <t t-name="card">
                            <div class="oe_kanban_card d-flex flex-column">
                                <div class="oe_kanban_content">
                                    <div class="oe_kanban_details">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <div class="text-muted">
                                            <field name="partner_id"/>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-6" t-if="record.client_type.value">
                                                <span class="badge bg-info text-dark">
                                                    <field name="client_type"/>
                                                </span>
                                            </div>
                                            <div class="col-6" t-if="record.service_interested.value">
                                                <span class="badge bg-success">
                                                    <field name="service_interested"/>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <strong class="text-success">
                                                <field name="expected_revenue" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                                            </strong>
                                        </div>
                                        <div class="mt-1">
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-warning"
                                                     t-attf-style="width: #{record.probability.value}%"
                                                     t-att-aria-valuenow="record.probability.value"
                                                     aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                Probabilidad: <t t-esc="record.probability.value"/>%
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="oe_kanban_footer d-flex justify-content-between align-items-center mt-2">
                                    <div class="oe_kanban_footer_left">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                    <div class="oe_kanban_footer_right">
                                        <field name="user_id" widget="many2one_avatar_user"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Menu Item -->
        <menuitem id="menu_crm_metrics"
                  name="CRM Metrics"
                  parent="crm.crm_menu_sales"
                  action="action_crm_metrics_view"
                  sequence="15"
                  groups="sales_team.group_sale_salesman"/>
    </data>
</odoo>