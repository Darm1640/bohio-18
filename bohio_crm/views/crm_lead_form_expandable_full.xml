<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         VISTA FORM COMPLETA EXPANDIBLE
         - Métricas expandibles arriba
         - Mapa con toggle de ubicación
         - Sidebar comprimible con oportunidades
         - Chatter integrado
         Estilo: Vista completa de análisis de oportunidad
         ======================================== -->

    <record id="view_crm_lead_form_expandable_full" model="ir.ui.view">
        <field name="name">crm.lead.form.expandable.full</field>
        <field name="model">crm.lead</field>
        <field name="priority">10</field>
        <field name="arch" type="xml">
            <form string="Oportunidad - Vista Completa" class="o_bohio_form_expandable">

                <!-- ============ CAMPOS TÉCNICOS ============ -->
                <field name="id" invisible="1"/>
                <field name="type" invisible="1"/>
                <field name="company_currency" invisible="1"/>
                <field name="active" invisible="1"/>

                <!-- Campo Virtual para Toggle de Ubicación en Mapa -->
                <field name="show_map_location" invisible="1"/>

                <!-- ============ HEADER CON ESTADO ============ -->
                <header>
                    <field name="stage_id"
                           widget="statusbar"
                           options="{'clickable': '1', 'fold_field': 'fold'}"/>
                </header>

                <!-- ============ SHEET PRINCIPAL ============ -->
                <sheet>
                    <!-- ============ SECCIÓN 1: MÉTRICAS EXPANDIBLES (ARRIBA) ============ -->
                    <div class="o_bohio_metrics_section mb-3" name="metrics_section">
                        <!-- Header con Botón de Expansión -->
                        <div class="o_bohio_metrics_header d-flex justify-content-between align-items-center p-3 bg-light border rounded">
                            <h5 class="mb-0">
                                <i class="fa fa-chart-line me-2 text-primary"/>
                                <strong>Métricas de la Oportunidad</strong>
                            </h5>
                            <button name="toggle_metrics"
                                    type="button"
                                    class="btn btn-sm btn-outline-primary o_bohio_toggle_metrics"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#bohio_metrics_content">
                                <i class="fa fa-chevron-down me-1"/>
                                <span class="o_toggle_text_expand">Expandir</span>
                                <span class="o_toggle_text_collapse d-none">Comprimir</span>
                            </button>
                        </div>

                        <!-- Contenido de Métricas (Colapsable) -->
                        <div id="bohio_metrics_content" class="collapse mt-3">
                            <div class="row">
                                <!-- Métrica 1: Probabilidad de Cierre -->
                                <div class="col-md-3">
                                    <div class="card border-primary h-100">
                                        <div class="card-body text-center">
                                            <i class="fa fa-percent fa-2x text-primary mb-2"/>
                                            <h6 class="text-muted">Probabilidad</h6>
                                            <h3 class="text-primary mb-0">
                                                <field name="probability" widget="progressbar" nolabel="1"/>
                                            </h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métrica 2: Ingreso Esperado -->
                                <div class="col-md-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body text-center">
                                            <i class="fa fa-dollar-sign fa-2x text-success mb-2"/>
                                            <h6 class="text-muted">Ingreso Esperado</h6>
                                            <h3 class="text-success mb-0">
                                                <field name="expected_revenue" widget="monetary" nolabel="1"/>
                                            </h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métrica 3: Comisión Estimada -->
                                <div class="col-md-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-body text-center">
                                            <i class="fa fa-coins fa-2x text-warning mb-2"/>
                                            <h6 class="text-muted">Comisión Estimada</h6>
                                            <h3 class="text-warning mb-0">
                                                <field name="estimated_commission" widget="monetary" nolabel="1"/>
                                            </h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métrica 4: Días en Etapa Actual -->
                                <div class="col-md-3">
                                    <div class="card border-info h-100">
                                        <div class="card-body text-center">
                                            <i class="fa fa-calendar-alt fa-2x text-info mb-2"/>
                                            <h6 class="text-muted">Días en Etapa</h6>
                                            <h3 class="text-info mb-0">
                                                <field name="day_open" nolabel="1"/>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Fila 2: Métricas Adicionales -->
                            <div class="row mt-3">
                                <!-- Actividades Pendientes -->
                                <div class="col-md-6">
                                    <div class="card border-danger">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fa fa-tasks me-2 text-danger"/>
                                                Actividades
                                            </h6>
                                            <field name="activity_ids" widget="kanban_activity" nolabel="1"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Propiedades de Interés -->
                                <div class="col-md-6">
                                    <div class="card border-secondary">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fa fa-home me-2 text-secondary"/>
                                                Propiedades de Interés
                                            </h6>
                                            <field name="property_ids"
                                                   widget="many2many_tags"
                                                   options="{'color_field': 'color'}"
                                                   nolabel="1"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ TÍTULO Y BADGES ============ -->
                    <div class="oe_title mb-3">
                        <h1>
                            <field name="name" placeholder="Nombre de la Oportunidad..." class="o_text_overflow"/>
                        </h1>
                        <div class="d-flex gap-2 mt-2">
                            <!-- Badge Tipo de Servicio -->
                            <span t-attf-class="badge {{
                                service_interested == 'sale' ? 'text-bg-primary' :
                                service_interested == 'rent' ? 'text-bg-info' :
                                service_interested == 'projects' ? 'text-bg-success' :
                                service_interested == 'consign' ? 'text-bg-warning' :
                                'text-bg-secondary'
                            }}">
                                <field name="service_interested" nolabel="1"/>
                            </span>

                            <!-- Badge Tipo de Cliente -->
                            <field name="client_type" widget="badge" nolabel="1"/>

                            <!-- Badge Prioridad -->
                            <field name="priority" widget="priority" nolabel="1"/>
                        </div>
                    </div>

                    <!-- ============ LAYOUT CON SIDEBAR ============ -->
                    <div class="o_bohio_layout_with_sidebar">
                        <!-- Columna Principal (Izquierda) -->
                        <div class="o_bohio_main_content">

                            <!-- ============ SECCIÓN 2: INFORMACIÓN DEL CLIENTE ============ -->
                            <group name="customer_info" string="Información del Cliente">
                                <group>
                                    <field name="partner_id"
                                           widget="many2one_avatar"
                                           options="{'no_create': False, 'no_open': False}"/>
                                    <field name="email_from" widget="email"/>
                                    <field name="phone" widget="phone"/>
                                </group>
                                <group>
                                    <field name="mobile" widget="phone"/>
                                    <field name="user_id" widget="many2one_avatar_user"/>
                                    <field name="request_source" widget="badge"/>
                                </group>
                            </group>

                            <!-- ============ SECCIÓN 3: MAPA CON UBICACIÓN ============ -->
                            <group name="map_section" string="Ubicación de Propiedades" invisible="not id">
                                <!-- Toggle para Mostrar/Ocultar Ubicación -->
                                <div class="d-flex align-items-center mb-3">
                                    <field name="show_map_location" widget="boolean_toggle" nolabel="1" class="me-2"/>
                                    <span class="o_form_label">
                                        <i class="fa fa-map-marker-alt me-1"/>
                                        Mostrar ubicaciones en mapa
                                    </span>
                                </div>

                                <!-- Widget de Mapa Interactivo con Leaflet -->
                                <field name="property_ids" widget="crm_map_widget" nolabel="1" invisible="not show_map_location"/>

                                <!-- Campos de Búsqueda de Ubicación -->
                                <group name="location_search" string="Ubicación Deseada">
                                    <field name="desired_city" placeholder="Ciudad"/>
                                    <field name="desired_neighborhood" placeholder="Barrio"/>
                                </group>
                            </group>

                            <!-- ============ SECCIÓN 4: DETALLES DE LA OPORTUNIDAD ============ -->
                            <group name="opportunity_details" string="Detalles de la Oportunidad">
                                <group>
                                    <field name="service_interested"/>
                                    <field name="client_type"/>
                                    <field name="desired_property_type_id"/>
                                </group>
                                <group>
                                    <field name="budget_min" widget="monetary"/>
                                    <field name="budget_max" widget="monetary"/>
                                    <field name="date_deadline"/>
                                </group>
                            </group>

                            <!-- ============ SECCIÓN 5: FINANCIAMIENTO ============ -->
                            <group name="financing" string="Financiamiento" invisible="not requires_financing">
                                <group>
                                    <field name="requires_financing" widget="boolean_toggle"/>
                                    <field name="loan_type" invisible="not requires_financing"/>
                                    <field name="loan_amount" widget="monetary" invisible="not requires_financing"/>
                                </group>
                                <group>
                                    <field name="loan_approval_status" widget="badge" invisible="not requires_financing"/>
                                    <field name="loan_bank_id" invisible="loan_type != 'bank_mortgage'"/>
                                </group>
                            </group>

                            <!-- ============ SECCIÓN 6: NOTAS ============ -->
                            <group name="notes" string="Notas y Descripción">
                                <field name="description" nolabel="1" placeholder="Escribe notas adicionales sobre esta oportunidad..."/>
                            </group>

                        </div>

                        <!-- ============ SIDEBAR DERECHO (OPORTUNIDADES RELACIONADAS) ============ -->
                        <div class="o_bohio_sidebar_right">
                            <!-- Header del Sidebar -->
                            <div class="o_bohio_sidebar_header bg-primary text-white p-3 rounded-top">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fa fa-list-ul me-2"/>
                                        Oportunidades Relacionadas
                                    </h6>
                                    <button name="toggle_sidebar"
                                            type="button"
                                            class="btn btn-sm btn-light o_bohio_toggle_sidebar">
                                        <i class="fa fa-chevron-right"/>
                                    </button>
                                </div>
                            </div>

                            <!-- Contenido del Sidebar -->
                            <div class="o_bohio_sidebar_content p-3 border border-top-0 rounded-bottom bg-white">
                                <!-- Filtros -->
                                <div class="mb-3">
                                    <div class="o_form_label small text-muted fw-bold mb-2">
                                        <i class="fa fa-filter me-1"/>
                                        Filtrar por:
                                    </div>
                                    <select class="form-select form-select-sm o_bohio_filter_type">
                                        <option value="same_partner">Mismo Cliente</option>
                                        <option value="same_service">Mismo Servicio</option>
                                        <option value="same_user">Mismo Responsable</option>
                                        <option value="all">Todas</option>
                                    </select>
                                </div>

                                <!-- Lista de Oportunidades (Se carga con JS) -->
                                <div class="o_bohio_opportunities_list">
                                    <!-- Placeholder mientras carga -->
                                    <div class="text-center text-muted py-5">
                                        <i class="fa fa-spinner fa-spin fa-2x mb-2"/>
                                        <p class="small">Cargando oportunidades...</p>
                                    </div>
                                </div>

                                <!-- Paginación -->
                                <div class="o_bohio_sidebar_pagination mt-3 d-flex justify-content-between align-items-center">
                                    <span class="small text-muted">1-4 de 15</span>
                                    <div class="btn-group btn-group-sm">
                                        <button name="prev_page"
                                                type="button"
                                                class="btn btn-outline-secondary">
                                            <i class="fa fa-chevron-left"/>
                                        </button>
                                        <button name="next_page"
                                                type="button"
                                                class="btn btn-outline-secondary">
                                            <i class="fa fa-chevron-right"/>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============ NOTEBOOK CON TABS ============ -->
                    <notebook>
                        <!-- Tab 1: Propiedades -->
                        <page string="Propiedades de Interés" name="properties">
                            <field name="property_ids">
                                <list>
                                    <field name="name"/>
                                    <field name="type_service"/>
                                    <field name="city_id"/>
                                    <field name="region_id"/>
                                    <field name="list_price" string="Precio" widget="monetary"/>
                                    <field name="state"/>
                                </list>
                            </field>
                        </page>

                        <!-- Tab 2: Actividades -->
                        <page string="Actividades" name="activities">
                            <field name="activity_ids" widget="mail_activity"/>
                        </page>

                        <!-- Tab 3: Documentos -->
                        <page string="Documentos" name="documents" invisible="not requires_financing">
                            <field name="loan_document_ids">
                                <list>
                                    <field name="name"/>
                                    <field name="create_date"/>
                                </list>
                            </field>
                        </page>

                        <!-- Tab 4: Historial -->
                        <page string="Historial de Cambios" name="history">
                            <field name="message_ids" widget="mail_thread" options="{'display_log_button': True}"/>
                        </page>
                    </notebook>

                </sheet>

                <!-- ============ CHATTER ============ -->
                <chatter/>

            </form>
        </field>
    </record>

    <!-- ========================================
         ACCIÓN: Abrir Vista Form Expandible
         ======================================== -->
    <record id="action_crm_lead_form_expandable_full" model="ir.actions.act_window">
        <field name="name">Oportunidad - Vista Completa</field>
        <field name="res_model">crm.lead</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_crm_lead_form_expandable_full"/>
        <field name="target">current</field>
        <field name="context">{
            'default_type': 'opportunity',
        }</field>
    </record>

</odoo>
