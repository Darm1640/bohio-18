<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================
         VISTA KANBAN EXPANDIBLE - BOHIO CRM
         Estilo Bank Reconciliation Widget
         - Tarjetas compactas con datos básicos
         - Expandibles para mostrar info completa
         - Condicional según: contrato, campaña marketing
         ======================================== -->

    <record id="view_crm_lead_kanban_bohio_expandable" model="ir.ui.view">
        <field name="name">crm.lead.kanban.bohio.expandable</field>
        <field name="model">crm.lead</field>
        <field name="arch" type="xml">
            <kanban default_group_by="stage_id"
                    class="o_kanban_small_column o_bohio_crm_kanban"
                    sample="1"
                    quick_create="false"
                    js_class="bohio_crm_kanban_sidebar">

                <!-- ============ CAMPOS DISPONIBLES ============ -->
                <field name="id"/>
                <field name="color"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="email_from"/>
                <field name="phone"/>
                <field name="mobile"/>
                <field name="service_interested"/>
                <field name="client_type"/>
                <field name="request_source"/>
                <field name="user_id"/>
                <field name="stage_id"/>
                <field name="priority"/>
                <field name="activity_ids"/>
                <field name="activity_state"/>

                <!-- Campos de Contrato -->
                <field name="contract_template_id"/>
                <field name="reservation_id"/>
                <field name="property_ids"/>

                <!-- Campos de Campaña -->
                <field name="campaign_id"/>
                <field name="source_id"/>
                <field name="medium_id"/>

                <!-- Campos Financieros -->
                <field name="expected_revenue"/>
                <field name="probability"/>
                <field name="date_deadline"/>
                <field name="company_currency"/>

                <!-- ============ TEMPLATES ============ -->
                <templates>
                    <t t-name="card">
                        <aside>
                            <!-- Prioridad -->
                            <field name="priority" widget="priority"/>

                            <!-- Color personalizado -->
                            <field name="color" widget="kanban_color_picker"/>
                        </aside>

                        <main class="o_bohio_kanban_card">
                            <!-- ============ HEADER: DATOS BÁSICOS (SIEMPRE VISIBLE) ============ -->
                            <header class="o_bohio_card_header">
                                <!-- Nombre del Lead/Oportunidad -->
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>

                                <!-- Badges de Clasificación -->
                                <div class="o_bohio_badges mt-1">
                                    <!-- Tipo de Servicio -->
                                    <span t-attf-class="badge text-bg-{{
                                        record.service_interested.raw_value == 'sale' ? 'primary' :
                                        record.service_interested.raw_value == 'rent' ? 'info' :
                                        record.service_interested.raw_value == 'projects' ? 'success' :
                                        record.service_interested.raw_value == 'consign' ? 'warning' :
                                        record.service_interested.raw_value == 'marketing' ? 'danger' :
                                        'secondary'
                                    }} me-1">
                                        <i t-attf-class="fa {{
                                            record.service_interested.raw_value == 'sale' ? 'fa-home' :
                                            record.service_interested.raw_value == 'rent' ? 'fa-key' :
                                            record.service_interested.raw_value == 'projects' ? 'fa-building' :
                                            record.service_interested.raw_value == 'consign' ? 'fa-handshake' :
                                            record.service_interested.raw_value == 'marketing' ? 'fa-bullhorn' :
                                            'fa-briefcase'
                                        }} me-1"/>
                                        <field name="service_interested"/>
                                    </span>

                                    <!-- Tipo de Cliente -->
                                    <span t-if="record.client_type.raw_value"
                                          t-attf-class="badge text-bg-{{
                                            record.client_type.raw_value == 'buyer' ? 'success' :
                                            record.client_type.raw_value == 'seller' ? 'warning' :
                                            record.client_type.raw_value == 'tenant' ? 'info' :
                                            'secondary'
                                          }}">
                                        <field name="client_type"/>
                                    </span>
                                </div>
                            </header>

                            <!-- ============ BODY: INFO BÁSICA DEL CLIENTE ============ -->
                            <div class="o_bohio_card_body mt-2">
                                <!-- Cliente/Contacto -->
                                <div class="o_bohio_contact_info">
                                    <i class="fa fa-user text-muted me-2"/>
                                    <span t-if="record.partner_id.raw_value">
                                        <field name="partner_id"/>
                                    </span>
                                    <span t-else="" class="text-muted fst-italic">
                                        Sin contacto asignado
                                    </span>
                                </div>

                                <!-- Teléfono (Prioridad: mobile > phone) -->
                                <div t-if="record.mobile.raw_value or record.phone.raw_value"
                                     class="o_bohio_phone_info mt-1">
                                    <i class="fa fa-phone text-muted me-2"/>
                                    <a t-if="record.mobile.raw_value"
                                       t-attf-href="tel:{{record.mobile.raw_value}}"
                                       class="text-decoration-none">
                                        <field name="mobile"/>
                                    </a>
                                    <a t-elif="record.phone.raw_value"
                                       t-attf-href="tel:{{record.phone.raw_value}}"
                                       class="text-decoration-none">
                                        <field name="phone"/>
                                    </a>
                                </div>

                                <!-- Email -->
                                <div t-if="record.email_from.raw_value" class="o_bohio_email_info mt-1">
                                    <i class="fa fa-envelope text-muted me-2"/>
                                    <a t-attf-href="mailto:{{record.email_from.raw_value}}"
                                       class="text-decoration-none text-truncate">
                                        <field name="email_from"/>
                                    </a>
                                </div>

                                <!-- Ingreso Esperado -->
                                <div t-if="record.expected_revenue.raw_value" class="o_bohio_revenue_info mt-2">
                                    <i class="fa fa-dollar text-success me-2"/>
                                    <strong class="text-success">
                                        <field name="expected_revenue" widget="monetary"/>
                                    </strong>
                                    <span class="text-muted ms-2">
                                        (<field name="probability"/>% prob.)
                                    </span>
                                </div>
                            </div>

                            <!-- ============ SECCIÓN EXPANDIBLE (CONDICIONAL) ============ -->
                            <!-- Solo se muestra si hay contrato, campaña o propiedades asociadas -->
                            <div t-if="record.contract_template_id.raw_value or
                                      record.campaign_id.raw_value or
                                      record.source_id.raw_value or
                                      record.property_ids.raw_value"
                                 class="o_bohio_expandable_section">

                                <!-- Botón de Expansión -->
                                <a role="button"
                                   class="o_bohio_expand_toggle btn btn-link btn-sm text-decoration-none collapsed"
                                   data-bs-toggle="collapse"
                                   t-attf-data-bs-target="#bohio_details_{{record.id.raw_value}}"
                                   aria-expanded="false">
                                    <i class="fa fa-chevron-down me-1"/>
                                    <span class="when-collapsed">Ver más detalles</span>
                                    <span class="when-expanded">Ocultar detalles</span>
                                </a>

                                <!-- Contenido Expandible -->
                                <div t-attf-id="bohio_details_{{record.id.raw_value}}"
                                     class="collapse o_bohio_expanded_content mt-2">

                                    <!-- ========== INFORMACIÓN DE CONTRATO ========== -->
                                    <div t-if="record.contract_template_id.raw_value"
                                         class="o_bohio_contract_section mb-3 p-2 bg-light rounded">
                                        <h6 class="text-primary mb-2">
                                            <i class="fa fa-file-contract me-1"/>
                                            Información de Contrato
                                        </h6>

                                        <div class="o_bohio_contract_details">
                                            <!-- Template de Contrato -->
                                            <div class="mb-1">
                                                <strong class="text-muted">Template:</strong>
                                                <field name="contract_template_id" class="ms-2"/>
                                            </div>

                                            <!-- Reserva Asociada -->
                                            <div t-if="record.reservation_id.raw_value" class="mb-1">
                                                <strong class="text-muted">Reserva:</strong>
                                                <field name="reservation_id" class="ms-2"/>
                                            </div>

                                            <!-- Propiedades de Interés -->
                                            <div t-if="record.property_ids.raw_value" class="mb-1">
                                                <strong class="text-muted">Propiedades:</strong>
                                                <div class="ms-2 mt-1">
                                                    <field name="property_ids"
                                                           widget="many2many_tags"
                                                           options="{'color_field': 'color'}"/>
                                                </div>
                                            </div>

                                            <!-- Fecha de Cierre Esperada -->
                                            <div t-if="record.date_deadline.raw_value" class="mb-1">
                                                <strong class="text-muted">Cierre esperado:</strong>
                                                <span class="ms-2">
                                                    <i class="fa fa-calendar-alt me-1"/>
                                                    <field name="date_deadline"/>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ========== INFORMACIÓN DE CAMPAÑA DE MARKETING ========== -->
                                    <div t-if="record.campaign_id.raw_value or record.source_id.raw_value or record.medium_id.raw_value"
                                         class="o_bohio_campaign_section mb-3 p-2 bg-light rounded">
                                        <h6 class="text-danger mb-2">
                                            <i class="fa fa-bullhorn me-1"/>
                                            Origen de Campaña de Marketing
                                        </h6>

                                        <div class="o_bohio_campaign_details">
                                            <!-- Campaña -->
                                            <div t-if="record.campaign_id.raw_value" class="mb-1">
                                                <strong class="text-muted">Campaña:</strong>
                                                <span class="badge text-bg-danger ms-2">
                                                    <field name="campaign_id"/>
                                                </span>
                                            </div>

                                            <!-- Fuente -->
                                            <div t-if="record.source_id.raw_value" class="mb-1">
                                                <strong class="text-muted">Fuente:</strong>
                                                <span class="badge text-bg-info ms-2">
                                                    <field name="source_id"/>
                                                </span>
                                            </div>

                                            <!-- Medio -->
                                            <div t-if="record.medium_id.raw_value" class="mb-1">
                                                <strong class="text-muted">Medio:</strong>
                                                <span class="badge text-bg-secondary ms-2">
                                                    <field name="medium_id"/>
                                                </span>
                                            </div>

                                            <!-- Alerta de Seguimiento -->
                                            <div class="alert alert-warning mb-0 mt-2 py-1 px-2 small">
                                                <i class="fa fa-lightbulb me-1"/>
                                                <strong>Acción sugerida:</strong>
                                                Iniciar campaña de seguimiento personalizada
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ========== INFORMACIÓN DE ORIGEN ========== -->
                                    <div t-if="record.request_source.raw_value"
                                         class="o_bohio_source_section">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-map-marker-alt text-muted me-2"/>
                                            <span class="text-muted">Origen:</span>
                                            <field name="request_source"
                                                   widget="badge"
                                                   class="ms-2"/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ============ FOOTER: USUARIO Y ACTIVIDADES ============ -->
                            <footer class="o_bohio_card_footer mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
                                <!-- Usuario Responsable -->
                                <div class="o_bohio_user">
                                    <field name="user_id" widget="many2one_avatar_user"/>
                                </div>

                                <!-- Actividades -->
                                <div class="o_bohio_activity">
                                    <field name="activity_ids" widget="kanban_activity"/>
                                </div>
                            </footer>
                        </main>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ========================================
         ACCIÓN: Kanban View con Vista Expandible
         ======================================== -->
    <record id="action_crm_lead_kanban_bohio_expandable" model="ir.actions.act_window">
        <field name="name">Pipeline CRM - Vista Expandible</field>
        <field name="res_model">crm.lead</field>
        <field name="view_mode">kanban,list,form,graph,pivot,calendar</field>
        <field name="view_id" ref="view_crm_lead_kanban_bohio_expandable"/>
        <field name="domain">[('type', '=', 'opportunity')]</field>
        <field name="context">{
            'default_type': 'opportunity',
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Crea tu primera oportunidad!
            </p>
            <p>
                Usa el botón <strong>Crear Oportunidad Rápida</strong> para capturar leads de forma inteligente.
            </p>
        </field>
    </record>

</odoo>
