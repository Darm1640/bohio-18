<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="theme_bohio_real_estate.property_detail" name="Property Detail">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container mt-4 mb-5">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card shadow-sm mb-4">
                                <t t-if="property.image_1920">
                                    <img class="card-img-top" t-att-src="'/web/image/product.template/%s/image_1920' % property.id"
                                         t-att-alt="property.name" style="max-height: 500px; object-fit: cover;"/>
                                </t>

                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h1 class="h2 mb-2" t-esc="property.name"/>
                                            <p class="text-muted mb-0">
                                                <i class="fa fa-tag"/> Código: <strong t-esc="property.default_code or 'N/A'"/>
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <h3 class="text-primary mb-0">
                                                <span t-field="property.list_price" t-options="{'widget': 'monetary', 'display_currency': property.currency_id}"/>
                                            </h3>
                                            <span t-if="property.type_service" class="badge bg-info mt-2">
                                                <span t-esc="dict(property._fields['type_service'].selection).get(property.type_service)"/>
                                            </span>
                                        </div>
                                    </div>

                                    <hr/>

                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h5><i class="fa fa-map-marker text-primary"/> Ubicación</h5>
                                            <p class="mb-1" t-if="property.address">
                                                <strong>Dirección:</strong> <span t-esc="property.address"/>
                                            </p>
                                            <p class="mb-1" t-if="property.region_id">
                                                <strong>Barrio:</strong> <span t-esc="property.region_id.name"/>
                                            </p>
                                            <p class="mb-1" t-if="property.city">
                                                <strong>Ciudad:</strong> <span t-esc="property.city"/>
                                            </p>
                                            <p class="mb-1" t-if="property.state_id">
                                                <strong>Departamento:</strong> <span t-esc="property.state_id.name"/>
                                            </p>
                                            <p class="mb-1" t-if="property.stratum">
                                                <strong>Estrato:</strong> <span t-esc="dict(property._fields['stratum'].selection).get(property.stratum)"/>
                                            </p>
                                        </div>

                                        <div class="col-md-6">
                                            <h5><i class="fa fa-info-circle text-primary"/> Características</h5>

                                            <!-- Características principales (siempre visibles si existen) -->
                                            <div class="row mb-3">
                                                <div class="col-6 mb-2" t-if="property.property_area">
                                                    <i class="fa fa-arrows-alt text-primary"/>
                                                    <strong t-esc="'%.0f' % property.property_area"/> m²
                                                    <small class="text-muted d-block">Área total</small>
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.num_bedrooms">
                                                    <i class="fa fa-bed text-primary"/>
                                                    <strong t-esc="property.num_bedrooms"/>
                                                    <small class="text-muted">Habitaciones</small>
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.num_bathrooms">
                                                    <i class="fa fa-bath text-primary"/>
                                                    <strong t-esc="property.num_bathrooms"/>
                                                    <small class="text-muted">Baños</small>
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.covered_parking or property.uncovered_parking">
                                                    <i class="fa fa-car text-primary"/>
                                                    <strong t-esc="(property.covered_parking or 0) + (property.uncovered_parking or 0)"/>
                                                    <small class="text-muted">Parqueaderos</small>
                                                </div>
                                            </div>

                                            <!-- Características de edificio/estructura -->
                                            <div class="row mb-2" t-if="property.property_age or property.number_of_levels or property.floor_number">
                                                <div class="col-12">
                                                    <h6 class="text-muted mb-2"><i class="fa fa-building"/> Edificación</h6>
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.property_age">
                                                    <i class="fa fa-calendar"/>
                                                    <strong t-esc="property.property_age"/> años
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.number_of_levels">
                                                    <i class="fa fa-building"/>
                                                    <strong t-esc="property.number_of_levels"/> Niveles
                                                </div>
                                                <div class="col-6 mb-2" t-if="property.floor_number">
                                                    <i class="fa fa-layer-group"/>
                                                    Piso <strong t-esc="property.floor_number"/>
                                                </div>
                                            </div>

                                            <!-- Características adicionales según tipo -->
                                            <t t-if="property.property_type_id">
                                                <!-- Características para Apartamento/Casa (Residencial) -->
                                                <t t-if="property.property_type_id.name in ['Apartamento', 'Casa', 'Apartaestudio']">
                                                    <div class="row" t-if="property.balcony or property.terrace">
                                                        <div class="col-12">
                                                            <h6 class="text-muted mb-2"><i class="fa fa-home"/> Adicionales</h6>
                                                        </div>
                                                        <div class="col-6 mb-2" t-if="property.balcony">
                                                            <i class="fa fa-window-maximize text-success"/> Balcón
                                                        </div>
                                                        <div class="col-6 mb-2" t-if="property.terrace">
                                                            <i class="fa fa-sun text-success"/> Terraza
                                                        </div>
                                                    </div>
                                                </t>

                                                <!-- Características para Local Comercial/Bodega -->
                                                <t t-if="property.property_type_id.name in ['Local Comercial', 'Bodega']">
                                                    <div class="row" t-if="property.front_meters">
                                                        <div class="col-12">
                                                            <h6 class="text-muted mb-2"><i class="fa fa-store"/> Comercial</h6>
                                                        </div>
                                                        <div class="col-6 mb-2" t-if="property.front_meters">
                                                            <i class="fa fa-ruler-horizontal"/>
                                                            <strong t-esc="property.front_meters"/> m frente
                                                        </div>
                                                    </div>
                                                </t>

                                                <!-- Características para Lote/Terreno -->
                                                <t t-if="property.property_type_id.name in ['Lote', 'Terreno']">
                                                    <div class="row" t-if="property.front_meters or property.depth_meters">
                                                        <div class="col-12">
                                                            <h6 class="text-muted mb-2"><i class="fa fa-map"/> Terreno</h6>
                                                        </div>
                                                        <div class="col-6 mb-2" t-if="property.front_meters">
                                                            <i class="fa fa-ruler-horizontal"/>
                                                            <strong t-esc="property.front_meters"/> m frente
                                                        </div>
                                                        <div class="col-6 mb-2" t-if="property.depth_meters">
                                                            <i class="fa fa-ruler-vertical"/>
                                                            <strong t-esc="property.depth_meters"/> m fondo
                                                        </div>
                                                    </div>
                                                </t>
                                            </t>
                                        </div>
                                    </div>

                                    <t t-if="property.description">
                                        <hr/>
                                        <h5><i class="fa fa-file-text text-primary"/> Descripción</h5>
                                        <div class="mb-4" t-field="property.description"/>
                                    </t>

                                    <t t-if="property.note">
                                        <hr/>
                                        <h5><i class="fa fa-sticky-note text-primary"/> Notas Adicionales</h5>
                                        <div class="mb-4" t-field="property.note"/>
                                    </t>

                                    <t t-if="property.latitude and property.longitude">
                                        <hr/>
                                        <h5><i class="fa fa-map text-primary"/> Ubicación en el Mapa</h5>
                                        <div id="property_map" style="height: 400px; width: 100%;" class="mb-4"
                                             t-att-data-lat="property.latitude"
                                             t-att-data-lng="property.longitude"
                                             t-att-data-name="property.name"/>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card shadow-sm sticky-top" style="top: 20px;">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fa fa-envelope"/> Contactar</h5>
                                </div>
                                <div class="card-body">
                                    <form action="/contact/property" t-att-data-property-id="property.id" method="post" class="property-contact-form">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        <input type="hidden" name="property_id" t-att-value="property.id"/>

                                        <div class="mb-3">
                                            <label class="form-label">Nombre Completo *</label>
                                            <input type="text" name="name" class="form-control" required="required"/>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Correo Electrónico *</label>
                                            <input type="email" name="email" class="form-control" required="required"/>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Teléfono</label>
                                            <input type="tel" name="phone" class="form-control"/>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Tipo de Cliente</label>
                                            <select name="client_type" class="form-select">
                                                <option value="buyer">Comprador</option>
                                                <option value="tenant">Arrendatario</option>
                                                <option value="investor">Inversionista</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Mensaje</label>
                                            <textarea name="message" class="form-control" rows="4" placeholder="Estoy interesado en esta propiedad..."></textarea>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fa fa-send"/> Enviar Consulta
                                        </button>
                                    </form>

                                    <hr class="my-4"/>

                                    <div class="d-grid gap-2">
                                        <a href="/properties" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left"/> Volver a Propiedades
                                        </a>
                                        <a t-if="property.latitude and property.longitude"
                                           href="/properties/map" class="btn btn-outline-info">
                                            <i class="fa fa-map"/> Ver en Mapa
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const mapElement = document.getElementById('property_map');
                    if (mapElement) {
                        const lat = parseFloat(mapElement.dataset.lat);
                        const lng = parseFloat(mapElement.dataset.lng);
                        const name = mapElement.dataset.name;

                        if (lat &amp;&amp; lng) {
                            const map = L.map('property_map').setView([lat, lng], 15);

                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '© OpenStreetMap contributors'
                            }).addTo(map);

                            L.marker([lat, lng]).addTo(map)
                                .bindPopup(`&lt;b&gt;${name}&lt;/b&gt;`)
                                .openPopup();
                        }
                    }
                });
            </script>

            <!-- Botón Flotante de WhatsApp -->
            <button class="btn btn-success whatsapp-float-btn shadow-lg"
                    id="whatsappFloatBtn"
                    onclick="openWhatsAppModal()">
                <i class="fa fa-whatsapp fa-2x"></i>
                <span class="whatsapp-float-text">Consultar por WhatsApp</span>
            </button>

            <!-- Modal Formulario WhatsApp -->
            <div class="modal fade" id="whatsappModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fa fa-whatsapp me-2"></i>Consultar por WhatsApp
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="property-info-summary mb-4 p-3 bg-light rounded">
                                <h6 class="fw-bold mb-2">Propiedad de Interés:</h6>
                                <p class="mb-1 small"><strong>Código:</strong> <span t-esc="property.default_code or 'N/A'"/></p>
                                <p class="mb-0 small text-truncate"><strong>Nombre:</strong> <span t-esc="property.name"/></p>
                            </div>

                            <form id="whatsappForm" onsubmit="sendWhatsAppMessage(event)">
                                <input type="hidden" name="property_id" t-att-value="property.id"/>
                                <input type="hidden" name="property_name" t-att-value="property.name"/>
                                <input type="hidden" name="property_code" t-att-value="property.default_code"/>
                                <input type="hidden" name="property_url" t-att-value="request.httprequest.url"/>

                                <div class="mb-3">
                                    <label for="customer_name" class="form-label fw-semibold">
                                        <i class="fa fa-user text-danger me-1"></i>Nombre Completo *
                                    </label>
                                    <input type="text" class="form-control" id="customer_name" name="customer_name"
                                           required="required" placeholder="Tu nombre completo"/>
                                </div>

                                <div class="mb-3">
                                    <label for="customer_phone" class="form-label fw-semibold">
                                        <i class="fa fa-phone text-danger me-1"></i>Teléfono / WhatsApp *
                                    </label>
                                    <input type="tel" class="form-control" id="customer_phone" name="customer_phone"
                                           required="required" placeholder="+57 300 123 4567"/>
                                    <small class="text-muted">Formato: +57 seguido de tu número</small>
                                </div>

                                <div class="mb-3">
                                    <label for="customer_email" class="form-label fw-semibold">
                                        <i class="fa fa-envelope text-danger me-1"></i>Email
                                    </label>
                                    <input type="email" class="form-control" id="customer_email" name="customer_email"
                                           placeholder="tu@email.com"/>
                                </div>

                                <div class="mb-3">
                                    <label for="customer_message" class="form-label fw-semibold">
                                        <i class="fa fa-comment text-danger me-1"></i>Mensaje Adicional
                                    </label>
                                    <textarea class="form-control" id="customer_message" name="customer_message"
                                              rows="3" placeholder="¿Tienes alguna pregunta específica?"></textarea>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="accept_terms" required="required"/>
                                    <label class="form-check-label small" for="accept_terms">
                                        Acepto la <a href="/privacy" target="_blank">Política de Privacidad</a> y
                                        <a href="/terms" target="_blank">Términos de Servicio</a> *
                                    </label>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fa fa-whatsapp me-2"></i>Enviar Mensaje por WhatsApp
                                    </button>
                                </div>
                            </form>

                            <div id="whatsappLoading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Enviando...</span>
                                </div>
                                <p class="mt-2 text-muted">Creando oportunidad...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function openWhatsAppModal() {
                    const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
                    modal.show();
                }

                function showSuccessNotification(title, message) {
                    // Crear contenedor de notificación si no existe
                    let container = document.getElementById('successNotificationContainer');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'successNotificationContainer';
                        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
                        document.body.appendChild(container);
                    }

                    // Crear notificación
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show shadow-lg';
                    notification.style.cssText = 'animation: slideInRight 0.5s ease;';
                    notification.innerHTML = `
                        <div class="d-flex align-items-start">
                            <i class="fa fa-check-circle fa-2x text-success me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">${title}</h5>
                                <p class="mb-0">${message}</p>
                            </div>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                        </div>
                    `;

                    container.appendChild(notification);

                    // Auto-remover después de 6 segundos
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 6000);
                }

                // Agregar animación CSS
                if (!document.getElementById('whatsapp-notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'whatsapp-notification-styles';
                    style.textContent = `
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                function sendWhatsAppMessage(event) {
                    event.preventDefault();

                    const form = event.target;
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData);

                    // Construir mensaje de WhatsApp
                    const whatsappNumber = '573001234567'; // Número de BOHIO
                    const message = `Hola BOHIO!\n\n` +
                                  `Me interesa la propiedad:\n` +
                                  `*${data.property_name}*\n` +
                                  `Código: *${data.property_code}*\n\n` +
                                  `Mi nombre: ${data.customer_name}\n` +
                                  `Teléfono: ${data.customer_phone}\n` +
                                  `${data.customer_email ? 'Email: ' + data.customer_email + '\n' : ''}` +
                                  `${data.customer_message ? '\n' + data.customer_message + '\n' : ''}` +
                                  `\nVer propiedad: ${data.property_url}`;

                    const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

                    // Abrir WhatsApp
                    window.open(whatsappURL, '_blank');

                    // Cerrar modal y resetear formulario
                    bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();
                    form.reset();

                    // Mostrar mensaje de éxito
                    showSuccessNotification(
                        '¡Redirigiendo a WhatsApp!',
                        'Se abrirá WhatsApp con tu mensaje pre-cargado.'
                    );
                }
            </script>
        </t>
    </template>
</odoo>