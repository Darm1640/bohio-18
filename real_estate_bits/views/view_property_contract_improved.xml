<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- VISTA FORM MEJORADA CON CARD ARRIBA -->
        <record id="view_property_contract_form_improved" model="ir.ui.view">
            <field name="name">property.contract.form.improved</field>
            <field name="model">property.contract</field>
            <field name="priority">1</field>
            <field name="arch" type="xml">
                <form string="Contrato de Arrendamiento" class="o_contract_form_improved">
                    <header>
                        <button name="action_calculate" type="object" string="Calcular Líneas"
                                class="btn-info"
                                invisible="state in ('cancel','confirmed','renew')"/>
                        <button name="action_confirm" type="object" string="Confirmar Contrato"
                                class="btn-success oe_highlight"
                                invisible="state in ('cancel','confirmed','renew')"/>
                        <button name="%(real_estate_bits.action_modify_contract_wizard)d" type="action"
                                string="Modificar Contrato"
                                class="btn-primary"
                                invisible="state not in ('confirmed', 'draft')"/>
                        <field name="state" widget="statusbar" options="{'clickable': '1'}"
                               statusbar_visible="draft,confirmed,cancel"/>
                    </header>

                    <sheet class="o_contract_sheet_improved">
                        <!-- Smart Buttons -->
                        <div class="oe_button_box" name="button_box">
                            <button name="view_vouchers" type="object" class="oe_stat_button" icon="fa-money">
                                <field string="Pagos" name="voucher_count" widget="statinfo"/>
                            </button>
                            <button name="view_entries" type="object" class="oe_stat_button" icon="fa-book">
                                <field string="Asientos" name="entry_count" widget="statinfo"/>
                            </button>
                            <button name="action_add_property_line" type="object"
                                    class="oe_stat_button" icon="fa-plus-square"
                                    invisible="not is_multi_property">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Agregar Propiedad</span>
                                </div>
                            </button>
                        </div>

                        <!-- TÍTULO CON NÚMERO DE CONTRATO -->
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="state != 'draft'" placeholder="Nuevo Contrato"/>
                            </h1>
                        </div>

                        <!-- ============================================
                             CARD DE PRESENTACIÓN: CLIENTE Y PROPIEDAD
                             ============================================ -->
                        <div class="o_contract_presentation_card">
                            <div class="row">
                                <!-- CLIENTE (INQUILINO) -->
                                <div class="col-lg-6">
                                    <div class="o_card_section o_client_card">
                                        <div class="card-header">
                                            <h3><i class="fa fa-user-circle text-primary"/> INQUILINO</h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="o_field_large">
                                                <label for="partner_id" class="o_form_label fw-bold">Nombre:</label>
                                                <field name="partner_id" required="True"
                                                       readonly="state != 'draft'"
                                                       options="{'no_create': True}"
                                                       placeholder="Seleccionar inquilino..."/>
                                            </div>
                                            <div class="o_row mt-2">
                                                <div class="o_field_medium">
                                                    <label for="user_id" class="o_form_label">Asesor:</label>
                                                    <field name="user_id" readonly="state != 'draft'"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PROPIEDAD(ES) -->
                                <div class="col-lg-6">
                                    <div class="o_card_section o_property_card">
                                        <div class="card-header">
                                            <h3><i class="fa fa-building text-success"/> PROPIEDAD(ES)</h3>
                                            <field name="is_multi_property" readonly="state != 'draft'"
                                                   widget="boolean_toggle" string="Multi-Propiedad"/>
                                        </div>
                                        <div class="card-body">
                                            <!-- PROPIEDAD ÚNICA -->
                                            <div invisible="is_multi_property">
                                                <div class="o_field_large">
                                                    <label for="property_id" class="o_form_label fw-bold">Propiedad:</label>
                                                    <field name="property_id"
                                                           options="{'no_create': True, 'no_open': True}"
                                                           readonly="state != 'draft'"
                                                           required="not is_multi_property"
                                                           placeholder="Seleccionar propiedad..."/>
                                                </div>
                                                <div class="o_row mt-2">
                                                    <div class="col-6">
                                                        <label class="o_form_label">Código:</label>
                                                        <field name="property_code" readonly="1"/>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="o_form_label">Área:</label>
                                                        <field name="property_area" readonly="1"/> m²
                                                    </div>
                                                </div>
                                                <div class="mt-2">
                                                    <label class="o_form_label">Dirección:</label>
                                                    <field name="address" readonly="1"/>
                                                </div>
                                                <div class="mt-2">
                                                    <label class="o_form_label">Propietario:</label>
                                                    <field name="partner_is_owner_id" readonly="1"/>
                                                </div>
                                            </div>

                                            <!-- MULTI-PROPIEDAD -->
                                            <div invisible="not is_multi_property">
                                                <div class="alert alert-info">
                                                    <strong><field name="active_properties_count"/> propiedades activas</strong>
                                                    <span invisible="terminated_properties_count == 0">
                                                        (<field name="terminated_properties_count"/> terminadas)
                                                    </span>
                                                </div>
                                                <button name="action_add_property_line" type="object"
                                                        string="+ Agregar Propiedad"
                                                        class="btn btn-sm btn-primary"
                                                        invisible="state != 'draft'"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             RESUMEN FINANCIERO DESTACADO
                             ============================================ -->
                        <div class="o_financial_summary_bar">
                            <div class="row">
                                <div class="col-lg-3">
                                    <div class="o_summary_metric metric-primary">
                                        <label>Canon Mensual</label>
                                        <div class="metric-value">
                                            <field name="rental_fee" widget="monetary" readonly="state != 'draft'"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="o_summary_metric metric-success">
                                        <label>Total Contrato</label>
                                        <div class="metric-value">
                                            <field name="amount_total" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="o_summary_metric metric-info">
                                        <label>Pagado</label>
                                        <div class="metric-value">
                                            <field name="paid" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="o_summary_metric metric-warning">
                                        <label>Saldo</label>
                                        <div class="metric-value">
                                            <field name="balance" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CAMPOS OCULTOS -->
                        <field name="company_id" invisible="1"/>
                        <field name="is_multi_propietario" invisible="1"/>
                        <field name="active_properties_count" invisible="1"/>
                        <field name="terminated_properties_count" invisible="1"/>

                        <!-- ============================================
                             FECHAS Y CONFIGURACIÓN
                             ============================================ -->
                        <group string="📅 Fechas del Contrato">
                            <group>
                                <field name="date_from" required="True" readonly="state != 'draft'"/>
                                <field name="date_to" readonly="state != 'draft'"/>
                                <field name="first_invoice_date" readonly="state != 'draft'"/>
                            </group>
                            <group>
                                <field name="billing_date" readonly="state != 'draft'"/>
                                <label for="recurring_interval"/>
                                <div class="o_row">
                                    <field name="recurring_interval" required="1" readonly="state != 'draft'"/>
                                    <span>meses</span>
                                </div>
                                <field name="periodicity" required="1" readonly="state != 'draft'"/>
                            </group>
                        </group>

                        <!-- ============================================
                             CONFIGURACIÓN DE VALORES
                             ============================================ -->
                        <group string="💰 Configuración de Valores">
                            <group>
                                <field name="region_id" readonly="state != 'draft'"/>
                                <field name="project_id" readonly="state != 'draft'"/>
                                <field name="contract_scenery_id" required="True" readonly="state != 'draft'"/>
                                <field name="rental_agreement" required="1" readonly="state != 'draft'"/>
                            </group>
                            <group>
                                <field name="deposit" readonly="state != 'draft'"/>
                                <field name="insurance_fee" readonly="state != 'draft'"/>
                                <field name="maintenance" readonly="state != 'draft'"/>
                                <field name="commission_percentage" readonly="state != 'draft'"/>
                                <field name="total_commission" readonly="1"/>
                            </group>
                        </group>

                        <!-- ============================================
                             NOTEBOOK
                             ============================================ -->
                        <notebook>
                            <!-- LÍNEAS DE PROPIEDADES (Multi-Propiedad) -->
                            <page string="🏘️ Propiedades del Contrato" name="property_lines"
                                  invisible="not is_multi_property">
                                <field name="contract_line_ids" nolabel="1">
                                    <list editable="bottom" delete="state == 'draft'">
                                        <field name="sequence" widget="handle"/>
                                        <field name="property_id"
                                               domain="[('is_property', '=', True)]"
                                               options="{'no_create': True}"/>
                                        <field name="property_code" readonly="1"/>
                                        <field name="project_id" readonly="1" optional="show"/>
                                        <field name="date_from" required="1"/>
                                        <field name="date_to" required="1"/>
                                        <field name="rental_fee" widget="monetary" required="1"/>
                                        <field name="rental_fee_percentage" readonly="1" string="% Total"/>
                                        <field name="state" widget="badge"
                                               decoration-info="state == 'draft'"
                                               decoration-success="state == 'active'"
                                               decoration-muted="state == 'terminated'"
                                               decoration-danger="state == 'cancelled'"/>
                                        <button name="action_terminate_line" type="object"
                                                icon="fa-stop-circle"
                                                string="Terminar"
                                                invisible="state != 'active'"/>
                                    </list>
                                </field>
                            </page>

                            <!-- LÍNEAS DE PAGO -->
                            <page string="💳 Líneas de Pago" name="payment_lines">
                                <div class="o_lines_control_panel">
                                    <button name="prepare_lines" string="Recalcular Líneas"
                                            type="object" class="btn-info"
                                            invisible="state != 'draft'"/>
                                    <button name="compute_depreciation_board"
                                            string="Aplicar Configuración"
                                            type="object" class="btn-warning"
                                            invisible="state != 'confirmed'"/>
                                </div>

                                <field name="loan_line_ids" nolabel="1">
                                    <list create="0" delete="0">
                                        <field name="sequence"/>
                                        <field name="date" string="Fecha"/>
                                        <field name="name" string="Descripción"/>
                                        <field name="amount" widget="monetary" string="Monto"/>
                                        <field name="accumulated" widget="monetary" string="Acumulado"/>
                                        <field name="payment_state" widget="badge"
                                               decoration-success="payment_state == 'paid'"
                                               decoration-warning="payment_state == 'partial'"
                                               decoration-danger="payment_state == 'not_paid'"/>
                                        <field name="invoice_id" optional="show"/>
                                        <button name="create_invoice_line" type="object"
                                                string="Facturar" icon="fa-file-text-o"
                                                invisible="payment_state == 'paid'"/>
                                    </list>
                                </field>
                            </page>

                            <!-- PROPIETARIOS -->
                            <page string="🏠 Propietarios" name="owners">
                                <group invisible="is_multi_property">
                                    <field name="partner_is_owner_id" readonly="1"/>
                                    <field name="is_multi_propietario" readonly="1"/>
                                </group>
                                <field name="owners_lines" invisible="not is_multi_propietario or is_multi_property"
                                       nolabel="1">
                                    <list editable="bottom">
                                        <field name="partner_id"/>
                                        <field name="ownership_percentage" string="% Propiedad"/>
                                        <field name="contract_scenery_id"/>
                                    </list>
                                </field>
                                <div invisible="not is_multi_property" class="alert alert-info">
                                    <p><strong>Nota:</strong> En contratos multi-propiedad, cada propiedad tiene su(s) propietario(s) definido(s) en la propiedad misma.</p>
                                </div>
                            </page>

                            <!-- INCREMENTOS -->
                            <page string="📈 Incrementos y Ajustes" name="increments">
                                <group string="Configuración de Incrementos">
                                    <group>
                                        <field name="apply_increment" readonly="state != 'draft'"/>
                                        <field name="increment_percentage"
                                               readonly="state != 'draft' or not apply_increment"
                                               invisible="not apply_increment"/>
                                        <field name="increment_recurring_interval"
                                               readonly="state != 'draft' or not apply_increment"
                                               invisible="not apply_increment"/>
                                    </group>
                                    <group>
                                        <field name="apply_interest" readonly="state != 'draft'"/>
                                        <field name="interest_rate"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"/>
                                        <field name="interest_days_grace"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"/>
                                    </group>
                                </group>
                            </page>

                            <!-- NOTAS DÉBITO -->
                            <page string="⚠️ Notas de Débito" name="debit_notes">
                                <field name="debit_line_ids" nolabel="1">
                                    <list editable="bottom">
                                        <field name="name"/>
                                        <field name="date"/>
                                        <field name="amount" widget="monetary"/>
                                        <field name="state" widget="badge"/>
                                    </list>
                                </field>
                            </page>

                            <!-- CONFIGURACIÓN CONTABLE -->
                            <page string="⚙️ Configuración" name="config">
                                <group>
                                    <group string="Cuentas Contables">
                                        <field name="account_income"/>
                                        <field name="account_security_deposit"/>
                                    </group>
                                    <group string="Otros">
                                        <field name="contract_type" widget="radio" options="{'horizontal': true}"/>
                                        <field name="tax_status" readonly="state != 'draft'"/>
                                        <field name="apply_tax" readonly="state != 'draft'"/>
                                        <field name="prorate_first_period" readonly="state != 'draft'"/>
                                        <field name="prorata_computation_type" readonly="state != 'draft'"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>

                    <!-- CHATTER -->
                    <chatter/>
                </form>
            </field>
        </record>

    </data>
</odoo>