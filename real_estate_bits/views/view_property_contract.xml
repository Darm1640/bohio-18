<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- ACCIONES Y WIZARDS -->
        <record id="action_modify_contract_wizard" model="ir.actions.act_window">
            <field name="name">Modificar Contrato</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">modify.contract.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
        </record>

        <record id="action_renew_contract" model="ir.actions.act_window">
            <field name="name">Renovar Contrato</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">modify.contract.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="context">{'default_modify_action': 'renew'}</field>
        </record>

        <!-- VISTA FORM CON CARD ARRIBA -->
        <record id="view_property_contract_form" model="ir.ui.view">
            <field name="name">property.contract.form</field>
            <field name="model">property.contract</field>
            <field name="priority">1</field>
            <field name="arch" type="xml">
                <form string="Contrato de Arrendamiento" >
                    <header>
                        <button name="action_quotation_to_draft" type="object" string="Convertir a Pre-Contrato"
                                class="btn-primary oe_highlight"
                                invisible="state != 'quotation'"/>
                        <button name="action_back_to_quotation" type="object" string="Regresar a Cotización"
                                class="btn-secondary"
                                invisible="state not in ('draft', 'pending_signature')"/>
                        <button name="action_calculate" type="object" string="Calcular Líneas"
                                class="btn-info"
                                invisible="state in ('cancel','confirmed','renew','quotation')"/>
                        <button name="action_send_for_signature" type="object" string="Enviar para Firma"
                                class="btn-warning"
                                invisible="state != 'draft' or skip_signature"/>
                        <button name="action_mark_signed" type="object" string="Marcar como Firmado"
                                class="btn-success"
                                invisible="state != 'pending_signature' or signature_state != 'pending'"/>
                        <button name="action_reject_signature" type="object" string="Rechazar Firma"
                                class="btn-danger"
                                invisible="state != 'pending_signature'"/>
                        <button name="action_confirm" type="object" string="Confirmar Contrato"
                                class="btn-success oe_highlight"
                                invisible="state in ('cancel','confirmed','renew','quotation')"/>
                        <button name="%(real_estate_bits.action_modify_contract_wizard)d" type="action"
                                string="Modificar Contrato"
                                class="btn-primary"
                                invisible="state not in ('confirmed', 'draft')"/>
                        <field name="state" widget="statusbar" options="{'clickable': '1'}"
                               statusbar_visible="quotation,draft,pending_signature,confirmed,cancel"/>
                    </header>

                    <sheet>
                        <!-- Smart Buttons -->
                        <div class="oe_button_box" name="button_box">
                            <button name="view_vouchers" type="object" class="oe_stat_button" icon="fa-money">
                                <field string="Pagos" name="voucher_count" widget="statinfo"/>
                            </button>
                            <button name="view_entries" type="object" class="oe_stat_button" icon="fa-book">
                                <field string="Asientos" name="entry_count" widget="statinfo"/>
                            </button>
                            <button name="action_add_property_line" type="object"
                                    class="oe_stat_button" icon="fa-plus-square"
                                    invisible="not is_multi_property">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Agregar Propiedad</span>
                                </div>
                            </button>
                        </div>

                        <!-- TÍTULO CON NÚMERO DE CONTRATO -->
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="state != 'draft'" placeholder="Nuevo Contrato"/>
                            </h1>
                        </div>

                        <!-- ============================================
                             CARD DE PRESENTACIÓN: CLIENTE Y PROPIEDAD
                             ============================================ -->
                        <div >
                            <div class="row">
                                <!-- CLIENTE (INQUILINO) -->
                                <div class="col-lg-6">
                                    <div >
                                        <div >
                                            <h3><i class="fa fa-user-circle text-primary"/> INQUILINO</h3>
                                        </div>
                                        <div >
                                            <div class="o_field_large">
                                                <label for="partner_id" class="o_form_label fw-bold">Nombre:</label>
                                                <field name="partner_id" required="True"
                                                       readonly="state != 'draft'"
                                                       options="{'no_create': True}"
                                                       placeholder="Seleccionar inquilino..."/>
                                            </div>
                                            <div class="o_row mt-2">
                                                <div class="o_field_medium">
                                                    <label for="user_id" class="o_form_label">Asesor:</label>
                                                    <field name="user_id" readonly="state != 'draft'"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PROPIEDAD(ES) -->
                                <div class="col-lg-6">
                                    <div >
                                        <div >
                                            <h3><i class="fa fa-building text-success"/> PROPIEDAD(ES)</h3>
                                            <field name="is_multi_property" readonly="state != 'draft'"
                                                   widget="boolean_toggle" string="Multi-Propiedad"/>
                                        </div>
                                        <div >
                                            <!-- PROPIEDAD ÚNICA -->
                                            <div invisible="is_multi_property">
                                                <div class="o_field_large">
                                                    <label for="property_id" class="o_form_label fw-bold">Propiedad:</label>
                                                    <field name="property_id"
                                                           options="{'no_create': True, 'no_open': True}"
                                                           readonly="state != 'draft'"
                                                           required="not is_multi_property"
                                                           placeholder="Seleccionar propiedad..."/>
                                                </div>
                                                <div class="o_row mt-2">
                                                    <div class="col-6">
                                                        <label for="property_code" class="o_form_label">Código:</label>
                                                        <field name="property_code" readonly="1"/>
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="property_area" class="o_form_label">Área:</label>
                                                        <field name="property_area" readonly="1"/> m²
                                                    </div>
                                                </div>
                                                <div class="mt-2">
                                                    <label for="address" class="o_form_label">Dirección:</label>
                                                    <field name="address" readonly="1"/>
                                                </div>
                                                <div class="mt-2">
                                                    <label for="partner_is_owner_id" class="o_form_label">Propietario:</label>
                                                    <field name="partner_is_owner_id" readonly="1"/>
                                                </div>
                                            </div>

                                            <!-- MULTI-PROPIEDAD -->
                                            <div invisible="not is_multi_property">
                                                <div class="alert alert-info">
                                                    <strong><field name="active_properties_count"/> propiedades activas</strong>
                                                    <span invisible="terminated_properties_count == 0">
                                                        (<field name="terminated_properties_count"/> terminadas)
                                                    </span>
                                                </div>
                                                <button name="action_add_property_line" type="object"
                                                        string="+ Agregar Propiedad"
                                                        class="btn btn-sm btn-primary"
                                                        invisible="state != 'draft'"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             RESUMEN FINANCIERO DESTACADO
                             ============================================ -->
                        <div >
                            <div class="row">
                                <div class="col-lg-3">
                                    <div >
                                        <span >Canon Mensual</span>
                                        <div >
                                            <field name="rental_fee" widget="monetary" readonly="state != 'draft'"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div >
                                        <span >Total Contrato</span>
                                        <div >
                                            <field name="amount_total" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div >
                                        <span >Pagado</span>
                                        <div >
                                            <field name="paid" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div >
                                        <span >Saldo</span>
                                        <div >
                                            <field name="balance" widget="monetary" readonly="1"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CAMPOS OCULTOS -->
                        <field name="company_id" invisible="1"/>
                        <field name="is_multi_propietario" invisible="1"/>
                        <field name="active_properties_count" invisible="1"/>
                        <field name="terminated_properties_count" invisible="1"/>

                        <!-- ============================================
                             FECHAS Y CONFIGURACIÓN
                             ============================================ -->
                        <group string="Fechas del Contrato">
                            <group>
                                <field name="date_from" required="True" readonly="state != 'draft'"/>
                                <field name="date_to" readonly="state != 'draft'"/>
                                <field name="first_invoice_date" readonly="state != 'draft'"/>
                            </group>
                            <group>
                                <field name="billing_date" readonly="state != 'draft'"/>
                                <label for="recurring_interval"/>
                                <div class="o_row">
                                    <field name="recurring_interval" required="1" readonly="state != 'draft'"/>
                                    <span>meses</span>
                                </div>
                                <field name="periodicity" required="1" readonly="state != 'draft'"/>
                            </group>
                        </group>

                        <!-- ============================================
                             CONFIGURACIÓN DE VALORES
                             ============================================ -->
                        <group string="Configuración de Valores">
                            <group>
                                <field name="region_id" readonly="state != 'draft'"/>
                                <field name="project_id" readonly="state != 'draft'"/>
                                <field name="rental_agreement" required="1" readonly="state != 'draft'"/>
                                <field name="contract_scenery_id" required="True" readonly="state != 'draft'"/>
                            </group>
                            <group>
                                <field name="deposit" readonly="state != 'draft'"/>
                                <field name="insurance_fee" readonly="state != 'draft'"/>
                                <field name="maintenance" readonly="state != 'draft'"/>
                                <field name="commission_percentage" readonly="state != 'draft'"/>
                                <field name="total_commission" readonly="1"/>
                            </group>
                        </group>

                        <!-- ============================================
                             CONFIGURACIÓN DE FIRMA Y COTIZACIÓN
                             ============================================ -->
                        <group string="Gestión de Firma y Cotización">
                            <group>
                                <field name="skip_signature" readonly="state not in ('draft', 'pending_signature')"/>
                                <field name="signature_state" readonly="1"
                                       decoration-warning="signature_state == 'pending'"
                                       decoration-success="signature_state == 'signed'"
                                       decoration-danger="signature_state == 'rejected'"
                                       decoration-muted="signature_state == 'not_required'"
                                       widget="badge"/>
                            </group>
                            <group>
                                <field name="show_payment_schedule"/>
                            </group>
                        </group>

                        <!-- ============================================
                             NOTEBOOK
                             ============================================ -->
                        <notebook>
                            <!-- LÍNEAS DE PROPIEDADES (Multi-Propiedad) -->
                            <page string="Propiedades del Contrato" name="property_lines"
                                  invisible="not is_multi_property">
                                <field name="contract_line_ids" nolabel="1">
                                    <list editable="bottom" delete="state == 'draft'">
                                        <field name="sequence" widget="handle"/>
                                        <field name="property_id"
                                               domain="[('is_property', '=', True)]"
                                               options="{'no_create': True}"/>
                                        <field name="property_code" readonly="1"/>
                                        <field name="project_id" readonly="1" optional="show"/>
                                        <field name="date_from" required="1"/>
                                        <field name="date_to" required="1"/>
                                        <field name="rental_fee" widget="monetary" required="1"/>
                                        <field name="rental_fee_percentage" readonly="1" string="% Total"/>
                                        <field name="state" widget="badge"
                                               decoration-info="state == 'draft'"
                                               decoration-success="state == 'active'"
                                               decoration-muted="state == 'terminated'"
                                               decoration-danger="state == 'cancelled'"/>
                                        <button name="action_terminate_line" type="object"
                                                icon="fa-stop-circle"
                                                string="Terminar"
                                                invisible="state != 'active'"/>
                                    </list>
                                </field>
                            </page>

                            <!-- LÍNEAS DE PAGO -->
                            <page string="Líneas de Pago" name="payment_lines">
                                <div class="o_lines_control_panel">
                                    <button name="prepare_lines" string="Recalcular Líneas"
                                            type="object" class="btn-info"
                                            invisible="state != 'draft'"/>
                                    <button name="compute_depreciation_board"
                                            string="Aplicar Configuración"
                                            type="object" class="btn-warning"
                                            invisible="state != 'confirmed'"/>
                                </div>

                                <field name="loan_line_ids" nolabel="1">
                                    <list create="0" delete="0">
                                        <field name="date" string="Fecha"/>
                                        <field name="name" string="Descripción"/>
                                        <field name="amount" widget="monetary" string="Monto"/>
                                        <field name="payment_state" widget="badge"
                                               decoration-success="payment_state == 'paid'"
                                               decoration-warning="payment_state == 'partial'"
                                               decoration-danger="payment_state == 'not_paid'"/>
                                        <field name="invoice_id" optional="show"/>
                                        <button name="create_invoice_line" type="object"
                                                string="Facturar" icon="fa-file-text-o"
                                                invisible="invoice_id"/>
                                    </list>
                                </field>
                            </page>

                            <!-- PROPIETARIOS -->
                            <page string="Propietarios" name="owners">
                                <group invisible="is_multi_property">
                                    <field name="partner_is_owner_id" readonly="1"/>
                                    <field name="is_multi_propietario" readonly="1"/>
                                </group>
                                <field name="owners_lines" invisible="not is_multi_propietario or is_multi_property"
                                       nolabel="1">
                                    <list editable="bottom">
                                        <field name="partner_id"/>
                                        <field name="ownership_percentage" string="% Propiedad"/>
                                        <field name="contract_scenery_id"/>
                                    </list>
                                </field>
                                <div invisible="not is_multi_property" class="alert alert-info">
                                    <p><strong>Nota:</strong> En contratos multi-propiedad, cada propiedad tiene su(s) propietario(s) definido(s) en la propiedad misma.</p>
                                </div>
                            </page>

                            <!-- INCREMENTOS -->
                            <page string="Incrementos y Ajustes" name="increments">
                                <group string="Configuración de Incrementos">
                                    <group>
                                        <field name="increment_percentage" readonly="state != 'draft'"/>
                                        <field name="increment_period" readonly="state != 'draft'"/>
                                        <field name="increment_recurring_interval" readonly="state != 'draft'"/>
                                    </group>
                                    <group string="Intereses por Mora">
                                        <field name="apply_interest" readonly="state != 'draft'"/>
                                        <field name="interest_rate"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"/>
                                        <field name="interest_method"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"/>
                                        <field name="interest_days_grace"
                                               readonly="state != 'draft' or not apply_interest"
                                               invisible="not apply_interest"/>
                                    </group>
                                </group>
                            </page>

                            <!-- NOTAS DÉBITO -->
                            <page string="Notas de Débito" name="debit_notes">
                                <field name="debit_line_ids" nolabel="1">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="value_amount" string="% a Aplicar"/>
                                        <field name="nb_days" string="Días después"/>
                                    </list>
                                </field>
                            </page>

                            <!-- CONFIGURACIÓN CONTABLE -->
                            <page string="Configuración" name="config">
                                <group>
                                    <group string="Cuentas Contables">
                                        <field name="account_income"/>
                                        <field name="account_security_deposit"/>
                                    </group>
                                    <group string="Otros">
                                        <field name="contract_type" widget="radio" options="{'horizontal': true}"/>
                                        <field name="tax_status" readonly="state != 'draft'"/>
                                        <field name="apply_tax" readonly="state != 'draft'"/>
                                        <field name="prorate_first_period" readonly="state != 'draft'"/>
                                        <field name="prorata_computation_type" readonly="state != 'draft'"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>

                    <!-- CHATTER -->
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- VISTA SEARCH -->
        <record id="view_property_contract_search" model="ir.ui.view">
            <field name="name">property.contract.search</field>
            <field name="model">property.contract</field>
            <field name="arch" type="xml">
                <search string="Buscar Contratos">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="user_id"/>
                    <field name="project_id"/>
                    <field name="property_id"/>
                    <field name="property_code"/>

                    <filter name="confirmed" string="Confirmados" domain="[('state', '=', 'confirmed')]"/>
                    <filter name="draft" string="Borradores" domain="[('state', '=', 'draft')]"/>
                    <filter name="expiring_soon" string="Por Vencer" domain="[('date_to', '&gt;=', context_today().strftime('%Y-%m-%d')), ('state', '=', 'confirmed')]"/>
                    <filter name="multi_property" string="Multi-Propiedad" domain="[('is_multi_property', '=', True)]"/>

                    <separator/>
                    <filter name="my_contracts" string="Mis Contratos" domain="[('user_id', '=', uid)]"/>

                    <group expand="0" string="Agrupar Por">
                        <filter name="group_user" string="Responsable" context="{'group_by': 'user_id'}"/>
                        <filter name="group_partner" string="Inquilino" context="{'group_by': 'partner_id'}"/>
                        <filter name="group_project" string="Proyecto" context="{'group_by': 'project_id'}"/>
                        <filter name="group_state" string="Estado" context="{'group_by': 'state'}"/>
                        <filter name="group_date_from" string="Fecha Inicio" context="{'group_by': 'date_from'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- VISTA LIST -->
        <record id="view_property_contract_tree" model="ir.ui.view">
            <field name="name">property.contract.list</field>
            <field name="model">property.contract</field>
            <field name="arch" type="xml">
                <list string="Contratos de Arrendamiento" multi_edit="1" sample="1">
                    <field name="name" string="Número"/>
                    <field name="date_from" string="Inicio"/>
                    <field name="date_to" string="Fin"/>
                    <field name="partner_id" string="Inquilino"/>
                    <field name="partner_is_owner_id" string="Propietario" optional="hide"/>
                    <field name="user_id" string="Vendedor"/>
                    <field name="project_id" string="Proyecto" optional="show"/>
                    <field name="property_id" string="Propiedad" optional="show"/>
                    <field name="property_code" string="Código" optional="show"/>
                    <field name="rental_fee" string="Canon" widget="monetary" optional="show"/>
                    <field name="amount_total" string="Total" widget="monetary" optional="show"/>
                    <field name="paid" string="Pagado" widget="monetary" optional="show"/>
                    <field name="balance" string="Saldo" widget="monetary" optional="show"/>
                    <field name="next_payment_date" string="Próx. Pago" optional="show"/>
                    <field name="state" string="Estado" widget="badge"
                           decoration-info="state == 'draft'"
                           decoration-success="state in ('confirmed','renew')"
                           decoration-danger="state == 'cancel'"/>
                </list>
            </field>
        </record>

        <!-- VISTA KANBAN -->
        <record id="view_property_contract_kanban" model="ir.ui.view">
            <field name="name">property.contract.kanban</field>
            <field name="model">property.contract</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_contract_kanban" sample="1" quick_create="false">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="property_id"/>
                    <field name="date_from"/>
                    <field name="date_to"/>
                    <field name="rental_fee"/>
                    <field name="state"/>
                    <field name="color"/>

                    <templates>
                        <t t-name="card">
                            <div class="oe_kanban_global_click o_contract_kanban_card"
                                 t-attf-style="border-left-color: #{kanban_color(record.color.raw_value)}">
                                <div class="o_kanban_record_top">
                                    <strong class="o_kanban_record_title"><field name="name"/></strong>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div><i class="fa fa-user"/> <field name="partner_id"/></div>
                                    <div><i class="fa fa-building"/> <field name="property_id"/></div>
                                    <div><i class="fa fa-calendar"/> <field name="date_from"/> - <field name="date_to"/></div>
                                    <div><i class="fa fa-money"/> <field name="rental_fee" widget="monetary"/></div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- VISTA GANTT -->
        <record id="view_property_contract_gantt" model="ir.ui.view">
            <field name="name">property.contract.gantt</field>
            <field name="model">property.contract</field>
            <field name="arch" type="xml">
                <gantt string="Contratos - Línea de Tiempo"
                       date_start="date_from"
                       date_stop="date_to"
                       color="state"
                       default_group_by="user_id"
                       sample="1">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="property_id"/>
                    <field name="rental_fee"/>
                    <field name="state"/>
                </gantt>
            </field>
        </record>

        <!-- ACTION WINDOW -->
        <record id="action_property_contract_act_window" model="ir.actions.act_window">
            <field name="name">Contratos de Propiedad</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">property.contract</field>
            <field name="view_mode">list,kanban,form,gantt</field>
            <field name="search_view_id" ref="view_property_contract_search"/>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Crear un nuevo contrato de propiedad
                </p>
                <p>
                    Los contratos permiten gestionar arrendamientos con inquilinos,
                    propiedades, pagos y toda la información relacionada.
                </p>
            </field>
        </record>

    </data>
</odoo>