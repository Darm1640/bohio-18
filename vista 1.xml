<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- =================== PÁGINA PRINCIPAL DE BÚSQUEDA =================== -->
    
    <template id="property_search_page" name="Búsqueda de Propiedades">
        <t t-call="website.layout">
            <div id="wrap" class="js_property_search">
                
                <!-- Barra de búsqueda principal -->
                <section class="bg-light py-4">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <h2 class="mb-4">
                                    <i class="fa fa-search"></i> Buscar Propiedades
                                </h2>
                                
                                <!-- Formulario de búsqueda -->
                                <form action="/property/search" method="get" class="property-search-form">
                                    <div class="row g-3">
                                        
                                        <!-- Campo de búsqueda con autocompletado -->
                                        <div class="col-lg-4 col-md-6">
                                            <label class="form-label">Ubicación</label>
                                            <div class="position-relative">
                                                <input 
                                                    type="text" 
                                                    name="search" 
                                                    class="form-control form-control-lg location-autocomplete" 
                                                    placeholder="Ciudad, Departamento o Barrio..."
                                                    t-att-value="search_term"
                                                    autocomplete="off"
                                                />
                                                <i class="fa fa-map-marker position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
                                                
                                                <!-- Dropdown de autocompletado -->
                                                <div class="autocomplete-dropdown position-absolute w-100 shadow-sm bg-white border rounded mt-1 d-none" style="z-index: 1000; max-height: 300px; overflow-y: auto;">
                                                    <!-- Se llena dinámicamente con JavaScript -->
                                                </div>
                                            </div>
                                            
                                            <!-- Campos ocultos para IDs -->
                                            <input type="hidden" name="city_id" t-att-value="city_id"/>
                                            <input type="hidden" name="state_id" t-att-value="state_id"/>
                                            <input type="hidden" name="region_id" t-att-value="region_id"/>
                                        </div>
                                        
                                        <!-- Tipo de propiedad -->
                                        <div class="col-lg-3 col-md-6">
                                            <label class="form-label">Tipo de Propiedad</label>
                                            <select name="property_type" class="form-select form-select-lg property-type-filter">
                                                <option value="">Todos los tipos</option>
                                                <t t-foreach="property_types" t-as="ptype">
                                                    <option 
                                                        t-att-value="ptype['value']"
                                                        t-att-selected="'selected' if ptype['value'] == property_type else None">
                                                        <t t-esc="ptype['label']"/> (<t t-esc="ptype['count']"/>)
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        
                                        <!-- Tipo de servicio -->
                                        <div class="col-lg-2 col-md-6">
                                            <label class="form-label">Operación</label>
                                            <select name="type_service" class="form-select form-select-lg">
                                                <option value="">Cualquiera</option>
                                                <t t-foreach="service_types" t-as="stype">
                                                    <option 
                                                        t-att-value="stype['value']"
                                                        t-att-selected="'selected' if stype['value'] == type_service else None">
                                                        <t t-esc="stype['label']"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        
                                        <!-- Botón de búsqueda -->
                                        <div class="col-lg-3 col-md-6 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                                <i class="fa fa-search"></i> Buscar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtros avanzados (colapsable) -->
                                    <div class="mt-3">
                                        <a class="btn btn-link" data-bs-toggle="collapse" href="#advancedFilters">
                                            <i class="fa fa-sliders"></i> Filtros Avanzados
                                        </a>
                                        
                                        <div class="collapse" id="advancedFilters">
                                            <div class="card card-body mt-2">
                                                <div class="row g-3">
                                                    
                                                    <!-- Rango de precio -->
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Precio Mínimo</label>
                                                        <input 
                                                            type="number" 
                                                            name="min_price" 
                                                            class="form-control" 
                                                            placeholder="$ 0"
                                                            t-att-value="min_price"
                                                        />
                                                    </div>
                                                    
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Precio Máximo</label>
                                                        <input 
                                                            type="number" 
                                                            name="max_price" 
                                                            class="form-control" 
                                                            placeholder="$ Sin límite"
                                                            t-att-value="max_price"
                                                        />
                                                    </div>
                                                    
                                                    <!-- Rango de área -->
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Área Mínima (m²)</label>
                                                        <input 
                                                            type="number" 
                                                            name="min_area" 
                                                            class="form-control" 
                                                            placeholder="0"
                                                            t-att-value="min_area"
                                                        />
                                                    </div>
                                                    
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Área Máxima (m²)</label>
                                                        <input 
                                                            type="number" 
                                                            name="max_area" 
                                                            class="form-control" 
                                                            placeholder="Sin límite"
                                                            t-att-value="max_area"
                                                        />
                                                    </div>
                                                    
                                                    <!-- Habitaciones y baños -->
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Habitaciones (mín)</label>
                                                        <select name="bedrooms" class="form-select">
                                                            <option value="">Cualquiera</option>
                                                            <t t-foreach="bedroom_options" t-as="bed">
                                                                <option 
                                                                    t-att-value="bed"
                                                                    t-att-selected="'selected' if str(bed) == bedrooms else None">
                                                                    <t t-esc="bed"/>+
                                                                </option>
                                                            </t>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="col-lg-3 col-md-6">
                                                        <label class="form-label">Baños (mín)</label>
                                                        <select name="bathrooms" class="form-select">
                                                            <option value="">Cualquiera</option>
                                                            <t t-foreach="bathroom_options" t-as="bath">
                                                                <option 
                                                                    t-att-value="bath"
                                                                    t-att-selected="'selected' if str(bath) == bathrooms else None">
                                                                    <t t-esc="bath"/>+
                                                                </option>
                                                            </t>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Resultados de búsqueda -->
                <section class="py-4">
                    <div class="container">
                        <div class="row">
                            
                            <!-- Sidebar con filtros -->
                            <div class="col-lg-3 col-md-4 mb-4">
                                <div class="card sticky-top" style="top: 20px;">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fa fa-filter"></i> Filtrar Resultados
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        
                                        <!-- Filtro por ciudad -->
                                        <t t-if="cities">
                                            <h6 class="fw-bold mb-3">Por Ciudad</h6>
                                            <div class="mb-4">
                                                <t t-foreach="cities[:10]" t-as="city">
                                                    <div class="form-check">
                                                        <input 
                                                            class="form-check-input filter-checkbox" 
                                                            type="radio" 
                                                            name="filter_city" 
                                                            t-att-id="'city_' + str(city['id'])"
                                                            t-att-value="city['id']"
                                                            t-att-checked="'checked' if str(city['id']) == city_id else None"
                                                        />
                                                        <label class="form-check-label d-flex justify-content-between" t-att-for="'city_' + str(city['id'])">
                                                            <span t-esc="city['name']"/>
                                                            <span class="badge bg-secondary" t-esc="city['count']"/>
                                                        </label>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                        
                                        <!-- Filtro por tipo de propiedad -->
                                        <t t-if="property_types">
                                            <h6 class="fw-bold mb-3">Por Tipo</h6>
                                            <div class="mb-4">
                                                <t t-foreach="property_types" t-as="ptype">
                                                    <div class="form-check">
                                                        <input 
                                                            class="form-check-input filter-checkbox" 
                                                            type="radio" 
                                                            name="filter_type" 
                                                            t-att-id="'type_' + ptype['value']"
                                                            t-att-value="ptype['value']"
                                                            t-att-checked="'checked' if ptype['value'] == property_type else None"
                                                        />
                                                        <label class="form-check-label d-flex justify-content-between" t-att-for="'type_' + ptype['value']">
                                                            <span t-esc="ptype['label']"/>
                                                            <span class="badge bg-secondary" t-esc="ptype['count']"/>
                                                        </label>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                        
                                        <!-- Filtro por rangos de precio -->
                                        <h6 class="fw-bold mb-3">Por Precio</h6>
                                        <div class="mb-4">
                                            <t t-foreach="price_ranges" t-as="prange">
                                                <div class="form-check">
                                                    <input 
                                                        class="form-check-input price-range" 
                                                        type="radio" 
                                                        name="price_range" 
                                                        t-att-id="'price_' + str(prange_index)"
                                                        t-att-data-min="prange['min']"
                                                        t-att-data-max="prange['max']"
                                                    />
                                                    <label class="form-check-label" t-att-for="'price_' + str(prange_index)">
                                                        <t t-esc="prange['label']"/>
                                                    </label>
                                                </div>
                                            </t>
                                        </div>
                                        
                                        <!-- Botón limpiar filtros -->
                                        <a href="/property/search" class="btn btn-outline-secondary btn-sm w-100">
                                            <i class="fa fa-times"></i> Limpiar Filtros
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Área de resultados -->
                            <div class="col-lg-9 col-md-8">
                                
                                <!-- Barra de información y ordenamiento -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="mb-0">
                                            <t t-esc="total_properties"/> 
                                            <span t-if="total_properties == 1">Propiedad Encontrada</span>
                                            <span t-else="">Propiedades Encontradas</span>
                                        </h5>
                                        <t t-if="search_term">
                                            <small class="text-muted">
                                                Búsqueda: "<t t-esc="search_term"/>"
                                            </small>
                                        </t>
                                    </div>
                                    
                                    <div>
                                        <select name="order" class="form-select form-select-sm order-select" style="width: auto;">
                                            <option value="relevance" t-att-selected="'selected' if order == 'relevance' else None">
                                                Más Relevantes
                                            </option>
                                            <option value="price_asc" t-att-selected="'selected' if order == 'price_asc' else None">
                                                Precio: Menor a Mayor
                                            </option>
                                            <option value="price_desc" t-att-selected="'selected' if order == 'price_desc' else None">
                                                Precio: Mayor a Menor
                                            </option>
                                            <option value="area_asc" t-att-selected="'selected' if order == 'area_asc' else None">
                                                Área: Menor a Mayor
                                            </option>
                                            <option value="area_desc" t-att-selected="'selected' if order == 'area_desc' else None">
                                                Área: Mayor a Menor
                                            </option>
                                            <option value="newest" t-att-selected="'selected' if order == 'newest' else None">
                                                Más Recientes
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Grid de propiedades -->
                                <div class="row g-4">
                                    <t t-if="properties">
                                        <t t-foreach="properties" t-as="property">
                                            <div class="col-lg-4 col-md-6">
                                                <t t-call="real_estate_bits.property_card_snippet">
                                                    <t t-set="property" t-value="property"/>
                                                </t>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <div class="col-12">
                                            <div class="alert alert-info text-center py-5">
                                                <i class="fa fa-search fa-3x mb-3"></i>
                                                <h4>No se encontraron propiedades</h4>
                                                <p class="mb-0">Intenta ajustar tus filtros de búsqueda</p>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                                
                                <!-- Paginación -->
                                <t t-if="pager['total_pages'] > 1">
                                    <nav class="mt-5">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item" t-att-class="'disabled' if page == 1 else ''">
                                                <a class="page-link" t-att-href="pager['prev_url']">
                                                    <i class="fa fa-chevron-left"></i> Anterior
                                                </a>
                                            </li>
                                            
                                            <t t-foreach="range(1, pager['total_pages'] + 1)" t-as="pg">
                                                <li class="page-item" t-att-class="'active' if pg == page else ''">
                                                    <a class="page-link" t-att-href="'/property/search?page=' + str(pg)">
                                                        <t t-esc="pg"/>
                                                    </a>
                                                </li>
                                            </t>
                                            
                                            <li class="page-item" t-att-class="'disabled' if page == pager['total_pages'] else ''">
                                                <a class="page-link" t-att-href="pager['next_url']">
                                                    Siguiente <i class="fa fa-chevron-right"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </t>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </t>
    </template>
    
    <!-- =================== SNIPPET DE TARJETA DE PROPIEDAD =================== -->
    
    <template id="property_card_snippet" name="Property Card">
        <div class="card h-100 shadow-sm property-card">
            <t t-if="property.image_1920">
                <img 
                    t-att-src="'/web/image/product.template/%s/image_512' % property.id" 
                    class="card-img-top" 
                    alt="property.name"
                    style="height: 200px; object-fit: cover;"
                />
            </t>
            <t t-else="">
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fa fa-home fa-3x text-muted"></i>
                </div>
            </t>
            
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge bg-primary" t-if="property.property_type_id">
                        <t t-esc="property.property_type_id.name"/>
                    </span>
                    <span class="badge bg-success" t-if="property.state == 'free'">Disponible</span>
                    <span class="badge bg-warning" t-elif="property.state == 'reserved'">Reservada</span>
                    <span class="badge bg-danger" t-elif="property.state == 'sold'">Vendida</span>
                </div>
                
                <h5 class="card-title mb-2">
                    <a t-att-href="'/shop/%s' % property.id" class="text-decoration-none text-dark">
                        <t t-esc="property.name"/>
                    </a>
                </h5>
                
                <p class="text-muted small mb-2">
                    <i class="fa fa-map-marker"></i>
                    <t t-if="property.region_id">
                        <t t-esc="property.region_id.name"/>, 
                    </t>
                    <t t-if="property.city">
                        <t t-esc="property.city"/>
                    </t>
                </p>
                
                <div class="property-features mb-3">
                    <t t-if="property.num_bedrooms">
                        <span class="badge bg-light text-dark me-1">
                            <i class="fa fa-bed"></i> <t t-esc="property.num_bedrooms"/>
                        </span>
                    </t>
                    <t t-if="property.num_bathrooms">
                        <span class="badge bg-light text-dark me-1">
                            <i class="fa fa-bath"></i> <t t-esc="property.num_bathrooms"/>
                        </span>
                    </t>
                    <t t-if="property.property_area">
                        <span class="badge bg-light text-dark me-1">
                            <i class="fa fa-arrows-alt"></i> <t t-esc="'%.0f' % property.property_area"/> m²
                        </span>
                    </t>
                </div>
                
                <h4 class="text-primary mb-3">
                    $ <t t-esc="'{:,.0f}'.format(property.net_price)"/>
                </h4>
                
                <a t-att-href="'/shop/%s' % property.id" class="btn btn-outline-primary w-100">
                    Ver Detalles <i class="fa fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </template>
    
</odoo>